<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>K-Stock Quant Dashboard PRO</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --panel2:#0c1628; --line:rgba(148,163,184,.18);
      --txt:#e5e7eb; --muted:#94a3b8; --good:#34d399; --bad:#fb7185; --warn:#fbbf24;
      --accent:#60a5fa; --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: sans-serif; background: var(--bg); color:var(--txt); overflow:hidden; }
    .app{ display:flex; flex-direction:column; height:100vh; }
    
    /* íƒ­ ë²„íŠ¼ ì‹œì¸ì„± ê·¹ëŒ€í™” */
    .tabbar { margin: 20px; display: flex; gap: 15px; }
    .tab-btn { 
      padding: 16px 40px; border-radius: 14px; border: 2px solid var(--line);
      background: var(--panel); color: #fff; font-size: 18px; font-weight: 900;
      cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    }
    .tab-btn.on { 
      background: linear-gradient(135deg, #3b82f6, #2563eb); border-color: #60a5fa;
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); transform: translateY(-2px);
    }

    .main{ flex:1; display:flex; overflow:hidden; padding: 0 20px 20px 20px; gap:20px; }
    .content-area { flex:1; overflow-y:auto; }
    
    #detailPanel {
      width: 480px; background: var(--panel); border: 1px solid var(--line);
      border-radius: var(--radius); display: none; flex-direction: column;
      box-shadow: -10px 0 40px rgba(0,0,0,0.6); overflow: hidden;
    }

    /* ì‹œê·¸ë„ ë°°ì§€ */
    .badge-sig { padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; margin-right: 5px; display: inline-block; }
    .sig-trend { background: #10b981; color: #fff; }
    .sig-pullback { background: #f59e0b; color: #fff; }
    .sig-breakout { background: #ef4444; color: #fff; }

    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:1000px; }
    tr.clickable:hover { background: rgba(255,255,255,0.07); cursor: pointer; }
    th{ background: rgba(255,255,255,0.05); color: var(--muted); padding: 18px 15px; text-align:left; position: sticky; top:0; z-index:10; }
    td{ padding: 16px 15px; border-bottom: 1px solid var(--line); }
    .numRight{ text-align:right; font-family: 'Roboto Mono', monospace; font-weight: 500; }
  </style>
</head>
<body>
<div class="app">
  <div style="padding: 15px 25px; border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center; background: rgba(15,26,46,0.8);">
    <div style="font-size: 24px; font-weight:950; letter-spacing:-1px; color:#fff;">K-QUANT <span style="color:var(--accent)">INTELLIGENCE</span></div>
    <button style="padding: 10px 22px; border-radius: 10px; background: var(--good); border:none; font-weight:900; cursor:pointer;" id="btnRefresh">ì‹¤ì‹œê°„ ë°ì´í„° ê°±ì‹ </button>
  </div>

  <div class="tabbar">
    <button class="tab-btn on" id="tabScreen">ğŸ” í¬ì°© ì¢…ëª© ë¦¬ìŠ¤íŠ¸</button>
    <button class="tab-btn" id="tabPerf">ğŸ“Š ì„±ê³¼ ì¶”ì  ë³´ë“œ</button>
  </div>
  
  <div class="main">
    <div class="content-area">
      <section id="screenView">
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:25px;">
          <div class="card" onclick="switchList('ALL')"><div style="font-size:13px; color:var(--muted)">ì „ì²´ í¬ì°©</div><div style="font-size:32px; font-weight:950;" id="statAll">-</div></div>
          <div class="card" onclick="switchList('TREND')"><div style="font-size:13px; color:var(--muted)">ì¶”ì„¸</div><div style="font-size:32px; font-weight:950; color:var(--good)" id="statTrend">-</div></div>
          <div class="card" onclick="switchList('PULLBACK')"><div style="font-size:13px; color:var(--muted)">ëˆŒë¦¼</div><div style="font-size:32px; font-weight:950; color:var(--warn)" id="statPullback">-</div></div>
          <div class="card" onclick="switchList('BREAKOUT')"><div style="font-size:13px; color:var(--muted)">ëŒíŒŒ</div><div style="font-size:32px; font-weight:950; color:var(--bad)" id="statBreakout">-</div></div>
        </div>
        <div style="background:var(--panel2); border-radius:var(--radius); border:1px solid var(--line); overflow:hidden;">
          <div class="panelHead" style="background: rgba(255,255,255,0.02);"><h3 id="listTitle" style="margin:0; font-size:18px;">ë¦¬ìŠ¤íŠ¸: ALL</h3><div id="screenCount" style="font-weight:bold;">0 ì¢…ëª©</div></div>
          <div style="overflow-x:auto;">
            <table>
              <thead><tr><th>ì½”ë“œ</th><th>ì¢…ëª©ëª…</th><th class="numRight">í˜„ì¬ê°€</th><th class="numRight">ê±°ë˜ëŒ€ê¸ˆ</th><th class="numRight">RSI14</th><th class="numRight">Stoch K</th><th style="text-align:center;">ì‹œê·¸ë„</th></tr></thead>
              <tbody id="screenTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="perfView" style="display:none;">
        <div style="background:var(--panel2); border-radius:var(--radius); border:1px solid var(--line); overflow:hidden;">
          <div class="panelHead" style="background: rgba(255,255,255,0.02);"><h3 style="margin:0; font-size:18px;">í¬ì°©ê°€ ëŒ€ë¹„ ì„±ê³¼ (D1-D9)</h3></div>
          <div style="overflow-x:auto;">
            <table>
              <thead><tr><th>í¬ì°©ì¼</th><th>ì½”ë“œ</th><th>ì¢…ëª©ëª…</th><th class="numRight">í¬ì°©ê°€</th><th class="numRight">í˜„ì¬ê°€</th><th class="numRight">ìˆ˜ìµë¥ </th><th class="numRight">D1</th><th class="numRight">D3</th><th class="numRight">D5</th><th class="numRight">D7</th><th class="numRight">D9</th></tr></thead>
              <tbody id="perfTbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>

    <div id="detailPanel">
      <div class="panelHead">
        <div><b id="detailName" style="font-size:20px;">-</b> <span id="detailCode" style="color:var(--muted); font-family:monospace;"></span></div>
        <button onclick="closeDetail()" style="background:none; border:none; color:#fff; font-size:24px; cursor:pointer;">âœ•</button>
      </div>
      <div id="chartContainer" style="flex:1;"></div>
    </div>
  </div>
</div>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
const URLS = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv",
  STORAGE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv"
};

let data = { ALL:[], TREND:[], PULLBACK:[], BREAKOUT:[], STORAGE:[] };
let currentMode = 'ALL';

// [ì˜¤ë¥˜ ìˆ˜ì •] ì½¤ë§ˆ í¬í•¨ ìˆ«ìë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•˜ì—¬ í¬ë§·íŒ…
function fmtPrice(n) {
  if (!n) return "-";
  // ë¬¸ìì—´ ë‚´ì˜ ì½¤ë§ˆ, ì›, ê³µë°± ì œê±° í›„ ìˆ«ì ì¶”ì¶œ
  const val = String(n).replace(/[^-0-9.]/g, "");
  const num = parseFloat(val);
  return isNaN(num) ? "-" : num.toLocaleString('ko-KR') + "ì›";
}

function fmtTurnover(n) {
  if (!n) return "-";
  const num = parseFloat(String(n).replace(/[^-0-9.]/g, ""));
  return isNaN(num) ? "-" : Math.floor(num / 100000000).toLocaleString() + "ì–µ";
}

function getBadges(r) {
  let h = "";
  if(String(r.Trend).toUpperCase()==="TRUE") h += '<span class="badge-sig sig-trend">ì¶”ì„¸</span>';
  if(String(r.Pullback).toUpperCase()==="TRUE") h += '<span class="badge-sig sig-pullback">ëˆŒë¦¼</span>';
  if(String(r.Breakout).toUpperCase()==="TRUE") h += '<span class="badge-sig sig-breakout">ëŒíŒŒ</span>';
  return h;
}

// [í•µì‹¬ ìˆ˜ì •] ì½¤ë§ˆê°€ í¬í•¨ëœ CSV í•„ë“œë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•˜ëŠ” ì •ê·œí‘œí˜„ì‹ íŒŒì„œ
function parseCSV(text) {
  const rows = [];
  const lines = text.split(/\r?\n/);
  const regex = /("([^"]|"")*"|[^,"\r\n]+|(?<=,|^)(?=[,\r\n]|$))/g;

  for (let line of lines) {
    if (!line.trim()) continue;
    let row = [];
    let match;
    while ((match = regex.exec(line)) !== null) {
      let val = match[0];
      if (val.startsWith('"') && val.endsWith('"')) {
        val = val.substring(1, val.length - 1).replace(/""/g, '"');
      }
      row.push(val);
    }
    rows.push(row);
  }

  const header = rows.shift().map(h => h.trim());
  return rows.map(r => {
    let obj = {}; 
    header.forEach((h, i) => obj[h] = (r[i] !== undefined) ? r[i].trim() : "");
    return obj;
  });
}

function openDetail(r) {
  document.getElementById('detailPanel').style.display = 'flex';
  document.getElementById('detailName').textContent = r.Name;
  document.getElementById('detailCode').textContent = r.Code;
  new TradingView.widget({
    "autosize": true, "symbol": "KRX:" + String(r.Code).padStart(6, '0'),
    "interval": "D", "timezone": "Asia/Seoul", "theme": "dark", "style": "1",
    "locale": "ko", "container_id": "chartContainer", "hide_top_toolbar": true
  });
}
function closeDetail() { document.getElementById('detailPanel').style.display = 'none'; }

async function load() {
  document.getElementById('statusLine').textContent = "ë°ì´í„° ë™ê¸°í™” ì¤‘...";
  try {
    for(let key in URLS) {
      const res = await fetch(URLS[key] + "&ts=" + Date.now());
      const text = await res.text();
      data[key] = parseCSV(text);
    }
    render();
    document.getElementById('statusLine').textContent = "Last Sync: " + new Date().toLocaleTimeString();
  } catch(e) { console.error(e); }
}

function render() {
  document.getElementById('statAll').textContent = data.ALL.length;
  document.getElementById('statTrend').textContent = data.TREND.length;
  document.getElementById('statPullback').textContent = data.PULLBACK.length;
  document.getElementById('statBreakout').textContent = data.BREAKOUT.length;
  
  const list = data[currentMode];
  document.getElementById('listTitle').textContent = `ì¢…ëª© ë¦¬ìŠ¤íŠ¸: ${currentMode}`;
  document.getElementById('screenCount').textContent = list.length + " ì¢…ëª©";
  
  document.getElementById('screenTbody').innerHTML = list.map(r => `
    <tr class="clickable" onclick='openDetail(${JSON.stringify(r)})'>
      <td style="color:var(--muted)">${String(r.Code).padStart(6,'0')}</td><td><b>${r.Name}</b></td>
      <td class="numRight">${fmtPrice(r.Close)}</td>
      <td class="numRight">${fmtTurnover(r.Turnover)}</td>
      <td class="numRight">${parseFloat(r.RSI14 || 0).toFixed(2)}</td>
      <td class="numRight">${parseFloat(r.Stoch_K || 0).toFixed(2)}</td>
      <td style="text-align:center;">${getBadges(r)}</td>
    </tr>
  `).join('');

  document.getElementById('perfTbody').innerHTML = data.STORAGE.slice().reverse().map(r => {
    const color = (v) => {
      const x = parseFloat(String(v).replace('%',''));
      return isNaN(x) ? 'inherit' : (x >= 0 ? '#34d399' : '#fb7185');
    };
    const pctTxt = (v) => {
      const x = parseFloat(String(v).replace('%',''));
      return isNaN(x) ? "-" : x.toFixed(2) + "%";
    };

    return `
      <tr>
        <td style="color:var(--muted)">${(r.DetectDate || "").split(' ')[0]}</td>
        <td>${String(r.Code).padStart(6,'0')}</td><td><b>${r.Name}</b></td>
        <td class="numRight">${fmtPrice(r.EntryPrice)}</td>
        <td class="numRight">${fmtPrice(r.Close_Today)}</td>
        <td class="numRight" style="color:${color(r.Return)}; font-weight:bold;">${pctTxt(r.Return)}</td>
        <td class="numRight" style="color:${color(r.D1)}">${pctTxt(r.D1)}</td>
        <td class="numRight" style="color:${color(r.D3)}">${pctTxt(r.D3)}</td>
        <td class="numRight" style="color:${color(r.D5)}">${pctTxt(r.D5)}</td>
        <td class="numRight" style="color:${color(r.D7)}">${pctTxt(r.D7)}</td>
        <td class="numRight" style="color:${color(r.D9)}">${pctTxt(r.D9)}</td>
      </tr>
    `;
  }).join('');
}

function switchList(mode) { currentMode = mode; render(); }
document.getElementById('tabScreen').onclick = () => {
  document.getElementById('screenView').style.display = 'block';
  document.getElementById('perfView').style.display = 'none';
  document.getElementById('tabScreen').classList.add('on');
  document.getElementById('tabPerf').classList.remove('on');
};
document.getElementById('tabPerf').onclick = () => {
  document.getElementById('screenView').style.display = 'none';
  document.getElementById('perfView').style.display = 'block';
  document.getElementById('tabPerf').classList.add('on');
  document.getElementById('tabScreen').classList.remove('on');
};
document.getElementById('btnRefresh').onclick = load;
window.onload = load;
</script>
</body>
</html>
