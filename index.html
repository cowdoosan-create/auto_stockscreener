<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <script>
    if (!sessionStorage.getItem("auth")) {
      const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if (input !== "fire") {
        document.body.innerHTML = "<h2 style='padding:20px'>ì ‘ê·¼ ë¶ˆê°€</h2>";
        throw new Error("Unauthorized");
      }
      sessionStorage.setItem("auth", "true");
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>YJ ìŠ¤í¬ë¦¬ë„ˆ (Single-file)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{
      --bg:#0f172a; --panel:#111c33; --panel2:#0b1224;
      --line:#223053; --txt:#e5e7eb; --muted:#94a3b8;
      --green:#22c55e; --yellow:#eab308; --red:#ef4444; --blue:#60a5fa;
      --radius:14px; --tap: 44px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      overflow: hidden; /* âœ… ì•±ì²˜ëŸ¼: ì „ì²´ëŠ” mainì´ ìŠ¤í¬ë¡¤ ë‹´ë‹¹ */
      overscroll-behavior: none;
    }

    /* ===== App Layout ===== */
    .app{
      height: 100dvh;
      display:flex;
      flex-direction: column;
      min-height:0;
    }
    header{
      padding-top: env(safe-area-inset-top);
      background:var(--panel);
      border-bottom:1px solid var(--line);
      position: sticky;
      top:0;
      z-index:70;
    }
    .headInner{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 14px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:28px; height:28px; border-radius:10px;
      background:linear-gradient(135deg, #60a5fa, #22c55e);
      box-shadow:0 10px 30px rgba(59,130,246,.15);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sub{ color:var(--muted); font-size:12px; margin-left:6px; font-weight:500;}

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .iconbtn{
      width:var(--tap); height:var(--tap); border-radius:12px;
      border:1px solid var(--line); background:transparent; color:var(--muted);
      display:grid; place-items:center; cursor:pointer; font-size:16px;
    }
    .btn{
      min-height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--txt);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:900; font-size:13px;
      display:flex; align-items:center; gap:8px;
    }
    .btn.primary{ background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.45); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(34,197,94,.4); color:#a7f3d0; background:rgba(34,197,94,.10);}
    .pill.err{ border-color: rgba(239,68,68,.45); color:#fecaca; background:rgba(239,68,68,.10);}
    .pill.warn{ border-color: rgba(234,179,8,.45); color:#fde68a; background:rgba(234,179,8,.10);}

    /* âœ… mainì´ ìŠ¤í¬ë¡¤ ë‹´ë‹¹ (iOS ì•ˆì •í™” í•µì‹¬) */
    main{
      flex:1;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    /* ===== Settings Panel (overlay) ===== */
    .settings{
      display:none;
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      z-index:90;
      background: rgba(0,0,0,.55);
      padding: calc(70px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom)) 14px;
    }
    .settings.open{ display:block; }
    .settingsCard{
      max-width:1100px; margin:0 auto;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 24px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .settingsHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      font-weight:950;
    }
    .settingsBody{
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:var(--panel2); color:var(--txt); outline:none;
    }
    .grid2{ display:grid; grid-template-columns: 110px 1fr; gap:10px; align-items:center; }
    @media (max-width: 520px){ .grid2{ grid-template-columns:1fr; } }
    .errorbox{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12);
      padding:12px; border-radius:12px; color:#fecaca; font-size:12px;
    }

    /* ===== Tabs ===== */
    .tabs{
      display:flex; gap:10px;
      margin-bottom:12px;
    }
    .tabbtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--txt);
      padding:10px 12px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
    }
    .tabbtn.active{
      background: rgba(59,130,246,.18);
      border-color: rgba(59,130,246,.45);
    }

    /* ===== Cards / Panels ===== */
    .stats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .stats{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .stats{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .card{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      padding:12px;
      min-height:80px;
      box-shadow:0 12px 40px rgba(0,0,0,.20);
    }
    .card.clickable{ cursor:pointer; }
    .card:active{ transform: translateY(1px); }
    .card .t{
      color:var(--muted); font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .badgeIcon{
      width:30px; height:30px; border-radius:12px; display:grid; place-items:center;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--muted);
    }
    .card .n{ font-size:22px; font-weight:950; margin-top:6px; }

    .panel{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      box-shadow:0 12px 40px rgba(0,0,0,.20);
    }
    .panelHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
    }
    .panelHead h2{ margin:0; font-size:14px; }
    .panelHead .count{
      font-size:12px; color:var(--muted);
      padding:3px 10px; border-radius:999px; border:1px solid var(--line); white-space:nowrap;
    }

    /* âœ… iOSì—ì„œ í…Œì´ë¸” ìŠ¤í¬ë¡¤ í™•ì‹¤íˆ */
    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x pan-y;
      max-height: 62vh;  /* âœ… ì•„ì´í°ì—ì„œ ë¦¬ìŠ¤íŠ¸ê°€ â€œì˜ì—­ ë‚´ ìŠ¤í¬ë¡¤â€ ë˜ë„ë¡ */
    }
    @media (max-width: 640px){
      .tableScroll{ max-height: 56vh; }
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; min-width: 720px; } /* âœ… ê°€ë¡œ ë¶€ì¡±í•˜ë©´ ê°€ë¡œìŠ¤í¬ë¡¤ */
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,23,42,.92);
      backdrop-filter: blur(6px);
      color: var(--muted);
      font-size:11px;
      text-transform: uppercase;
      letter-spacing: .04em;
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(34,48,83,.55);
      padding:12px 10px;
      vertical-align:middle;
      white-space: nowrap;
    }
    tbody tr:hover{ background: rgba(148,163,184,.07); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }
    .numRight{ text-align:right; }
    .center{ text-align:center; }
    td.nameCell{
      max-width: 44vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .sigWrap{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
    .sig{ font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid; font-weight:900; line-height:1.4; }
    .sig.red{ color:#fecaca; background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.30); }
    .sig.yellow{ color:#fde68a; background:rgba(234,179,8,.15); border-color:rgba(234,179,8,.30); }
    .sig.green{ color:#bbf7d0; background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.30); }

    .selectDot{
      width:18px; height:18px;
      border-radius:999px; border:2px solid var(--yellow);
      display:inline-block; background:transparent; vertical-align:middle;
    }
    .selectDot.on{ background: var(--yellow); border-color: var(--yellow); }
    .selectHit{
      display:inline-flex; align-items:center; justify-content:center;
      width:var(--tap); height:var(--tap); border-radius:12px;
    }

    /* ===== Perf small pills ===== */
    .pillsRow{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-bottom:14px;
    }
    .pillBig{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      display:flex;
      gap:8px;
      align-items:center;
      color: var(--txt);
      white-space:nowrap;
    }
    .pillBig .k{ color: var(--muted); font-weight:800; }
    .pillBig .v{ font-variant-numeric: tabular-nums; }

    /* ===== Alert Modal ===== */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      z-index:120;
      background: rgba(0,0,0,.55);
      padding: calc(16px + env(safe-area-inset-top)) 14px calc(14px + env(safe-area-inset-bottom)) 14px;
    }
    .modal.open{ display:block; }
    .modalCard{
      max-width:720px;
      margin: 10vh auto 0 auto;
      background: #f8fafc;
      color:#0f172a;
      border-radius:16px;
      box-shadow:0 24px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      font-weight:950;
      border-bottom:1px solid rgba(15,23,42,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalBody{
      padding:14px;
      line-height:1.55;
      font-size:14px;
      white-space:pre-wrap;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(15,23,42,.12);
      display:flex;
      justify-content:flex-end;
    }
    .modalBtn{
      border:1px solid rgba(15,23,42,.20);
      background: transparent;
      padding:10px 14px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
    }

    /* ===== Right detail (Screen tab only) ===== */
    .screenWrap{
      display:flex;
      gap:14px;
      align-items:stretch;
      min-height:0;
    }
    .leftPane{ flex:1; min-width:0; display:flex; flex-direction:column; gap:14px; }
    .rightPane{
      width:380px;
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      overflow:hidden;
      display:none;
      flex-direction:column;
      min-height:0;
      box-shadow:0 12px 40px rgba(0,0,0,.20);
    }
    .rightPane.open{ display:flex; }
    @media (max-width:1024px){
      .screenWrap{ flex-direction:column; }
      .rightPane{ width:auto; }
    }

    .detailTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-bottom:1px solid var(--line); }
    .live{
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.12);
      color:#a7f3d0; font-weight:950;
      white-space:nowrap;
    }
    .closeBtn{
      width:var(--tap); height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--muted);
      border-radius:12px; cursor:pointer; display:grid; place-items:center; font-size:16px;
    }
    .detailBody{ padding:14px; overflow:auto; -webkit-overflow-scrolling:touch; }
    .detailH{ margin:6px 0 10px; font-size:22px; font-weight:950; }
    .boxGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box{ border:1px solid rgba(34,48,83,.7); background: rgba(15,23,42,.45); padding:10px; border-radius:12px; }
    .box .l{ font-size:11px; color:var(--muted); margin-bottom:6px; }
    .box .v{ font-size:14px; font-weight:950; }
    .analysis{ margin-top:12px; border:1px solid rgba(34,48,83,.75); background: rgba(15,23,42,.45); padding:12px; border-radius:12px; }
    .analysis h3{ margin:0 0 8px; font-size:13px; display:flex; align-items:center; gap:8px; }
    .analysis ul{ margin:0; padding-left:18px; color:#cbd5e1; font-size:13px; }
    .analysis li{ margin:6px 0; }
    .foot{ margin-top:12px; border-top:1px solid rgba(34,48,83,.65); padding-top:10px; color:var(--muted); font-size:12px; }

    .spin{
      display:inline-block; width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(148,163,184,.35); border-top-color: rgba(148,163,184,1);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg);} }
  </style>
</head>

<body>
<div class="app">

  <header>
    <div class="headInner">
      <div class="brand">
        <div class="logo"></div>
        <div style="min-width:0;">
          <h1>í€€íŠ¸ ìŠ¤í¬ë¦¬ë„ˆ <span class="sub">Single-file</span></h1>
        </div>
      </div>

      <div class="toolbar">
        <button class="iconbtn" id="settingsBtn" title="URL ì„¤ì •">âš™ï¸</button>
        <span class="pill" id="lastUpdatedPill">ê°±ì‹ : -</span>
        <span class="pill warn" id="statusPill">ëŒ€ê¸°</span>
        <button class="btn primary" id="refreshBtn"><span id="refreshIcon">â†»</span> ë°ì´í„° ê°±ì‹ </button>
      </div>
    </div>
  </header>

  <!-- Settings Overlay -->
  <div class="settings" id="settingsPanel" aria-hidden="true">
    <div class="settingsCard">
      <div class="settingsHead">
        <div>Google Sheet CSV URL ì„¤ì •</div>
        <button class="iconbtn" id="settingsCloseBtn" title="ë‹«ê¸°">âœ•</button>
      </div>

      <div class="settingsBody">
        <div class="grid2">
          <label><b style="color:#93c5fd;">ALL</b></label>
          <input id="urlALL" type="text">
          <label><b style="color:#bbf7d0;">TREND</b></label>
          <input id="urlTREND" type="text">
          <label><b style="color:#fde68a;">PULLBACK</b></label>
          <input id="urlPULLBACK" type="text">
          <label><b style="color:#fecaca;">BREAKOUT</b></label>
          <input id="urlBREAKOUT" type="text">

          <label><b style="color:#a7f3d0;">STORAGE</b></label>
          <input id="urlSTORAGE" type="text">
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn primary" id="saveAndRefreshBtn">URL ì €ì¥ ë° ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="errorbox" id="errorBox" style="display:none;">
          <div style="font-weight:950;">ì˜¤ë¥˜</div>
          <div>
            <div id="errorMsg" style="word-break:break-all;"></div>
            <div class="muted" style="margin-top:6px;">
              * ì‹œíŠ¸ê°€ â€œì›¹ì— ê²Œì‹œâ€ë˜ì–´ ìˆê³  URLì´ <span class="mono">output=csv</span>ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- How Modal -->
  <div class="modal" id="howModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalHead">
        <div>[How: Score ì‚°ì‹]</div>
        <button class="modalBtn" id="howCloseTop">ë‹«ê¸°</button>
      </div>
      <div class="modalBody" id="howBody"></div>
      <div class="modalFoot">
        <button class="modalBtn" id="howCloseBtn">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <main>
    <div class="tabs">
      <button class="tabbtn active" id="tabScreen">ğŸ” í¬ì°©</button>
      <button class="tabbtn" id="tabPerf">ğŸ“Š ì„±ê³¼</button>
    </div>

    <!-- ========== SCREEN TAB ========== -->
    <section id="screenSection">
      <div class="stats">
        <div class="card clickable" data-filter="ALL">
          <div class="t"><span>ì „ì²´ í¬ì°©</span><span class="badgeIcon">ğŸ”</span></div>
          <div class="n" id="statTotal">-</div>
        </div>

        <div class="card clickable" data-filter="TREND">
          <div class="t"><span>ì¶”ì„¸ ì¶”ì¢…</span><span class="badgeIcon" style="border-color:rgba(34,197,94,.35); color:#bbf7d0;">ğŸ“ˆ</span></div>
          <div class="n" id="statTrend">-</div>
        </div>

        <div class="card clickable" data-filter="PULLBACK">
          <div class="t"><span>ëˆŒë¦¼ëª©</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">ğŸŸ¡</span></div>
          <div class="n" id="statPullback">-</div>
        </div>

        <div class="card clickable" data-filter="BREAKOUT">
          <div class="t"><span>ë°•ìŠ¤ê¶Œ ëŒíŒŒ</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35); color:#fecaca;">ğŸš€</span></div>
          <div class="n" id="statBreakout">-</div>
        </div>

        <div class="card clickable" data-filter="FAV">
          <div class="t"><span>ì°œ ëª©ë¡</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">â­</span></div>
          <div class="n" id="statFav">0</div>
        </div>
      </div>

      <div class="screenWrap">
        <div class="leftPane">
          <div class="panel">
            <div class="panelHead">
              <h2>ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (<span id="filterLabel">ALL</span>)</h2>
              <div class="count"><span id="rowCount">0</span>ê±´</div>
            </div>

            <!-- âœ… ì„¸ë¡œ ìŠ¤í¬ë¡¤ì€ ì—¬ê¸°ì„œ -->
            <div class="tableScroll" id="screenTableScroll">
              <table>
                <thead>
                  <tr>
                    <th>CODE</th>
                    <th>NAME</th>
                    <th class="center">FAV</th>
                    <th class="numRight">CLOSE</th>
                    <th class="numRight">TURNOVER</th>
                    <th class="center">RSI</th>
                    <th class="center">STOCH K</th>
                    <th class="center">SIGNAL</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="rightPane" id="rightPane">
          <div class="detailTop">
            <div>
              <div class="muted" id="detailMeta">-</div>
              <div class="detailH" id="detailName">-</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="live">Live Data</span>
              <button class="closeBtn" id="detailCloseBtn" title="ë‹«ê¸°">âœ•</button>
            </div>
          </div>

          <div class="detailBody">
            <div class="boxGrid">
              <div class="box">
                <div class="l">í˜„ì¬ê°€</div>
                <div class="v"><span id="detailClose">-</span> <span class="muted" style="font-size:12px;">ì›</span></div>
              </div>
              <div class="box">
                <div class="l">RSI (14)</div>
                <div class="v" id="detailRSI">-</div>
              </div>
              <div class="box">
                <div class="l">Stoch K</div>
                <div class="v" id="detailStoch">-</div>
              </div>
              <div class="box">
                <div class="l">ê±°ë˜ëŸ‰</div>
                <div class="v" id="detailVol">-</div>
              </div>
            </div>

            <div class="analysis">
              <h3>âš ï¸ í¬ì°© ì‹ í˜¸ ë¶„ì„</h3>
              <ul id="detailSignals"></ul>
              <div class="foot" id="detailFoot">-</div>
            </div>

            <div class="analysis" style="margin-top:12px;">
              <h3>ğŸ“ˆ ì‹¤ì‹œê°„ ì°¨íŠ¸</h3>
              <iframe
                id="tvFrame"
                style="width:100%; height:240px; border:0; border-radius:10px;"
                loading="lazy"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- ========== PERF TAB ========== -->
    <section id="perfSection" style="display:none;">
      <div class="pillsRow">
        <div class="pillBig"><span class="k">ìµœê·¼</span><span class="v" id="perfN">-</span><span class="k">ê±°ë˜ì¼</span></div>
        <div class="pillBig"><span class="k">í‘œë³¸</span><span class="v" id="perfSample">-</span></div>
        <div class="pillBig"><span class="k">í‰ê· </span><span class="v" id="perfAvg">-</span></div>
        <div class="pillBig"><span class="k">ì¤‘ì•™ê°’</span><span class="v" id="perfMedian">-</span></div>
        <div class="pillBig"><span class="k">ìŠ¹ë¥ </span><span class="v" id="perfWin">-</span></div>
        <div class="pillBig"><span class="k">Best</span><span class="v" id="perfBest">-</span></div>
        <div class="pillBig"><span class="k">Worst</span><span class="v" id="perfWorst">-</span></div>
      </div>

      <div class="stats" style="grid-template-columns: repeat(4, minmax(0, 1fr));">
        <div class="card clickable" id="scoreCard">
          <div class="t"><span>ì‹ ë¢°ë„ ë³´ë“œ</span><span class="badgeIcon">ğŸ§ </span></div>
          <div class="n">Score</div>
          <div class="muted" style="margin-top:6px; font-size:12px;">ìµœê·¼ Nê±°ë˜ì¼ ê¸°ì¤€</div>
        </div>

        <div class="card clickable" id="topCard">
          <div class="t"><span>TOP ì„±ê³¼</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35);">ğŸ†</span></div>
          <div class="n" id="topName">-</div>
          <div class="muted" style="margin-top:6px; font-size:12px;">Return ê¸°ì¤€</div>
        </div>

        <div class="card clickable" id="worstCard">
          <div class="t"><span>Worst ì„±ê³¼</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35);">ğŸ¥¤</span></div>
          <div class="n" id="worstName">-</div>
          <div class="muted" style="margin-top:6px; font-size:12px;">Return ê¸°ì¤€</div>
        </div>

        <div class="card clickable" id="howCard">
          <div class="t"><span>ì„¤ëª…</span><span class="badgeIcon" style="border-color:rgba(148,163,184,.4);">â„¹ï¸</span></div>
          <div class="n">How</div>
          <div class="muted" style="margin-top:6px; font-size:12px;">ì ìˆ˜ ì‚°ì‹</div>
        </div>
      </div>

      <div class="panel" style="margin-top:14px;">
        <div class="panelHead">
          <h2>ì„±ê³¼ ë¦¬ìŠ¤íŠ¸ (Storage)</h2>
          <div class="count"><span id="perfRowCount">0</span>ê±´</div>
        </div>

        <!-- âœ… ì„±ê³¼íƒ­ë„ â€œë¦¬ìŠ¤íŠ¸ëŠ” ì˜ì—­ ë‚´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ + ê°€ë¡œ ìŠ¤í¬ë¡¤â€ -->
        <div class="tableScroll" id="perfTableScroll" style="max-height: 62vh;">
          <table>
            <thead>
              <tr>
                <th>DETECTDATE</th>
                <th>CODE</th>
                <th>NAME</th>
                <th>SIGNAL_TYPE</th>
                <th class="numRight">ENTRY</th>
                <th class="numRight">D1</th>
                <th class="numRight">D3</th>
                <th class="numRight">D5</th>
                <th class="numRight">D7</th>
                <th class="numRight">D9</th>
                <th class="numRight">SCORE</th>
              </tr>
            </thead>
            <tbody id="perfTbody">
              <tr><td colspan="11" class="center muted" style="padding:28px;">Storage ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
/** =========================
 *  CONFIG (URLs)
 *  ========================= */
const initialUrls = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv",
  STORAGE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv"
};

const LS_KEY = "quant_screener_urls_v4";
const FAV_KEY = "quant_screener_favs_v2"; // âœ… ë²„ì „ ì˜¬ë ¤ì„œ iPad â€˜ìœ ë ¹ 1â€™ ì›ì²œ ì°¨ë‹¨

let sheetUrls = loadUrls();

let data = [];
let filterType = "ALL";
let detailStock = null;

let storageRows = []; // perf

const $ = (id) => document.getElementById(id);
const settingsPanel = $("settingsPanel");
const statusPill = $("statusPill");
const lastUpdatedPill = $("lastUpdatedPill");
const tbody = $("tbody");
const rightPane = $("rightPane");
const perfTbody = $("perfTbody");

const tabScreen = $("tabScreen");
const tabPerf = $("tabPerf");
const screenSection = $("screenSection");
const perfSection = $("perfSection");

/** ===== FAV persistence ===== */
let selectedCodes = loadFavs();

function loadFavs(){
  try{
    const raw = localStorage.getItem(FAV_KEY);
    if(!raw) return new Set();
    const arr = JSON.parse(raw);
    const out = new Set();
    (Array.isArray(arr) ? arr : []).forEach(x=>{
      const c = pad6(x);
      if(/^\d{6}$/.test(c)) out.add(c);
    });
    return out;
  }catch{
    return new Set();
  }
}
function saveFavs(){
  // âœ… ì •ê·œí™” ì €ì¥(ìœ ë ¹ê°’ ì œê±°)
  const clean = Array.from(selectedCodes).map(pad6).filter(x=>/^\d{6}$/.test(x));
  localStorage.setItem(FAV_KEY, JSON.stringify(clean));
  $("statFav").textContent = String(clean.length);
}

/** ===== UI helpers ===== */
function setStatus(type, msg){
  statusPill.classList.remove("ok","warn","err");
  statusPill.classList.add(type);
  statusPill.textContent = msg;
}
function showError(msg){
  $("errorBox").style.display = "flex";
  $("errorMsg").textContent = msg;
}
function hideError(){
  $("errorBox").style.display = "none";
  $("errorMsg").textContent = "";
}
function fmt(n){ return new Intl.NumberFormat("ko-KR").format(n); }
function toNum(v){
  if(v === null || v === undefined) return 0;
  const s = String(v).replaceAll(",","").trim();
  const x = Number(s);
  return Number.isFinite(x) ? x : 0;
}
function pad6(code){
  const s = String(code ?? "").replace(/"/g,"").trim();
  if(/^\d+$/.test(s)) return s.padStart(6,"0");
  return s;
}
function bust(url){
  return url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

/** ===== CSV robust parser ===== */
function parseCSVRows(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0; i<text.length; i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }
    if(!inQuotes && ch === ","){ row.push(cur); cur = ""; continue; }
    if(!inQuotes && ch === "\n"){
      row.push(cur); rows.push(row);
      row = []; cur = ""; continue;
    }
    if(ch === "\r") continue;
    cur += ch;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function toBool(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "true" || s === "1" || s === "y" || s === "yes" || s === "t");
}

/** ===== Parse ALL sheet ===== */
function parseAllSheet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  const iCode = idx("Code");
  if(iCode < 0) return [];

  const iName = idx("Name"), iMarket = idx("Market"), iDate = idx("Date");
  const iTrend = idx("Trend"), iPull = idx("Pullback"), iBreak = idx("Breakout");
  const iClose = idx("Close"), iVol = idx("Volume"), iTurn = idx("Turnover");
  const iRSI = idx("RSI14"), iStoch = idx("Stoch_K");

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;
    out.push({
      Code: code,
      Name: iName >= 0 ? String(r[iName] ?? "").trim() : "",
      Market: iMarket >= 0 ? String(r[iMarket] ?? "").trim() : "",
      Date: iDate >= 0 ? String(r[iDate] ?? "").trim() : "",

      Trend_Signal: iTrend >= 0 ? toBool(r[iTrend]) : false,
      Pullback_Signal: iPull >= 0 ? toBool(r[iPull]) : false,
      Breakout_Signal: iBreak >= 0 ? toBool(r[iBreak]) : false,

      Close: iClose >= 0 ? toNum(r[iClose]) : 0,
      Volume: iVol >= 0 ? toNum(r[iVol]) : 0,
      Turnover: iTurn >= 0 ? toNum(r[iTurn]) : 0,
      RSI14: iRSI >= 0 ? toNum(r[iRSI]) : 0,
      Stoch_K: iStoch >= 0 ? toNum(r[iStoch]) : 0
    });
  }
  return out;
}

function parseSignalSheetToSet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return new Set();
  const headers = rows[0].map(h => String(h).trim());
  const codeIdx = headers.findIndex(h => h === "Code");
  const iCode = codeIdx >= 0 ? codeIdx : 0;

  const set = new Set();
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(/^\d{6}$/.test(code)) set.add(code);
  }
  return set;
}

/** ===== Parse STORAGE sheet ===== */
function parseStorage(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  // ê¸°ëŒ€ í—¤ë”: Code, Name, Market, DetectDate, Signal_Type, EntryPrice, D1,D3,D5,D7,D9 ...
  const iCode = idx("Code");
  if(iCode < 0) return [];

  const iName = idx("Name");
  const iDetect = idx("DetectDate");
  const iSigType = idx("Signal_Type");
  const iEntry = idx("EntryPrice");

  const iD1 = idx("D1"), iD3 = idx("D3"), iD5 = idx("D5"), iD7 = idx("D7"), iD9 = idx("D9");

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;

    const detectRaw = String(iDetect >= 0 ? (r[iDetect] ?? "") : "").trim();
    // âœ… ë‚ ì§œë§Œ ì“°ê²Œ(DetectDateê°€ í˜¹ì‹œ "YYYY-MM-DD 0:00" ì„ì—¬ë„ ì• 10ì)
    const detectDate = detectRaw.length >= 10 ? detectRaw.slice(0,10) : detectRaw;

    const rowObj = {
      DetectDate: detectDate,
      Code: code,
      Name: iName>=0 ? String(r[iName] ?? "").trim() : "",
      Signal_Type: iSigType>=0 ? String(r[iSigType] ?? "").trim() : "",
      Entry: iEntry>=0 ? toNum(r[iEntry]) : 0,
      D1: iD1>=0 ? toNum(r[iD1]) : NaN,
      D3: iD3>=0 ? toNum(r[iD3]) : NaN,
      D5: iD5>=0 ? toNum(r[iD5]) : NaN,
      D7: iD7>=0 ? toNum(r[iD7]) : NaN,
      D9: iD9>=0 ? toNum(r[iD9]) : NaN,
    };
    out.push(rowObj);
  }
  return out;
}

/** ===== Score (5í•­, D1/D3 ë¹„ì¤‘ í¬ê²Œ) =====
 *  - weights sum = 1.00
 */
const W = { D1:0.34, D3:0.26, D5:0.18, D7:0.12, D9:0.10 };

function isFiniteNum(x){ return Number.isFinite(Number(x)); }
function pickNum(x){ const n = Number(x); return Number.isFinite(n) ? n : NaN; }

function rowScore(r){
  const d1 = pickNum(r.D1), d3 = pickNum(r.D3), d5 = pickNum(r.D5), d7 = pickNum(r.D7), d9 = pickNum(r.D9);
  // NaNì€ ì œì™¸í•˜ê³  ê°€ì¤‘ì¹˜ ì¬ì •ê·œí™”
  const pairs = [
    ["D1", d1], ["D3", d3], ["D5", d5], ["D7", d7], ["D9", d9]
  ].filter(([k,v]) => Number.isFinite(v));
  if(!pairs.length) return NaN;
  const wSum = pairs.reduce((s,[k]) => s + W[k], 0);
  const score = pairs.reduce((s,[k,v]) => s + (W[k]/wSum)*v, 0);
  return score;
}

function pct(x){
  const n = Number(x);
  if(!Number.isFinite(n)) return "-";
  return (n*100).toFixed(2) + "%";
}

/** ===== Fetch ===== */
async function fetchText(url){
  const res = await fetch(bust(url), { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

/** ===== Screen Data Fetch ===== */
async function fetchScreenData(){
  if(!sheetUrls.ALL){
    openSettings(true);
    showError("ALL ì‹œíŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•´ì¤˜.");
    return;
  }

  hideError();
  setStatus("warn","ë¡œë”©ì¤‘...");
  $("refreshBtn").disabled = true;
  $("refreshIcon").innerHTML = '<span class="spin"></span>';

  detailStock = null;
  closeDetail();

  try{
    const [allText, trendText, pullText, breakText] = await Promise.all([
      fetchText(sheetUrls.ALL),
      sheetUrls.TREND ? fetchText(sheetUrls.TREND).catch(()=>null) : Promise.resolve(null),
      sheetUrls.PULLBACK ? fetchText(sheetUrls.PULLBACK).catch(()=>null) : Promise.resolve(null),
      sheetUrls.BREAKOUT ? fetchText(sheetUrls.BREAKOUT).catch(()=>null) : Promise.resolve(null)
    ]);

    const allData = parseAllSheet(allText);
    if(!allData.length) throw new Error("ALL ì‹œíŠ¸ íŒŒì‹± ì‹¤íŒ¨. í—¤ë”/ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì¤˜.");

    const trendSet = trendText ? parseSignalSheetToSet(trendText) : null;
    const pullSet  = pullText  ? parseSignalSheetToSet(pullText)  : null;
    const breakSet = breakText ? parseSignalSheetToSet(breakText) : null;

    data = allData.map(s => {
      if(trendSet) s.Trend_Signal = trendSet.has(s.Code) || s.Trend_Signal;
      if(pullSet)  s.Pullback_Signal = pullSet.has(s.Code) || s.Pullback_Signal;
      if(breakSet) s.Breakout_Signal = breakSet.has(s.Code) || s.Breakout_Signal;
      return s;
    });

    // âœ… ìœ ë ¹ ì°œ ì •ë¦¬: í˜„ì¬ ë¡œë”©ëœ ì½”ë“œì— ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ ë‚¨ê¹€ (iPad â€˜1â€™ ë°©ì§€)
    const validCodes = new Set(data.map(x=>x.Code));
    selectedCodes = new Set(Array.from(selectedCodes).filter(c => validCodes.has(c)));
    saveFavs();

    data.sort((a,b) => {
      if(b.Breakout_Signal !== a.Breakout_Signal) return b.Breakout_Signal ? 1 : -1;
      if(b.Pullback_Signal !== a.Pullback_Signal) return b.Pullback_Signal ? 1 : -1;
      if(b.Trend_Signal !== a.Trend_Signal) return b.Trend_Signal ? 1 : -1;
      return toNum(b.Turnover) - toNum(a.Turnover);
    });

    updateStats();
    renderScreenTable();

    lastUpdatedPill.textContent = "ê°±ì‹ : " + new Date().toLocaleTimeString("ko-KR");
    setStatus("ok","ìµœì‹  ë°˜ì˜");
    openSettings(false);

  }catch(e){
    data = [];
    updateStats();
    renderScreenEmpty("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + (e.message || String(e)));
    setStatus("err","ì‹¤íŒ¨");
    showError(e.message || String(e));
  }finally{
    $("refreshBtn").disabled = false;
    $("refreshIcon").textContent = "â†»";
  }
}

/** ===== Perf Data Fetch ===== */
async function fetchPerfData(){
  if(!sheetUrls.STORAGE){
    renderPerfEmpty("Storage CSV URLì„ í™•ì¸í•´ì¤˜. (ì„¤ì • âš™ï¸ â†’ STORAGE)");
    return;
  }
  try{
    const text = await fetchText(sheetUrls.STORAGE);
    const rows = parseStorage(text);
    if(!rows.length){
      renderPerfEmpty("Storage ë°ì´í„°ê°€ ë¹„ì–´ìˆê±°ë‚˜ íŒŒì‹± ì‹¤íŒ¨. í—¤ë”/ë°ì´í„°ë¥¼ í™•ì¸í•´ì¤˜.");
      return;
    }
    // Score ê³„ì‚°
    storageRows = rows.map(r => ({...r, Score: rowScore(r)}));

    // ìµœì‹ ìˆœ
    storageRows.sort((a,b) => (b.DetectDate||"").localeCompare(a.DetectDate||""));

    renderPerfTable();
    computePerfSummary();

  }catch(e){
    renderPerfEmpty("Storage ë¡œë”© ì‹¤íŒ¨: " + (e.message || String(e)));
  }
}

/** ===== Screen Rendering ===== */
function getFiltered(){
  if(filterType === "TREND") return data.filter(x => x.Trend_Signal);
  if(filterType === "PULLBACK") return data.filter(x => x.Pullback_Signal);
  if(filterType === "BREAKOUT") return data.filter(x => x.Breakout_Signal);
  if(filterType === "FAV") return data.filter(x => selectedCodes.has(x.Code));
  return data;
}
function updateStats(){
  $("statTotal").textContent = fmt(data.length);
  $("statTrend").textContent = fmt(data.filter(x=>x.Trend_Signal).length);
  $("statPullback").textContent = fmt(data.filter(x=>x.Pullback_Signal).length);
  $("statBreakout").textContent = fmt(data.filter(x=>x.Breakout_Signal).length);
  $("statFav").textContent = String(selectedCodes.size);
}
function renderScreenEmpty(msg){
  tbody.innerHTML = `<tr><td colspan="8" class="center muted" style="padding:28px;">${escapeHtml(msg)}</td></tr>`;
  $("rowCount").textContent = "0";
}
function rsiColor(v){
  const x = Number(v)||0;
  if(x <= 30) return "#60a5fa";
  if(x >= 70) return "#fb7185";
  return "#94a3b8";
}
function stochColor(v){
  const x = Number(v)||0;
  if(x <= 20) return "#60a5fa";
  if(x >= 80) return "#fb7185";
  return "#94a3b8";
}
function renderScreenTable(){
  const rows = getFiltered();
  $("filterLabel").textContent = filterType;
  $("rowCount").textContent = String(rows.length);

  if(filterType === "FAV" && selectedCodes.size === 0){
    renderScreenEmpty("ì°œí•œ ì¢…ëª©ì´ ì—†ì–´. ë¦¬ìŠ¤íŠ¸ì—ì„œ ë…¸ë€ ì ìœ¼ë¡œ ì°ì–´ì¤˜ â­");
    return;
  }
  if(!rows.length){
    renderScreenEmpty("ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ì–´.");
    return;
  }

  tbody.innerHTML = rows.map((s) => {
    const isMulti = selectedCodes.has(s.Code);
    const turnoverEok = Math.round(toNum(s.Turnover) / 100000000);
    const sigs = [
      s.Breakout_Signal ? `<span class="sig red">ëŒíŒŒ</span>` : "",
      s.Pullback_Signal ? `<span class="sig yellow">ëˆŒë¦¼</span>` : "",
      s.Trend_Signal ? `<span class="sig green">ì¶”ì„¸</span>` : "",
    ].join("");

    return `
      <tr data-code="${s.Code}">
        <td class="mono muted">${escapeHtml(s.Code)}</td>
        <td class="nameCell">${escapeHtml(s.Name || "")}</td>

        <td class="center">
          <span class="selectHit" data-action="select" data-code="${s.Code}">
            <span class="selectDot ${isMulti ? "on" : ""}"></span>
          </span>
        </td>

        <td class="numRight mono" style="color:#fb7185;">
          ${fmt(Math.round(toNum(s.Close)))}
        </td>

        <td class="numRight mono">${fmt(turnoverEok)}ì–µ</td>

        <td class="center mono" style="color:${rsiColor(s.RSI14)};">
          ${s.RSI14 ? Number(s.RSI14).toFixed(1) : "-"}
        </td>

        <td class="center mono" style="color:${stochColor(s.Stoch_K)};">
          ${s.Stoch_K ? Number(s.Stoch_K).toFixed(1) : "-"}
        </td>

        <td class="center"><div class="sigWrap">${sigs}</div></td>
      </tr>
    `;
  }).join("");
}

/** ===== Detail ===== */
function openDetail(stock){
  detailStock = stock;

  $("detailMeta").textContent = `${stock.Market || "-"} | ${stock.Code}`;
  $("detailName").textContent = stock.Name || "-";
  $("detailClose").textContent = fmt(Math.round(toNum(stock.Close)));
  $("detailRSI").textContent = stock.RSI14 ? Number(stock.RSI14).toFixed(2) : "-";
  $("detailStoch").textContent = stock.Stoch_K ? Number(stock.Stoch_K).toFixed(2) : "-";
  $("detailVol").textContent = fmt(Math.round(toNum(stock.Volume)));

  const ul = $("detailSignals");
  ul.innerHTML = "";
  if(stock.Breakout_Signal) ul.innerHTML += `<li><b>ë°•ìŠ¤ê¶Œ ëŒíŒŒ:</b> ê±°ë˜ëŸ‰ + ëª¨ë©˜í…€ ë™ë°˜ ìƒë‹¨ ëŒíŒŒ ê°€ëŠ¥ì„±</li>`;
  if(stock.Pullback_Signal) ul.innerHTML += `<li><b>ëˆŒë¦¼ëª©:</b> ìƒìŠ¹ ì¶”ì„¸ ì¤‘ ì¡°ì • ì´í›„ ì¬ì‹œë™ ê°€ëŠ¥ì„±</li>`;
  if(stock.Trend_Signal) ul.innerHTML += `<li><b>ì¶”ì„¸ ì¶”ì¢…:</b> ì¶”ì„¸ ì§€ì† + ê±°ë˜ëŸ‰ í™•ëŒ€ ê°€ëŠ¥ì„±</li>`;
  if(!ul.innerHTML) ul.innerHTML = `<li class="muted">ì‹ í˜¸ ì •ë³´ ì—†ìŒ</li>`;

  const eok = Math.round(toNum(stock.Turnover) / 100000000);
  $("detailFoot").innerHTML = `ê¸°ì¤€ì¼: ${escapeHtml(stock.Date || "-")}<br/>ê±°ë˜ëŒ€ê¸ˆ: ${fmt(eok)}ì–µì›`;

  rightPane.classList.add("open");

  const frame = document.getElementById("tvFrame");
  if(frame){
    frame.src =
      "https://www.tradingview.com/widgetembed/?" +
      "symbol=KRX:" + stock.Code +
      "&interval=D" +
      "&theme=dark" +
      "&hidesidetoolbar=1" +
      "&hidetoptoolbar=1";
  }
}
function closeDetail(){
  rightPane.classList.remove("open");
  detailStock = null;
}
function toggleDetailByCode(code){
  const stock = data.find(x => x.Code === code);
  if(!stock) return;
  if(detailStock && detailStock.Code === code) closeDetail();
  else openDetail(stock);
}
function toggleSelect(code){
  if(selectedCodes.has(code)) selectedCodes.delete(code);
  else selectedCodes.add(code);
  saveFavs();
  renderScreenTable();
  updateStats();
}

/** ===== Perf Rendering ===== */
function renderPerfEmpty(msg){
  $("perfRowCount").textContent = "0";
  perfTbody.innerHTML = `<tr><td colspan="11" class="center muted" style="padding:28px;">${escapeHtml(msg)}</td></tr>`;
}
function renderPerfTable(){
  const rows = storageRows;
  $("perfRowCount").textContent = String(rows.length);

  if(!rows.length){
    renderPerfEmpty("Storage ë°ì´í„°ê°€ ì—†ì–´.");
    return;
  }

  perfTbody.innerHTML = rows.map(r=>{
    const score = r.Score;
    return `
      <tr>
        <td class="mono muted">${escapeHtml(r.DetectDate || "-")}</td>
        <td class="mono">${escapeHtml(r.Code)}</td>
        <td class="nameCell">${escapeHtml(r.Name || "")}</td>
        <td class="mono muted">${escapeHtml(r.Signal_Type || "")}</td>
        <td class="numRight mono">${fmt(Math.round(toNum(r.Entry)))}</td>
        <td class="numRight mono" style="color:${Number(r.D1)>=0? '#a7f3d0':'#fecaca'}">${pct(r.D1)}</td>
        <td class="numRight mono" style="color:${Number(r.D3)>=0? '#a7f3d0':'#fecaca'}">${pct(r.D3)}</td>
        <td class="numRight mono" style="color:${Number(r.D5)>=0? '#a7f3d0':'#fecaca'}">${pct(r.D5)}</td>
        <td class="numRight mono" style="color:${Number(r.D7)>=0? '#a7f3d0':'#fecaca'}">${pct(r.D7)}</td>
        <td class="numRight mono" style="color:${Number(r.D9)>=0? '#a7f3d0':'#fecaca'}">${pct(r.D9)}</td>
        <td class="numRight mono" style="font-weight:950;">${Number.isFinite(score)? pct(score) : "-"}</td>
      </tr>
    `;
  }).join("");
}

function median(arr){
  const a = arr.slice().sort((x,y)=>x-y);
  if(!a.length) return NaN;
  const m = Math.floor(a.length/2);
  return (a.length%2) ? a[m] : (a[m-1]+a[m])/2;
}

function computePerfSummary(){
  const rows = storageRows;
  const scores = rows.map(r=>r.Score).filter(x=>Number.isFinite(x));
  const n = scores.length;

  $("perfN").textContent = "-"; // Storageë§Œìœ¼ë¡  â€œìµœê·¼ Nê±°ë˜ì¼â€ì€ DetectDate ìœ ë‹ˆí¬ countë¡œ ë³´ì—¬ì¤Œ
  const uniqDates = new Set(rows.map(r=>r.DetectDate).filter(Boolean));
  $("perfN").textContent = String(uniqDates.size);

  $("perfSample").textContent = String(rows.length);

  const avg = n ? scores.reduce((s,x)=>s+x,0)/n : NaN;
  const med = n ? median(scores) : NaN;
  const win = n ? (scores.filter(x=>x>0).length / n) : NaN;

  $("perfAvg").textContent = Number.isFinite(avg) ? pct(avg) : "-";
  $("perfMedian").textContent = Number.isFinite(med) ? pct(med) : "-";
  $("perfWin").textContent = Number.isFinite(win) ? (win*100).toFixed(1)+"%" : "-";

  // Best / Worst (Score ê¸°ì¤€)
  const best = rows.filter(r=>Number.isFinite(r.Score)).sort((a,b)=>b.Score-a.Score)[0];
  const worst = rows.filter(r=>Number.isFinite(r.Score)).sort((a,b)=>a.Score-b.Score)[0];

  $("perfBest").textContent = best ? `${best.Name || best.Code} ${pct(best.Score)}` : "-";
  $("perfWorst").textContent = worst ? `${worst.Name || worst.Code} ${pct(worst.Score)}` : "-";

  $("topName").textContent = best ? `${best.Name || best.Code} ${pct(best.Score)}` : "-";
  $("worstName").textContent = worst ? `${worst.Name || worst.Code} ${pct(worst.Score)}` : "-";
}

/** ===== How Modal ===== */
function buildHowText(){
  // âœ… â€œë§˜ëŒ€ë¡œ ë°”ë€ ì„¤ëª…â€ ì›ë³µ + D7 í¬í•¨(5í•­ ê°€ì¤‘ì¹˜) + ì•ŒëŸ¿ ìŠ¤íƒ€ì¼
  const wText = `Score = w1Â·Avg(D1) + w3Â·Avg(D3) + w5Â·Avg(D5) + w7Â·Avg(D7) + w9Â·Avg(D9)

ê°€ì¤‘ì¹˜(í•©=1.00)
- w1(D1)=0.34
- w3(D3)=0.26
- w5(D5)=0.18
- w7(D7)=0.12
- w9(D9)=0.10

ê·œì¹™
- Dn ê°’ì´ ì—†ëŠ” í‘œë³¸ì€ ì œì™¸í•˜ê³ , ë‚¨ì€ ê°€ì¤‘ì¹˜ë¥¼ â€œì¬ì •ê·œí™”â€í•´ì„œ Scoreë¥¼ ê³„ì‚°í•´.
- í‘œë³¸ì´ ë„ˆë¬´ ì ìœ¼ë©´ íŒ¨ë„í‹° ì ìš©:
  Â· n < 5  â†’ Score Ã— 0.70
  Â· n < 10 â†’ Score Ã— 0.85
- í•´ì„: â€œì´ ì‹ í˜¸ ì¡°í•©ì´ ìµœê·¼ êµ¬ê°„ì—ì„œ ì–¼ë§ˆë‚˜ ì˜ ë¨¹íˆëŠ”ì§€â€ë¥¼ í•œ ì¤„ë¡œ ìš”ì•½í•œ ì ìˆ˜ì•¼.`;

  return wText;
}

function openHow(){
  $("howBody").textContent = buildHowText();
  $("howModal").classList.add("open");
}
function closeHow(){
  $("howModal").classList.remove("open");
}

/** ===== Settings ===== */
function loadUrls(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {...initialUrls};
    const obj = JSON.parse(raw);
    return { ...initialUrls, ...obj };
  }catch{
    return {...initialUrls};
  }
}
function saveUrls(){
  localStorage.setItem(LS_KEY, JSON.stringify(sheetUrls));
}
function openSettings(open){
  settingsPanel.classList.toggle("open", !!open);
  settingsPanel.setAttribute("aria-hidden", open ? "false" : "true");
}

/** ===== Tabs ===== */
function setTab(which){
  const isScreen = (which === "screen");
  tabScreen.classList.toggle("active", isScreen);
  tabPerf.classList.toggle("active", !isScreen);
  screenSection.style.display = isScreen ? "" : "none";
  perfSection.style.display = isScreen ? "none" : "";
  closeDetail();
  // ì„±ê³¼íƒ­ ë“¤ì–´ê°ˆ ë•Œ Storage ë¡œë“œ
  if(!isScreen) fetchPerfData();
}

/** ===== Bind ===== */
function bind(){
  $("settingsBtn").addEventListener("click", () => openSettings(true));
  $("settingsCloseBtn").addEventListener("click", () => openSettings(false));

  $("refreshBtn").addEventListener("click", async () => {
    await fetchScreenData();
    // ì„±ê³¼íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ì„±ê³¼ë„ ìƒˆë¡œ
    if(perfSection.style.display !== "none") fetchPerfData();
  });

  $("saveAndRefreshBtn").addEventListener("click", () => {
    sheetUrls = {
      ALL: $("urlALL").value.trim(),
      TREND: $("urlTREND").value.trim(),
      PULLBACK: $("urlPULLBACK").value.trim(),
      BREAKOUT: $("urlBREAKOUT").value.trim(),
      STORAGE: $("urlSTORAGE").value.trim(),
    };
    saveUrls();
    fetchScreenData();
    if(perfSection.style.display !== "none") fetchPerfData();
    openSettings(false);
  });

  // Tabs
  tabScreen.addEventListener("click", () => setTab("screen"));
  tabPerf.addEventListener("click", () => setTab("perf"));

  // Filter cards
  document.querySelectorAll(".card[data-filter]").forEach(el => {
    el.addEventListener("click", () => {
      filterType = el.dataset.filter;
      closeDetail();
      renderScreenTable();
    });
  });

  // Screen table interactions
  tbody.addEventListener("click", (e) => {
    const t = e.target;

    const hit = t.closest("[data-action='select']");
    if(hit && hit.dataset && hit.dataset.code){
      e.stopPropagation();
      toggleSelect(hit.dataset.code);
      return;
    }

    const tr = t.closest("tr[data-code]");
    if(!tr) return;

    toggleDetailByCode(tr.dataset.code);
  });

  $("detailCloseBtn").addEventListener("click", () => closeDetail());

  // How modal
  $("howCard").addEventListener("click", openHow);
  $("scoreCard").addEventListener("click", openHow);
  $("howCloseBtn").addEventListener("click", closeHow);
  $("howCloseTop").addEventListener("click", closeHow);
  $("howModal").addEventListener("click", (e) => {
    if(e.target === $("howModal")) closeHow();
  });

  // Init inputs
  $("urlALL").value = sheetUrls.ALL;
  $("urlTREND").value = sheetUrls.TREND;
  $("urlPULLBACK").value = sheetUrls.PULLBACK;
  $("urlBREAKOUT").value = sheetUrls.BREAKOUT;
  $("urlSTORAGE").value = sheetUrls.STORAGE;

  saveFavs();
}

bind();
fetchScreenData();
</script>
</body>
</html>
