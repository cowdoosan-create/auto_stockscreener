<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>í€€íŠ¸ ìŠ¤í¬ë¦¬ë„ˆ (Single-file)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0b1220">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1628;
      --line:rgba(148,163,184,.18);
      --txt:#e5e7eb;
      --muted:#94a3b8;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --accent:#60a5fa;
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.25), transparent 60%),
                  radial-gradient(900px 500px at 80% 10%, rgba(52,211,153,.18), transparent 55%),
                  var(--bg);
      color:var(--txt);
      overflow:hidden; /* iOS ì´ì¤‘ ìŠ¤í¬ë¡¤ ê¼¬ì„ ë°©ì§€: mainë§Œ ìŠ¤í¬ë¡¤ */
    }

    /* layout */
    .app{ height:100%; display:flex; flex-direction:column; }
    .topbar{
      padding: 14px 14px 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.85));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .titleWrap{ min-width:0; }
    .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:44vw;
    }
    .subtitle{
      margin-top:2px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:44vw;
    }

    .actions{
      display:flex; align-items:center; gap:10px;
      flex:0 0 auto;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      background: rgba(96,165,250,.22);
      border-color: rgba(96,165,250,.35);
    }
    .btn.good{
      background: rgba(52,211,153,.18);
      border-color: rgba(52,211,153,.30);
    }
    .btn:active{ transform: translateY(1px); }

    /* main scroll area */
    .main{
      flex:1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding: 0 14px 18px 14px;
    }

    /* tabs */
    .tabbar{
      display:flex;
      gap:10px;
      margin: 6px 0 12px 0;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:10px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      color:var(--txt);
      background: rgba(148,163,184,.10);
      outline:1px solid rgba(148,163,184,.35);
    }

    /* grid cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:1100px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width:640px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .card{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 12px;
      min-height: 84px;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .card .k{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .card .v{
      margin-top:8px;
      font-size:30px;
      font-weight:950;
      letter-spacing:-.3px;
    }
    .badgeIcon{
      width:30px; height:30px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(148,163,184,.22);
      color:rgba(226,232,240,.9);
      background: rgba(255,255,255,.03);
      flex:0 0 auto;
    }

    /* table panel */
    .panel{
      margin-top:12px;
      border:1px solid var(--line);
      background: var(--panel2);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
    }
    .panelHead{
      padding: 12px 12px;
      border-bottom:1px solid rgba(148,163,184,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .panelHead h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      font-weight:950;
    }
    .count{
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      padding:6px 10px;
      border:1px solid rgba(148,163,184,.18);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }

    .tableScroll{
      max-height: 52vh;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    @media (max-width:640px){
      .tableScroll{ max-height: 48vh; }
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width: 820px; /* ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
    }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(11,18,32,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(148,163,184,.12);
      color: var(--muted);
      text-align:left;
      padding: 10px 10px;
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(148,163,184,.08);
      padding: 10px 10px;
      color: rgba(226,232,240,.92);
      vertical-align:middle;
      white-space:nowrap;
    }
    tbody tr:hover td{
      background: rgba(255,255,255,.03);
    }
    .numRight{ text-align:right; }
    .center{ text-align:center; }
    .muted{ color: var(--muted); }
    .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .good{ color: var(--good); font-weight:900; }
    .bad{ color: var(--bad); font-weight:900; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(255,255,255,.03);
      font-weight:900;
      font-size:12px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .pill.on{
      color: var(--txt);
      border-color: rgba(96,165,250,.35);
      background: rgba(96,165,250,.12);
    }

    /* PERF (ì„±ê³¼íƒ­ ìƒë‹¨ ì´ì „ë²„ì „ ìŠ¤íƒ€ì¼) */
    .perfTop{ display:flex; flex-direction:column; gap:12px; }

    .perfChips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      font-weight:900;
    }

    .perfCards{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:980px){
      .perfCards{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width:640px){
      .perfCards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .pCard{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      padding:12px;
      cursor:pointer;
      text-align:left;
      color:var(--txt);
      min-height:92px;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      user-select:none;
      overflow:hidden;
    }
    .pCard:active{ transform: translateY(1px); }
    .pCard.active{
      outline:1px solid rgba(148,163,184,.5);
      background: rgba(148,163,184,.08);
    }
    .pCard .t{
      color:var(--muted); font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      white-space:nowrap;
    }
    .pCard .n{ font-size:22px; font-weight:950; margin-top:6px; }
    .pCard .sub{ color:var(--muted); font-size:12px; margin-top:4px; white-space:nowrap; }
    .pCard .n, .pCard .sub{ word-break:keep-all; }

    /* modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width:min(980px, 100%);
      border:1px solid rgba(148,163,184,.20);
      border-radius:18px;
      background: rgba(15,26,46,.96);
      box-shadow: 0 30px 80px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(148,163,184,.10);
    }
    .modalHead h3{ margin:0; font-size:14px; font-weight:950; }
    .modalBody{ padding: 14px; }
    .row{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    @media (max-width:640px){
      .row{ grid-template-columns: 1fr; }
    }
    label{ color:var(--muted); font-size:12px; font-weight:900; }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(255,255,255,.03);
      color: var(--txt);
      outline:none;
    }
    input:focus{ border-color: rgba(96,165,250,.45); }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(148,163,184,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }
  </style>
</head>

<body>
<div class="app">

  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="titleWrap">
        <div class="title">í€€íŠ¸ ìŠ¤í¬ë¦¬ë„ˆ</div>
        <div class="subtitle mono" id="statusLine">ê°±ì‹ : -</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnSettings">âš™ï¸</button>
      <button class="btn good" id="btnLatest">ìµœì‹  ë°˜ì˜</button>
      <button class="btn primary" id="btnRefresh">ë°ì´í„° ê°±ì‹ </button>
    </div>
  </div>

  <div class="main">
    <div class="tabbar">
      <div class="tab active" id="tabScreen">ğŸ” í¬ì°©</div>
      <div class="tab" id="tabPerf">ğŸ“Š ì„±ê³¼</div>
    </div>

    <!-- =======================
         SCREEN TAB
    ======================== -->
    <section id="screenView">
      <div class="grid" style="margin-bottom:12px;">
        <div class="card">
          <div class="k"><span>ì „ì²´ í¬ì°©</span><span class="badgeIcon">ğŸ”</span></div>
          <div class="v mono" id="statAll">-</div>
        </div>
        <div class="card">
          <div class="k"><span>ì¶”ì„¸ ì¶”ì¢…</span><span class="badgeIcon" style="border-color:rgba(52,211,153,.28);color:#bbf7d0;">ğŸ“ˆ</span></div>
          <div class="v mono" id="statTrend">-</div>
        </div>
        <div class="card">
          <div class="k"><span>ëˆŒë¦¼ëª©</span><span class="badgeIcon" style="border-color:rgba(251,191,36,.28);color:#fde68a;">ğŸŸ¡</span></div>
          <div class="v mono" id="statPullback">-</div>
        </div>
        <div class="card">
          <div class="k"><span>ë°•ìŠ¤ê¶Œ ëŒíŒŒ</span><span class="badgeIcon" style="border-color:rgba(96,165,250,.28);color:#bfdbfe;">ğŸš€</span></div>
          <div class="v mono" id="statBreakout">-</div>
        </div>
        <div class="card">
          <div class="k"><span>ì°œ ëª©ë¡</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.28);color:#fde68a;">â­</span></div>
          <div class="v mono" id="statFav">0</div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <h2 id="screenTitle">ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ALL)</h2>
          <div class="count"><span id="screenCount">0</span>ê±´</div>
        </div>

        <div style="padding:10px 12px; display:flex; gap:8px; flex-wrap:wrap;">
          <span class="pill on" data-list="ALL">ALL</span>
          <span class="pill" data-list="TREND">Trend</span>
          <span class="pill" data-list="PULLBACK">Pullback</span>
          <span class="pill" data-list="BREAKOUT">Breakout</span>
          <span class="pill" data-list="FAV">â­ ì°œ</span>
        </div>

        <div class="tableScroll" id="screenTableWrap">
          <table>
            <thead>
              <tr id="screenThead"></tr>
            </thead>
            <tbody id="screenTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =======================
         PERF TAB
    ======================== -->
    <section id="perfView" style="display:none;">

      <div class="perfTop">
        <div class="perfChips" id="perfChips">
          <span class="chip" id="chipN">ìµœê·¼ 10 ê±°ë˜ì¼</span>
          <span class="chip" id="chipSample">í‘œë³¸ -</span>
          <span class="chip" id="chipAvg">í‰ê·  -</span>
          <span class="chip" id="chipMed">ì¤‘ì•™ê°’ -</span>
          <span class="chip" id="chipWin">ìŠ¹ë¥  -</span>
          <span class="chip" id="chipBest">Best -</span>
          <span class="chip" id="chipWorst">Worst -</span>
        </div>

        <div class="perfCards" id="perfCards">
          <button class="pCard active" data-perf="SCORE">
            <div class="t"><span>ì‹ ë¢°ë„ ë³´ë“œ</span><span class="badgeIcon">ğŸ§ </span></div>
            <div class="n">Score</div>
            <div class="sub">ìµœê·¼ Nê±°ë˜ì¼ ê¸°ì¤€</div>
          </button>

          <button class="pCard" data-perf="TOP">
            <div class="t"><span>TOP ì„±ê³¼</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35);color:#fde68a;">ğŸ†</span></div>
            <div class="n">Top</div>
            <div class="sub">Score ê¸°ì¤€</div>
          </button>

          <button class="pCard" data-perf="WORST">
            <div class="t"><span>Worst ì„±ê³¼</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35);color:#fecaca;">ğŸ¥¤</span></div>
            <div class="n">Worst</div>
            <div class="sub">Score ê¸°ì¤€</div>
          </button>

          <button class="pCard" data-perf="HISTORY">
            <div class="t"><span>ì¢…ëª© íˆìŠ¤í† ë¦¬</span><span class="badgeIcon" style="border-color:rgba(59,130,246,.35);color:#bfdbfe;">ğŸ—‚ï¸</span></div>
            <div class="n">History</div>
            <div class="sub">ì¤‘ë³µí¬ì°© í™•ì¸</div>
          </button>

          <button class="pCard" data-perf="HOW">
            <div class="t"><span>ì„¤ëª…</span><span class="badgeIcon" style="border-color:rgba(148,163,184,.35);color:#e5e7eb;">â„¹ï¸</span></div>
            <div class="n">How</div>
            <div class="sub">ì ìˆ˜ ì‚°ì‹</div>
          </button>
        </div>
      </div>

      <div class="panel" id="perfPanel">
        <div class="panelHead">
          <h2 id="perfPanelTitle">ì‹ í˜¸ ì‹ ë¢°ë„ ë³´ë“œ</h2>
          <div class="count"><span id="perfRowCount">0</span>ê±´</div>
        </div>

        <div class="tableScroll" id="perfTableWrap">
          <table>
            <thead><tr id="perfThead"></tr></thead>
            <tbody id="perfTbody">
              <tr><td class="center muted" style="padding:28px;">Storage ë¡œë”© ì „</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </section>

  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="backdrop" id="settingsBackdrop">
  <div class="modal">
    <div class="modalHead">
      <h3>Google Sheet CSV URL ì„¤ì •</h3>
      <button class="btn" id="btnCloseSettings">âœ•</button>
    </div>
    <div class="modalBody">
      <div class="row">
        <label>ALL</label>
        <input id="urlALL" placeholder="ALL CSV URL" />
      </div>
      <div class="row">
        <label>TREND</label>
        <input id="urlTREND" placeholder="Trend CSV URL" />
      </div>
      <div class="row">
        <label>PULLBACK</label>
        <input id="urlPULLBACK" placeholder="Pullback CSV URL" />
      </div>
      <div class="row">
        <label>BREAKOUT</label>
        <input id="urlBREAKOUT" placeholder="Breakout CSV URL" />
      </div>
      <div class="row">
        <label>STORAGE</label>
        <input id="urlSTORAGE" placeholder="Storage CSV URL" />
      </div>
    </div>
    <div class="modalFoot">
      <button class="btn" id="btnResetUrls">ê¸°ë³¸ê°’</button>
      <button class="btn primary" id="btnSaveUrls">URL ì €ì¥ ë° ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>
</div>

<script>
/* =========================
   STATE
========================= */
const DEFAULT_URLS = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv",
  STORAGE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv"
};

let urls = loadUrls();
let screenData = { ALL: [], TREND: [], PULLBACK: [], BREAKOUT: [] };
let storageData = [];
let currentList = "ALL";
let perfView = "SCORE";
let perfN = 10;

let favorites = loadFavs(); // Set(code)

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }

function nowStamp(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function fmt(n){
  const x = Number(n);
  if(!Number.isFinite(x)) return "-";
  return x.toLocaleString("en-US");
}
function pad6(v){
  const s = String(v ?? "").trim();
  if(!s) return "";
  const only = s.replaceAll(/[^0-9]/g,"");
  return only.padStart(6,"0");
}
function asNum(x){
  const n = Number(String(x ?? "").replaceAll(",",""));
  return Number.isFinite(n) ? n : NaN;
}
function pct(x){
  if(!Number.isFinite(x)) return "-";
  return (x*100).toFixed(2) + "%";
}
function dateOnly(s){
  const t = String(s ?? "").trim();
  return t.slice(0,10);
}
function sigLabel(r){
  const st = String(r.Signal_Type ?? "").trim();
  if(st) return st;
  const a = [];
  if(String(r.Trend ?? "").toLowerCase()==="true") a.push("Trend");
  if(String(r.Pullback ?? "").toLowerCase()==="true") a.push("Pullback");
  if(String(r.Breakout ?? "").toLowerCase()==="true") a.push("Breakout");
  return a.join("+") || "-";
}

/* =========================
   CSV PARSER
========================= */
function parseCSV(text){
  const rows = [];
  let cur = "", inQ = false;
  const out = [];
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const nx = text[i+1];
    if(inQ){
      if(ch === '"' && nx === '"'){ cur += '"'; i++; }
      else if(ch === '"'){ inQ = false; }
      else { cur += ch; }
    }else{
      if(ch === '"'){ inQ = true; }
      else if(ch === ","){ out.push(cur); cur=""; }
      else if(ch === "\n"){
        out.push(cur); cur="";
        rows.push(out.slice()); out.length=0;
      }else if(ch === "\r"){
        // skip
      }else{
        cur += ch;
      }
    }
  }
  out.push(cur);
  rows.push(out.slice());

  const header = rows.shift()?.map(h=>String(h).trim()) ?? [];
  const data = rows
    .filter(r => r.some(c => String(c ?? "").trim() !== ""))
    .map(r => {
      const obj = {};
      for(let i=0;i<header.length;i++){
        obj[header[i] || ("col"+i)] = r[i] ?? "";
      }
      return obj;
    });
  return { header, data };
}

async function fetchCSV(url){
  if(!url) return { header: [], data: [] };
  const bust = (url.includes("?") ? "&" : "?") + "ts=" + Date.now();
  const res = await fetch(url + bust, { cache:"no-store" });
  const txt = await res.text();
  return parseCSV(txt);
}

/* =========================
   FAVORITES
========================= */
function loadFavs(){
  try{
    const raw = localStorage.getItem("YJ_FAVS") || "[]";
    const arr = JSON.parse(raw);
    return new Set(arr.map(pad6).filter(Boolean));
  }catch(e){
    return new Set();
  }
}
function saveFavs(){
  localStorage.setItem("YJ_FAVS", JSON.stringify(Array.from(favorites)));
}
function toggleFav(code){
  const c = pad6(code);
  if(!c) return;
  if(favorites.has(c)) favorites.delete(c);
  else favorites.add(c);
  saveFavs();
  renderScreen();
}

/* =========================
   URLS
========================= */
function loadUrls(){
  try{
    const raw = localStorage.getItem("YJ_URLS");
    if(!raw) return {...DEFAULT_URLS};
    const obj = JSON.parse(raw);
    return { ...DEFAULT_URLS, ...obj };
  }catch(e){
    return {...DEFAULT_URLS};
  }
}
function saveUrls(){
  localStorage.setItem("YJ_URLS", JSON.stringify(urls));
}

/* =========================
   TABS
========================= */
function showTab(which){
  $("tabScreen").classList.toggle("active", which==="SCREEN");
  $("tabPerf").classList.toggle("active", which==="PERF");
  $("screenView").style.display = (which==="SCREEN") ? "" : "none";
  $("perfView").style.display = (which==="PERF") ? "" : "none";
}

/* =========================
   SCREEN RENDER
========================= */
function screenHeaderCols(){
  return [
    { key:"Code", label:"ì¢…ëª©ì½”ë“œ", cls:"mono muted" },
    { key:"Name", label:"ì¢…ëª©ëª…" },
    { key:"Select", label:"ì„ íƒ", cls:"center" },
    { key:"Value", label:"í˜„ì¬ê°€", cls:"numRight mono" },
    { key:"Volume", label:"ê±°ë˜ëŒ€ê¸ˆ", cls:"numRight mono" },
    { key:"RSI", label:"RSI", cls:"numRight mono" },
    { key:"StochK", label:"STOCH K", cls:"numRight mono" },
    { key:"Signal", label:"SIGNAL", cls:"center" },
  ];
}

function renderScreen(){
  // stats
  $("statAll").textContent = fmt(screenData.ALL.length);
  $("statTrend").textContent = fmt(screenData.TREND.length);
  $("statPullback").textContent = fmt(screenData.PULLBACK.length);
  $("statBreakout").textContent = fmt(screenData.BREAKOUT.length);
  $("statFav").textContent = fmt(favorites.size);

  // choose rows
  let rows = [];
  if(currentList==="FAV"){
    const all = screenData.ALL.slice();
    rows = all.filter(r => favorites.has(pad6(r.Code)));
    $("screenTitle").textContent = `ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (ì°œ)`;
  }else{
    rows = screenData[currentList] || [];
    $("screenTitle").textContent = `ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (${currentList})`;
  }
  $("screenCount").textContent = String(rows.length);

  // header
  const cols = screenHeaderCols();
  $("screenThead").innerHTML = cols.map(c=>`<th class="${c.cls||""}">${escapeHtml(c.label)}</th>`).join("");

  // body
  $("screenTbody").innerHTML = rows.map(r=>{
    const code = pad6(r.Code);
    const isFav = favorites.has(code);
    const signalTxt = String(r.Signal ?? "").trim() || sigLabel(r);

    const value = r.Price ?? r.Close ?? r.Close_Today ?? r.CloseToday ?? "";
    const vol = r.Volume ?? r.TradingValue ?? r.TradeValue ?? r.ê±°ë˜ëŒ€ê¸ˆ ?? "";
    const rsi = r.RSI ?? "";
    const stoch = r["STOCH K"] ?? r.StochK ?? r.Stoch_K ?? "";

    return `
      <tr>
        <td class="mono muted">${escapeHtml(code)}</td>
        <td>${escapeHtml(r.Name ?? "")}</td>
        <td class="center">
          <span class="pill ${isFav ? "on":""}" data-fav="${escapeHtml(code)}">${isFav ? "â­" : "â˜†"}</span>
        </td>
        <td class="numRight mono">${escapeHtml(String(value))}</td>
        <td class="numRight mono">${escapeHtml(String(vol))}</td>
        <td class="numRight mono">${escapeHtml(String(rsi))}</td>
        <td class="numRight mono">${escapeHtml(String(stoch))}</td>
        <td class="center">
          <span class="pill">${escapeHtml(signalTxt || "-")}</span>
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ì—†ìŒ</td></tr>`;

  // bind fav click
  document.querySelectorAll('[data-fav]').forEach(el=>{
    el.onclick = () => toggleFav(el.getAttribute("data-fav"));
  });
}

/* =========================
   PERF (ì„±ê³¼) CALC
========================= */
function scoreOfRow(r){
  // 5í•­ ê°€ì¤‘ì¹˜: D1/D3 ë¹„ì¤‘ í¬ê²Œ
  // D1 0.35 / D3 0.25 / D5 0.20 / D7 0.12 / D9 0.08
  const d1 = asNum(r.D1), d3 = asNum(r.D3), d5 = asNum(r.D5), d7 = asNum(r.D7), d9 = asNum(r.D9);
  const parts = [
    [d1, 0.35],
    [d3, 0.25],
    [d5, 0.20],
    [d7, 0.12],
    [d9, 0.08],
  ].filter(([v]) => Number.isFinite(v));
  if(!parts.length) return NaN;

  const wsum = parts.reduce((a, b)=>a+b[1], 0);
  const s = parts.reduce((a, [v,w]) => a + v*w, 0) / wsum;
  return s;
}

function uniqueRecentDates(rows, n){
  const dates = Array.from(new Set(rows.map(r => dateOnly(r.DetectDate)).filter(x=>/^\d{4}-\d{2}-\d{2}$/.test(x))));
  dates.sort((a,b)=> (a<b?1:-1));
  return dates.slice(0, n);
}

function filterByRecentN(rows, n){
  const recent = uniqueRecentDates(rows, n);
  const set = new Set(recent);
  return rows.filter(r => set.has(dateOnly(r.DetectDate)));
}

function updatePerfChips(rowsN){
  const recent = uniqueRecentDates(rowsN, perfN);
  $("chipN").textContent = `ìµœê·¼ ${recent.length} ê±°ë˜ì¼`;
  $("chipSample").textContent = `í‘œë³¸ ${rowsN.length}`;

  // ëŒ€í‘œ í†µê³„ëŠ” "Score" ê¸°ì¤€ìœ¼ë¡œ (ìš”ì²­: Top/Worstë„ Score ê¸°ì¤€)
  const scores = rowsN.map(scoreOfRow).filter(Number.isFinite);
  const avg = scores.length ? scores.reduce((a,b)=>a+b,0)/scores.length : NaN;
  const med = scores.length ? scores.slice().sort((a,b)=>a-b)[Math.floor(scores.length/2)] : NaN;
  const win = scores.length ? (scores.filter(x=>x>0).length / scores.length) : NaN;

  $("chipAvg").textContent = `í‰ê·  ${pct(avg)}`;
  $("chipMed").textContent = `ì¤‘ì•™ê°’ ${pct(med)}`;
  $("chipWin").textContent = `ìŠ¹ë¥  ${Number.isFinite(win) ? (win*100).toFixed(1)+"%" : "-"}`;

  if(scores.length){
    let best = null, worst = null;
    for(const r of rowsN){
      const sc = scoreOfRow(r);
      if(!Number.isFinite(sc)) continue;
      if(!best || sc > scoreOfRow(best)) best = r;
      if(!worst || sc < scoreOfRow(worst)) worst = r;
    }
    $("chipBest").textContent = `Best ${(best?.Name||"-")} ${pct(scoreOfRow(best))}`;
    $("chipWorst").textContent = `Worst ${(worst?.Name||"-")} ${pct(scoreOfRow(worst))}`;
  }else{
    $("chipBest").textContent = `Best -`;
    $("chipWorst").textContent = `Worst -`;
  }
}

function renderPerfTable(rowsN, mode){
  const thead = $("perfThead");
  const tbody = $("perfTbody");

  const setHead = (cols) => {
    thead.innerHTML = cols.map(c=>`<th class="${c.cls||""}">${escapeHtml(c.t)}</th>`).join("");
  };
  const setBody = (html) => { tbody.innerHTML = html; };

  if(mode === "SCORE"){
    $("perfPanelTitle").textContent = "ì‹ í˜¸ ì‹ ë¢°ë„ ë³´ë“œ (Score)";
    setHead([
      {t:"SIGNAL_TYPE"},
      {t:"í‘œë³¸", cls:"numRight"},
      {t:"Score", cls:"numRight"},
      {t:"Avg(D1)", cls:"numRight"},
      {t:"Avg(D3)", cls:"numRight"},
      {t:"Avg(D5)", cls:"numRight"},
      {t:"Avg(D7)", cls:"numRight"},
      {t:"Avg(D9)", cls:"numRight"},
    ]);

    const map = new Map();
    for(const r of rowsN){
      const key = sigLabel(r);
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(r);
    }

    const items = Array.from(map.entries()).map(([k, arr]) => {
      const avgN = (field) => {
        const xs = arr.map(x=>asNum(x[field])).filter(Number.isFinite);
        return xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : NaN;
      };

      // ê·¸ë£¹ Score = (row score í‰ê· ) * í‘œë³¸ íŒ¨ë„í‹°
      const sRaw = arr.map(scoreOfRow).filter(Number.isFinite);
      let s = sRaw.length ? (sRaw.reduce((a,b)=>a+b,0)/sRaw.length) : NaN;
      if(Number.isFinite(s)){
        if(arr.length < 5) s *= 0.70;
        else if(arr.length < 10) s *= 0.85;
      }

      return { k, n: arr.length, score:s,
        d1:avgN("D1"), d3:avgN("D3"), d5:avgN("D5"), d7:avgN("D7"), d9:avgN("D9")
      };
    });

    items.sort((a,b)=> (b.score||-999) - (a.score||-999));
    $("perfRowCount").textContent = String(items.length);

    setBody(items.map(x=>`
      <tr>
        <td>${escapeHtml(x.k)}</td>
        <td class="numRight mono">${fmt(x.n)}</td>
        <td class="numRight mono ${Number.isFinite(x.score) && x.score>=0 ? "good":"bad"}">${pct(x.score)}</td>
        <td class="numRight mono">${pct(x.d1)}</td>
        <td class="numRight mono">${pct(x.d3)}</td>
        <td class="numRight mono">${pct(x.d5)}</td>
        <td class="numRight mono">${pct(x.d7)}</td>
        <td class="numRight mono">${pct(x.d9)}</td>
      </tr>
    `).join("") || `<tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ì—†ìŒ</td></tr>`);
    return;
  }

  if(mode === "TOP" || mode === "WORST"){
    $("perfPanelTitle").textContent = mode === "TOP" ? "TOP ì„±ê³¼ (Score ê¸°ì¤€)" : "WORST ì„±ê³¼ (Score ê¸°ì¤€)";
    setHead([
  {t:"DETECTDATE"},
  {t:"CODE"},
  {t:"NAME"},
  {t:"SIGNAL_TYPE"},
  {t:"ENTRY", cls:"numRight"},
  {t:"CLOSE_TODAY", cls:"numRight"},
  {t:"RETURN", cls:"numRight"},
  {t:"D1", cls:"numRight"},
  {t:"D3", cls:"numRight"},
  {t:"D5", cls:"numRight"},
  {t:"D7", cls:"numRight"},
  {t:"D9", cls:"numRight"},
  {t:"SCORE", cls:"numRight"},
]);

    const rows2 = rowsN.map(r=>({ r, sc: scoreOfRow(r) })).filter(x=>Number.isFinite(x.sc));
    rows2.sort((a,b)=> mode==="TOP" ? (b.sc-a.sc) : (a.sc-b.sc));
    const view = rows2.slice(0, 30);

    $("perfRowCount").textContent = String(view.length);

    setBody(view.map(({r,sc})=>`
      <tr>
        <td class="mono muted">${escapeHtml(dateOnly(r.DetectDate))}</td>
        <td class="mono muted">${escapeHtml(pad6(r.Code))}</td>
        <td>${escapeHtml(r.Name||"")}</td>
        <td class="mono">${escapeHtml(sigLabel(r))}</td>
        <td class="numRight mono">${fmt(Math.round(asNum(r.EntryPrice)||0))}</td>
        <td class="numRight mono">${fmt(Math.round(asNum(r.Close_Today ?? r.CloseToday ?? r.Close ?? r.Price ?? "")||0))}</td>
        <td class="numRight mono ${Number.isFinite(asNum(r.Return)) && asNum(r.Return)>=0 ? "good":"bad"}">${pct(asNum(r.Return))}</td>
        <td class="numRight mono">${pct(asNum(r.D1))}</td>
        <td class="numRight mono">${pct(asNum(r.D3))}</td>
        <td class="numRight mono">${pct(asNum(r.D5))}</td>
        <td class="numRight mono">${pct(asNum(r.D7))}</td>
        <td class="numRight mono">${pct(asNum(r.D9))}</td>
        <td class="numRight mono ${sc>=0?"good":"bad"}">${pct(sc)}</td>
      </tr>
    `).join("") || `<tr><td colspan="11" class="center muted" style="padding:28px;">ë°ì´í„° ì—†ìŒ</td></tr>`);
    return;
  }

  if(mode === "HISTORY"){
    $("perfPanelTitle").textContent = "ì¢…ëª© íˆìŠ¤í† ë¦¬ (ì¤‘ë³µ í¬ì°©)";
    setHead([
      {t:"CODE"},
      {t:"NAME"},
      {t:"COUNT", cls:"numRight"},
      {t:"LAST_DATE"},
      {t:"SIGNALS"},
    ]);

    const map = new Map();
    for(const r of rowsN){
      const code = pad6(r.Code);
      if(!map.has(code)) map.set(code, []);
      map.get(code).push(r);
    }

    const items = Array.from(map.entries()).map(([code, arr])=>{
      arr.sort((a,b)=> (dateOnly(a.DetectDate) < dateOnly(b.DetectDate) ? 1 : -1));
      const last = arr[0];
      const sigs = Array.from(new Set(arr.map(sigLabel))).slice(0,6).join(", ");
      return { code, name:last?.Name||"", n:arr.length, last:dateOnly(last?.DetectDate), sigs };
    }).sort((a,b)=> b.n-a.n);

    $("perfRowCount").textContent = String(items.length);

    setBody(items.map(x=>`
      <tr>
        <td class="mono muted">${escapeHtml(x.code)}</td>
        <td>${escapeHtml(x.name)}</td>
        <td class="numRight mono">${fmt(x.n)}</td>
        <td class="mono muted">${escapeHtml(x.last||"-")}</td>
        <td class="mono">${escapeHtml(x.sigs||"-")}</td>
      </tr>
    `).join("") || `<tr><td colspan="5" class="center muted" style="padding:28px;">ë°ì´í„° ì—†ìŒ</td></tr>`);
    return;
  }
}

function showHowAlert(){
  const msg =
`[How: ì ìˆ˜/ì„±ê³¼ í•´ì„]
- ì„±ê³¼íƒ­ì˜ ëª¨ë“  ì§‘ê³„ëŠ” Storage ê¸°ë°˜ì´ì•¼.
- ìµœê·¼ Nê±°ë˜ì¼ì€ DetectDate(YYYY-MM-DD)ì˜ 'ê³ ìœ  ë‚ ì§œ' ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„í•´.

[Score ì‚°ì‹]
- Score = ê°€ì¤‘í‰ê· (ê°€ìš©í•œ Dnë§Œìœ¼ë¡œ ì •ê·œí™”)
  D1 0.35 / D3 0.25 / D5 0.20 / D7 0.12 / D9 0.08   (D1/D3 ë¹„ì¤‘â†‘)
- í‘œë³¸ íŒ¨ë„í‹°: n<5 â†’ Ã—0.70, n<10 â†’ Ã—0.85

[Top/Worst]
- Top/WorstëŠ” ìµœê·¼ Nê±°ë˜ì¼ rowë“¤ì˜ 'Score' ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•´ ë³´ì—¬ì¤˜.

[History]
- ì¢…ëª©ë³„ í¬ì°© íšŸìˆ˜(ì¤‘ë³µí¬ì°©)ì™€ ìµœê·¼ ë‚ ì§œ, ì‹ í˜¸ ì¡°í•©ì„ ë³´ì—¬ì¤˜.`;
  alert(msg);
}

function setPerfView(next){
  perfView = next;

  document.querySelectorAll("#perfCards .pCard").forEach(el=>{
    el.classList.toggle("active", el.dataset.perf === perfView);
  });

  if(perfView === "HOW"){
    showHowAlert();
    perfView = "SCORE";
    document.querySelectorAll("#perfCards .pCard").forEach(el=>{
      el.classList.toggle("active", el.dataset.perf === "SCORE");
    });
  }

  const rowsAll = storageData.slice();
  const rowsN = filterByRecentN(rowsAll, perfN);

  updatePerfChips(rowsN);
  renderPerfTable(rowsN, perfView);
}

function bindPerfCards(){
  document.querySelectorAll("#perfCards .pCard").forEach(el=>{
    el.onclick = () => setPerfView(el.dataset.perf);
  });
}

/* =========================
   DATA LOAD
========================= */
async function refreshAll(){
  $("statusLine").textContent = `ê°±ì‹ : ${nowStamp()}`;
  // screen csv
  const [a, t, p, b, s] = await Promise.all([
    fetchCSV(urls.ALL),
    fetchCSV(urls.TREND),
    fetchCSV(urls.PULLBACK),
    fetchCSV(urls.BREAKOUT),
    fetchCSV(urls.STORAGE),
  ]);

  screenData.ALL = a.data || [];
  screenData.TREND = t.data || [];
  screenData.PULLBACK = p.data || [];
  screenData.BREAKOUT = b.data || [];
  storageData = s.data || [];

  // ì°œ ëª©ë¡ì´ "1"ë¡œ íŠ€ëŠ” ìœ ë ¹ê°’ ë°©ì§€: ë¡œë”©ëœ ì½”ë“œì— ì—†ëŠ” ì°œì€ ìë™ ì œê±°
  const liveCodes = new Set(screenData.ALL.map(r=>pad6(r.Code)).filter(Boolean));
  const before = favorites.size;
  favorites = new Set(Array.from(favorites).filter(c => liveCodes.has(c)));
  if(favorites.size !== before) saveFavs();

  renderScreen();
  bindScreenPills();

  bindPerfCards();
  setPerfView("SCORE");
}

function bindScreenPills(){
  document.querySelectorAll('[data-list]').forEach(el=>{
    el.onclick = ()=>{
      document.querySelectorAll('[data-list]').forEach(x=>x.classList.remove("on"));
      el.classList.add("on");
      currentList = el.getAttribute("data-list");
      renderScreen();
    };
  });
}

/* =========================
   SETTINGS MODAL
========================= */
function openSettings(){
  $("urlALL").value = urls.ALL || "";
  $("urlTREND").value = urls.TREND || "";
  $("urlPULLBACK").value = urls.PULLBACK || "";
  $("urlBREAKOUT").value = urls.BREAKOUT || "";
  $("urlSTORAGE").value = urls.STORAGE || "";
  $("settingsBackdrop").classList.add("show");
}
function closeSettings(){
  $("settingsBackdrop").classList.remove("show");
}

/* =========================
   EVENTS
========================= */
$("tabScreen").onclick = ()=> showTab("SCREEN");
$("tabPerf").onclick = ()=> { showTab("PERF"); setPerfView(perfView); };

$("btnRefresh").onclick = refreshAll;
$("btnLatest").onclick = refreshAll;

$("btnSettings").onclick = openSettings;
$("btnCloseSettings").onclick = closeSettings;
$("settingsBackdrop").onclick = (e)=>{ if(e.target === $("settingsBackdrop")) closeSettings(); };

$("btnResetUrls").onclick = ()=>{
  urls = {...DEFAULT_URLS};
  saveUrls();
  openSettings();
};

$("btnSaveUrls").onclick = async ()=>{
  urls = {
    ALL: $("urlALL").value.trim(),
    TREND: $("urlTREND").value.trim(),
    PULLBACK: $("urlPULLBACK").value.trim(),
    BREAKOUT: $("urlBREAKOUT").value.trim(),
    STORAGE: $("urlSTORAGE").value.trim(),
  };
  saveUrls();
  closeSettings();
  await refreshAll();
};

/* =========================
   INIT
========================= */
(function init(){
  // screen table header set once
  const cols = screenHeaderCols();
  $("screenThead").innerHTML = cols.map(c=>`<th class="${c.cls||""}">${escapeHtml(c.label)}</th>`).join("");
  $("screenTbody").innerHTML = `<tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ê°±ì‹  ë²„íŠ¼ì„ ëˆŒëŸ¬ì¤˜</td></tr>`;

  // perf default head
  $("perfThead").innerHTML = `<th class="muted">-</th>`;
  $("perfTbody").innerHTML = `<tr><td class="center muted" style="padding:28px;">ë°ì´í„° ê°±ì‹  ë²„íŠ¼ì„ ëˆŒëŸ¬ì¤˜</td></tr>`;

  // auto load once if STORAGE exists
  if(urls.STORAGE){
    refreshAll();
  }else{
    $("statusLine").textContent = `ê°±ì‹ : -`;
  }
})();
</script>
</body>
</html>
