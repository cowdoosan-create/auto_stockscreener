<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <script>
    if (!sessionStorage.getItem("auth")) {
      const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if (input !== "fire") {
        document.body.innerHTML = "<h2 style='padding:20px'>ì ‘ê·¼ ë¶ˆê°€</h2>";
        throw new Error("Unauthorized");
      }
      sessionStorage.setItem("auth", "true");
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>YJ ìŠ¤í¬ë¦¬ë„ˆ (Single-file)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{
      --bg:#0f172a; --panel:#111c33; --panel2:#0b1224;
      --line:#223053; --txt:#e5e7eb; --muted:#94a3b8;
      --green:#22c55e; --yellow:#eab308; --red:#ef4444; --blue:#60a5fa;
      --radius:14px; --tap: 44px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      height: 100dvh; overflow:hidden;
    }

    header{ padding-top: env(safe-area-inset-top); }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 14px; background:var(--panel); border-bottom:1px solid var(--line);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:28px; height:28px; border-radius:10px;
      background:linear-gradient(135deg, #60a5fa, #22c55e);
      box-shadow:0 10px 30px rgba(59,130,246,.15);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sub{ color:var(--muted); font-size:12px; margin-left:6px; font-weight:500;}

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .iconbtn{
      width:var(--tap); height:var(--tap); border-radius:12px;
      border:1px solid var(--line); background:transparent; color:var(--muted);
      display:grid; place-items:center; cursor:pointer; font-size:16px;
    }
    .btn{
      min-height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--txt);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:800; font-size:13px;
      display:flex; align-items:center; gap:8px;
    }
    .btn.primary{ background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.45); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(34,197,94,.4); color:#a7f3d0; background:rgba(34,197,94,.10);}
    .pill.err{ border-color: rgba(239,68,68,.45); color:#fecaca; background:rgba(239,68,68,.10);}
    .pill.warn{ border-color: rgba(234,179,8,.45); color:#fde68a; background:rgba(234,179,8,.10);}

    .wrap{
      display:flex;
      height: calc(100dvh - 58px - env(safe-area-inset-top));
      min-height:0;
    }

    /* settings panel */
    .settings{
      display:none;
      position:absolute;
      top: calc(58px + env(safe-area-inset-top));
      left:0; right:0;
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding:14px;
      z-index:60;
    }
    .settings.open{ display:block; }
    .settings .inner{ max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:var(--panel2); color:var(--txt); outline:none;
    }
    select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:var(--panel2); color:var(--txt); outline:none;
      appearance:none;
    }
    .grid2{ display:grid; grid-template-columns: 130px 1fr; gap:10px; align-items:center; }
    @media (max-width: 520px){ .grid2{ grid-template-columns:1fr; } }
    .errorbox{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12);
      padding:12px; border-radius:12px; color:#fecaca; font-size:12px;
    }

    /* left / right */
    .left{
      flex:1;
      display:flex; flex-direction:column;
      padding:14px; gap:14px;
      min-width:0;
      overflow:hidden;
    }
    .right{
      width:380px; border-left:1px solid var(--line); background:var(--panel);
      padding:14px;
      overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      display:none; min-height:0;
    }
    .right.open{ display:block; }
    @media (max-width:1024px){
      .right{
        position:absolute; inset: calc(58px + env(safe-area-inset-top)) 0 0 0;
        width:auto; z-index:55; display:none;
        border-left:none; border-top:1px solid var(--line);
        border-radius:16px 16px 0 0;
      }
      .right.open{ display:block; }
    }

    /* tabs */
    .tabs{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      padding:6px; border-radius:14px;
      width: fit-content;
    }
    .tab{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding:8px 10px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
    }
    .tab.active{
      color: var(--txt);
      border-color: rgba(148,163,184,.35);
      background: rgba(148,163,184,.08);
    }

    /* stat cards */
    .stats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
      min-height:0;
    }
    @media (max-width: 980px){ .stats{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .stats{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .card{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      padding:12px; cursor:pointer; min-height:80px;
      transition: transform .05s ease, background .15s ease;
      user-select:none;
    }
    .card:active{ transform: translateY(1px); }
    .card.active{ outline:1px solid rgba(148,163,184,.5); background: rgba(148,163,184,.08); }
    .card .t{
      color:var(--muted); font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .badgeIcon{
      width:30px; height:30px; border-radius:12px; display:grid; place-items:center;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--muted);
    }
    .card .n{ font-size:22px; font-weight:950; margin-top:6px; }
    .card .s{ margin-top:6px; font-size:12px; color:var(--muted); }

    /* panel + table */
    .panel{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      overflow:hidden; display:flex; flex-direction:column;
      min-height:0;
      box-shadow:0 12px 40px rgba(0,0,0,.20);
    }
    .panelHead{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
      flex-wrap:wrap;
    }
    .panelHead h2{ margin:0; font-size:14px; }
    .panelHead .count{
      font-size:12px; color:var(--muted);
      padding:3px 10px; border-radius:999px; border:1px solid var(--line); white-space:nowrap;
    }
    .panelHead .controls{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      flex:1; min-height:0;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,23,42,.92);
      backdrop-filter: blur(6px);
      color: var(--muted);
      font-size:11px;
      text-transform: uppercase;
      letter-spacing: .04em;
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(34,48,83,.55);
      padding:12px 10px;
      vertical-align:middle;
      white-space: nowrap;
    }
    tbody tr:hover{ background: rgba(148,163,184,.07); }
    tbody tr.detailSelected{ background: rgba(59,130,246,.14); border-left:2px solid rgba(59,130,246,.85); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }
    .numRight{ text-align:right; }
    .center{ text-align:center; }
    td.nameCell{ max-width: 44vw; overflow:hidden; text-overflow: ellipsis; }

    .selectDot{
      width:18px; height:18px;
      border-radius:999px; border:2px solid var(--yellow);
      display:inline-block; background:transparent; vertical-align:middle;
    }
    .selectDot.on{ background: var(--yellow); border-color: var(--yellow); }
    .selectHit{ display:inline-flex; align-items:center; justify-content:center; width:var(--tap); height:var(--tap); border-radius:12px; }

    .sigWrap{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
    .sig{ font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid; font-weight:900; line-height:1.4; }
    .sig.red{ color:#fecaca; background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.30); }
    .sig.yellow{ color:#fde68a; background:rgba(234,179,8,.15); border-color:rgba(234,179,8,.30); }
    .sig.green{ color:#bbf7d0; background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.30); }
    .sig.blue{ color:#bfdbfe; background:rgba(96,165,250,.15); border-color:rgba(96,165,250,.30); }

    /* performance chips */
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .chip b{ color: var(--txt); }
    .kpiRow{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:0 2px;
    }

    /* right detail */
    .detailTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .live{
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.12);
      color:#a7f3d0; font-weight:950;
      white-space:nowrap;
    }
    .closeBtn{
      width:var(--tap); height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--muted);
      border-radius:12px; cursor:pointer; display:grid; place-items:center; font-size:16px;
    }
    .detailH{ margin:6px 0 10px; font-size:22px; font-weight:950; }
    .boxGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box{ border:1px solid rgba(34,48,83,.7); background: rgba(15,23,42,.45); padding:10px; border-radius:12px; }
    .box .l{ font-size:11px; color:var(--muted); margin-bottom:6px; }
    .box .v{ font-size:14px; font-weight:950; }
    .analysis{ margin-top:12px; border:1px solid rgba(34,48,83,.75); background: rgba(15,23,42,.45); padding:12px; border-radius:12px; }
    .analysis h3{ margin:0 0 8px; font-size:13px; display:flex; align-items:center; gap:8px; }
    .analysis ul{ margin:0; padding-left:18px; color:#cbd5e1; font-size:13px; }
    .analysis li{ margin:6px 0; }
    .foot{ margin-top:12px; border-top:1px solid rgba(34,48,83,.65); padding-top:10px; color:var(--muted); font-size:12px; }

    .spin{
      display:inline-block; width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(148,163,184,.35); border-top-color: rgba(148,163,184,1);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg);} }

    /* âœ… Landscape: ìƒë‹¨ì¹´ë“œ 1ì¤„ + ê°€ë¡œ ìŠ¤ì™€ì´í”„ */
    @media (orientation: landscape) and (max-height: 520px){
      header{ padding: 8px 12px; }
      h1{ font-size:16px; }
      .sub{ display:none; }

      .wrap{ height: calc(100dvh - 50px - env(safe-area-inset-top)); }
      .left{ padding:10px; gap:10px; }

      .stats{
        display:flex;
        gap:10px;
        overflow-x:auto;
        overflow-y:hidden;
        -webkit-overflow-scrolling:touch;
        overscroll-behavior-x:contain;
        padding-bottom:6px;
        scroll-snap-type: x proximity;
      }
      .card{
        flex: 0 0 240px;
        min-height: 64px;
        padding:10px;
        scroll-snap-align: start;
      }
      .card .n{ font-size:18px; margin-top:4px; }
      .badgeIcon{ width:28px; height:28px; border-radius:12px; }

      .panelHead{ padding:10px 12px; }
      .panelHead h2{ font-size:13px; }
      .panel{ min-height:0; }
      .tableScroll{ flex:1 1 auto; min-height:0; max-height:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div style="min-width:0;">
      <h1>í€€íŠ¸ ìŠ¤í¬ë¦¬ë„ˆ <span class="sub">Single-file</span></h1>
    </div>
  </div>

  <div class="toolbar">
    <button class="iconbtn" id="settingsBtn" title="URL ì„¤ì •">âš™ï¸</button>
    <span class="pill" id="lastUpdatedPill">ê°±ì‹ : -</span>
    <span class="pill warn" id="statusPill">ëŒ€ê¸°</span>
    <button class="btn primary" id="refreshBtn"><span id="refreshIcon">â†»</span> ë°ì´í„° ê°±ì‹ </button>
  </div>
</header>

<div class="settings" id="settingsPanel">
  <div class="inner">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:950;">Google Sheet CSV URL ì„¤ì •</div>
      <button class="iconbtn" id="settingsCloseBtn" title="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="grid2">
      <label><b style="color:#93c5fd;">ALL</b></label>
      <input id="urlALL" type="text">
      <label><b style="color:#bbf7d0;">TREND</b></label>
      <input id="urlTREND" type="text">
      <label><b style="color:#fde68a;">PULLBACK</b></label>
      <input id="urlPULLBACK" type="text">
      <label><b style="color:#fecaca;">BREAKOUT</b></label>
      <input id="urlBREAKOUT" type="text">
      <label><b style="color:#bfdbfe;">STORAGE</b></label>
      <input id="urlSTORAGE" type="text">
    </div>

    <div class="row" style="justify-content:space-between;">
      <div class="chip">
        ì„±ê³¼ íƒ­ ê¸°ê°„
        <b>
          <select id="perfWindowSel" style="width:auto; margin-left:8px;">
            <option value="5">ìµœê·¼ 5ê±°ë˜ì¼</option>
            <option value="10" selected>ìµœê·¼ 10ê±°ë˜ì¼</option>
            <option value="20">ìµœê·¼ 20ê±°ë˜ì¼</option>
          </select>
        </b>
      </div>
      <button class="btn primary" id="saveAndRefreshBtn">URL ì €ì¥ ë° ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="errorbox" id="errorBox" style="display:none;">
      <div style="font-weight:950;">ì˜¤ë¥˜</div>
      <div>
        <div id="errorMsg" style="word-break:break-all;"></div>
        <div class="muted" style="margin-top:6px;">
          * ëª¨ë“  ì‹œíŠ¸ê°€ â€œì›¹ì— ê²Œì‹œâ€ë˜ì–´ ìˆê³  URLì´ <span class="mono">output=csv</span>ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸
        </div>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="left" id="leftPane">

    <!-- Tabs -->
    <div class="row" style="justify-content:space-between;">
      <div class="tabs">
        <button class="tab active" id="tabScreener">ğŸ” í¬ì°©</button>
        <button class="tab" id="tabPerformance">ğŸ“Š ì„±ê³¼</button>
      </div>
      <div class="kpiRow" id="perfKpis" style="display:none;"></div>
    </div>

    <!-- ============ SCREENER VIEW ============ -->
    <div id="viewScreener">
      <div class="stats">
        <div class="card active" data-filter="ALL">
          <div class="t"><span>ì „ì²´ í¬ì°©</span><span class="badgeIcon">ğŸ”</span></div>
          <div class="n" id="statTotal">-</div>
        </div>

        <div class="card" data-filter="TREND">
          <div class="t"><span>ì¶”ì„¸ ì¶”ì¢…</span><span class="badgeIcon" style="border-color:rgba(34,197,94,.35); color:#bbf7d0;">ğŸ“ˆ</span></div>
          <div class="n" id="statTrend">-</div>
        </div>

        <div class="card" data-filter="PULLBACK">
          <div class="t"><span>ëˆŒë¦¼ëª©</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">ğŸŸ¡</span></div>
          <div class="n" id="statPullback">-</div>
        </div>

        <div class="card" data-filter="BREAKOUT">
          <div class="t"><span>ë°•ìŠ¤ê¶Œ ëŒíŒŒ</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35); color:#fecaca;">ğŸš€</span></div>
          <div class="n" id="statBreakout">-</div>
        </div>

        <div class="card" data-filter="FAV">
          <div class="t"><span>ì°œ ëª©ë¡</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">â­</span></div>
          <div class="n" id="statFav">0</div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHead">
          <h2>ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (<span id="filterLabel">ALL</span>)</h2>
          <div class="count"><span id="rowCount">0</span>ê±´</div>
        </div>

        <div class="tableScroll">
          <table>
            <thead>
              <tr>
                <th>ì¢…ëª©ì½”ë“œ</th>
                <th>ì¢…ëª©ëª…</th>
                <th class="center">ì„ íƒ</th>
                <th class="numRight" style="display:none;" id="thClose">í˜„ì¬ê°€</th>
                <th class="numRight">ê±°ë˜ëŒ€ê¸ˆ</th>
                <th class="center" style="display:none;" id="thRSI">RSI</th>
                <th class="center" style="display:none;" id="thStoch">STOCH K</th>
                <th class="center">Signal</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ============ PERFORMANCE VIEW ============ -->
    <div id="viewPerformance" style="display:none;">
      <div class="stats" id="perfCards">
        <div class="card active" data-perf="SCOREBOARD">
          <div class="t"><span>ì‹ ë¢°ë„ ë³´ë“œ</span><span class="badgeIcon" style="border-color:rgba(96,165,250,.35); color:#bfdbfe;">ğŸ§ </span></div>
          <div class="n" id="perfCardTitle">Score</div>
          <div class="s muted" id="perfCardSub">ìµœê·¼ Nê±°ë˜ì¼ ê¸°ì¤€</div>
        </div>
        <div class="card" data-perf="TOP">
          <div class="t"><span>TOP ì„±ê³¼</span><span class="badgeIcon" style="border-color:rgba(34,197,94,.35); color:#bbf7d0;">ğŸ†</span></div>
          <div class="n">Top</div>
          <div class="s muted">Return / Dn ê¸°ì¤€</div>
        </div>
        <div class="card" data-perf="BOTTOM">
          <div class="t"><span>Worst ì„±ê³¼</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35); color:#fecaca;">ğŸ§¯</span></div>
          <div class="n">Worst</div>
          <div class="s muted">ë¦¬ìŠ¤í¬ í™•ì¸</div>
        </div>
        <div class="card" data-perf="HITS">
          <div class="t"><span>ì¢…ëª© íˆìŠ¤í† ë¦¬</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">ğŸ—‚ï¸</span></div>
          <div class="n">History</div>
          <div class="s muted">ì¤‘ë³µí¬ì°© í™•ì¸</div>
        </div>
        <div class="card" data-perf="INFO">
          <div class="t"><span>ì„¤ëª…</span><span class="badgeIcon">â„¹ï¸</span></div>
          <div class="n">How</div>
          <div class="s muted">ì ìˆ˜ ì‚°ì‹</div>
        </div>
      </div>

      <div class="panel" style="margin-top:14px;">
        <div class="panelHead">
          <h2 id="perfTitle">ì‹ í˜¸ ì‹ ë¢°ë„ ë³´ë“œ</h2>
          <div class="controls">
            <span class="chip">ê¸°ê°„ <b id="perfWindowTxt">10</b>ê±°ë˜ì¼</span>
            <span class="chip">ì •ë ¬
              <b>
                <select id="perfSortSel" style="width:auto; margin-left:8px;">
                  <option value="SCORE" selected>Score</option>
                  <option value="WIN">ìŠ¹ë¥ </option>
                  <option value="N">í‘œë³¸ìˆ˜</option>
                  <option value="D1">D1</option>
                  <option value="D3">D3</option>
                  <option value="D5">D5</option>
                  <option value="D7">D7</option>
                  <option value="D9">D9</option>
                  <option value="RET">Return</option>
                </select>
              </b>
            </span>

            <span class="chip">Signal_Type
              <b>
                <select id="perfTypeSel" style="width:auto; margin-left:8px;">
                  <option value="ALL" selected>ì „ì²´</option>
                  <option value="Trend">Trend</option>
                  <option value="Pullback">Pullback</option>
                  <option value="Breakout">Breakout</option>
                  <option value="Trend+Pullback">Trend+Pullback</option>
                  <option value="Trend+Breakout">Trend+Breakout</option>
                  <option value="Pullback+Breakout">Pullback+Breakout</option>
                  <option value="Trend+Pullback+Breakout">Trend+Pullback+Breakout</option>
                </select>
              </b>
            </span>
          </div>
          <div class="count"><span id="perfRowCount">0</span>ê±´</div>
        </div>

        <div class="tableScroll">
          <table>
            <thead id="perfThead"></thead>
            <tbody id="perfTbody">
              <tr><td class="center muted" style="padding:28px;">Storage ë°ì´í„° ë¡œë”© ëŒ€ê¸°ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <aside class="right" id="rightPane">
    <div class="detailTop">
      <div>
        <div class="muted" id="detailMeta">-</div>
        <div class="detailH" id="detailName">-</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <span class="live">Live Data</span>
        <button class="closeBtn" id="detailCloseBtn" title="ë‹«ê¸°">âœ•</button>
      </div>
    </div>

    <div class="boxGrid">
      <div class="box">
        <div class="l">í˜„ì¬ê°€</div>
        <div class="v"><span id="detailClose">-</span> <span class="muted" style="font-size:12px;">ì›</span></div>
      </div>
      <div class="box">
        <div class="l">RSI (14)</div>
        <div class="v" id="detailRSI">-</div>
      </div>
      <div class="box">
        <div class="l">Stoch K</div>
        <div class="v" id="detailStoch">-</div>
      </div>
      <div class="box">
        <div class="l">ê±°ë˜ëŸ‰</div>
        <div class="v" id="detailVol">-</div>
      </div>
    </div>

    <div class="analysis" id="detailAnalysisBox">
      <h3>âš ï¸ í¬ì°© ì‹ í˜¸ ë¶„ì„</h3>
      <ul id="detailSignals"></ul>
      <div class="foot" id="detailFoot">-</div>
    </div>

    <div class="analysis" style="margin-top:12px;">
      <h3>ğŸ“ˆ ì‹¤ì‹œê°„ ì°¨íŠ¸</h3>
      <iframe
        id="tvFrame"
        style="width:100%; height:240px; border:0; border-radius:10px;"
        loading="lazy"
        allowfullscreen
      ></iframe>
    </div>

    <div class="analysis" id="perfDetailBox" style="display:none; margin-top:12px;">
      <h3>ğŸ“Œ ì„±ê³¼ íˆìŠ¤í† ë¦¬ (ìµœê·¼ Nê±°ë˜ì¼)</h3>
      <div id="perfDetailBody" class="muted" style="font-size:13px;"></div>
    </div>
  </aside>
</div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const initialUrls = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv",
  STORAGE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv"
};

const LS_KEY = "quant_screener_urls_v4";
const FAV_KEY = "quant_screener_favs_v1";
const PERF_KEY = "quant_screener_perf_v1";

let sheetUrls = loadUrls();
let perfWindow = loadPerfWindow(); // 5/10/20
let perfMode = "SCOREBOARD"; // SCOREBOARD/TOP/BOTTOM/HITS/INFO

let data = [];
let filterType = "ALL";
let detailStock = null;

let storageRows = [];         // raw storage rows
let storageFiltered = [];     // filtered by last N trading days
let perfSelectedCode = null;  // for history

// ì°œ
let selectedCodes = loadFavs();

const $ = (id) => document.getElementById(id);
const settingsPanel = $("settingsPanel");
const statusPill = $("statusPill");
const lastUpdatedPill = $("lastUpdatedPill");
const tbody = $("tbody");
const rightPane = $("rightPane");

// Views
const viewScreener = $("viewScreener");
const viewPerformance = $("viewPerformance");
const perfKpis = $("perfKpis");
const perfTbody = $("perfTbody");
const perfThead = $("perfThead");

function setStatus(type, msg){
  statusPill.classList.remove("ok","warn","err");
  statusPill.classList.add(type);
  statusPill.textContent = msg;
}
function showError(msg){
  $("errorBox").style.display = "flex";
  $("errorMsg").textContent = msg;
}
function hideError(){
  $("errorBox").style.display = "none";
  $("errorMsg").textContent = "";
}

function fmt(n){ return new Intl.NumberFormat("ko-KR").format(n); }
function fmtPct(x){
  const v = Number(x);
  if(!Number.isFinite(v)) return "-";
  const sign = v > 0 ? "+" : "";
  return sign + (v*100).toFixed(2) + "%";
}
function toNum(v){
  if(v === null || v === undefined) return 0;
  const s = String(v).replaceAll(",","").trim();
  const x = Number(s);
  return Number.isFinite(x) ? x : 0;
}
function pad6(code){
  const s = String(code ?? "").replace(/"/g,"").trim();
  if(/^\d+$/.test(s)) return s.padStart(6,"0");
  return s;
}
function bust(url){
  return url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

function parseDateStr(s){
  const t = String(s ?? "").trim();
  // expect YYYY-MM-DD
  const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  return isNaN(d.getTime()) ? null : d;
}
function ymd(d){
  const yy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}

/** CSV robust parser */
function parseCSVRows(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0; i<text.length; i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }
    if(!inQuotes && ch === ","){ row.push(cur); cur = ""; continue; }
    if(!inQuotes && ch === "\n"){
      row.push(cur); rows.push(row);
      row = []; cur = ""; continue;
    }
    if(ch === "\r") continue;
    cur += ch;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function toBool(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "true" || s === "1" || s === "y" || s === "yes" || s === "t");
}

/* =========================
   Screener parsing
   ========================= */
function parseAllSheet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  const iCode = idx("Code");
  if(iCode < 0) return [];

  const iName = idx("Name"), iMarket = idx("Market"), iDate = idx("Date");
  const iTrend = idx("Trend"), iPull = idx("Pullback"), iBreak = idx("Breakout");
  const iClose = idx("Close"), iVol = idx("Volume"), iTurn = idx("Turnover");
  const iRSI = idx("RSI14"), iStoch = idx("Stoch_K");

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;
    out.push({
      Code: code,
      Name: iName >= 0 ? String(r[iName] ?? "").trim() : "",
      Market: iMarket >= 0 ? String(r[iMarket] ?? "").trim() : "",
      Date: iDate >= 0 ? String(r[iDate] ?? "").trim() : "",

      Trend_Signal: iTrend >= 0 ? toBool(r[iTrend]) : false,
      Pullback_Signal: iPull >= 0 ? toBool(r[iPull]) : false,
      Breakout_Signal: iBreak >= 0 ? toBool(r[iBreak]) : false,

      Close: iClose >= 0 ? toNum(r[iClose]) : 0,
      Volume: iVol >= 0 ? toNum(r[iVol]) : 0,
      Turnover: iTurn >= 0 ? toNum(r[iTurn]) : 0,
      RSI14: iRSI >= 0 ? toNum(r[iRSI]) : 0,
      Stoch_K: iStoch >= 0 ? toNum(r[iStoch]) : 0
    });
  }
  return out;
}

function parseSignalSheetToSet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return new Set();
  const headers = rows[0].map(h => String(h).trim());
  const codeIdx = headers.findIndex(h => h === "Code");
  const iCode = codeIdx >= 0 ? codeIdx : 0;

  const set = new Set();
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(/^\d{6}$/.test(code)) set.add(code);
  }
  return set;
}

/* =========================
   Storage parsing
   ========================= */
function parseStorageSheet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  const iCode = idx("Code");
  if(iCode < 0) return [];

  const iName = idx("Name");
  const iMarket = idx("Market");
  const iDetect = idx("DetectDate");
  const iType = idx("Signal_Type");
  const iEntry = idx("EntryPrice");
  const iCloseToday = idx("Close_Today");
  const iReturn = idx("Return");
  const iD1 = idx("D1"), iD3 = idx("D3"), iD5 = idx("D5"), iD7 = idx("D7"), iD9 = idx("D9");
  const iPriceType = idx("Price_Type"); // ìˆìœ¼ë©´ ì½ê³ , ì—†ì–´ë„ ë¨

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;

    const detect = iDetect >= 0 ? String(r[iDetect] ?? "").trim() : "";
    const dt = parseDateStr(detect);
    if(!dt) continue;

    out.push({
      Code: code,
      Name: iName>=0 ? String(r[iName] ?? "").trim() : "",
      Market: iMarket>=0 ? String(r[iMarket] ?? "").trim() : "",
      DetectDate: ymd(dt),
      Signal_Type: iType>=0 ? String(r[iType] ?? "").trim() : "",
      EntryPrice: iEntry>=0 ? toNum(r[iEntry]) : 0,
      Close_Today: iCloseToday>=0 ? toNum(r[iCloseToday]) : 0,
      Return: iReturn>=0 ? toNum(r[iReturn]) : NaN,
      D1: iD1>=0 ? toNum(r[iD1]) : NaN,
      D3: iD3>=0 ? toNum(r[iD3]) : NaN,
      D5: iD5>=0 ? toNum(r[iD5]) : NaN,
      D7: iD7>=0 ? toNum(r[iD7]) : NaN,
      D9: iD9>=0 ? toNum(r[iD9]) : NaN,
      Price_Type: iPriceType>=0 ? String(r[iPriceType] ?? "").trim() : ""
    });
  }
  return out;
}

/* =========================
   FAV persistence
   ========================= */
function loadFavs(){
  try{
    const raw = localStorage.getItem(FAV_KEY);
    if(!raw) return new Set();
    const arr = JSON.parse(raw);
    return new Set((Array.isArray(arr) ? arr : []).map(pad6).filter(x => /^\d{6}$/.test(x)));
  }catch{
    return new Set();
  }
}
function saveFavs(){
  localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(selectedCodes)));
  $("statFav").textContent = String(selectedCodes.size);
}

/* =========================
   URLs + perf window persistence
   ========================= */
function loadUrls(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {...initialUrls};
    const obj = JSON.parse(raw);
    return { ...initialUrls, ...obj };
  }catch{
    return {...initialUrls};
  }
}
function saveUrls(){
  localStorage.setItem(LS_KEY, JSON.stringify(sheetUrls));
}

function loadPerfWindow(){
  try{
    const raw = localStorage.getItem(PERF_KEY);
    if(!raw) return 10;
    const obj = JSON.parse(raw);
    const w = Number(obj?.window);
    return [5,10,20].includes(w) ? w : 10;
  }catch{
    return 10;
  }
}
function savePerfWindow(){
  localStorage.setItem(PERF_KEY, JSON.stringify({ window: perfWindow }));
}

/* =========================
   HTTP fetch
   ========================= */
async function fetchText(url){
  const res = await fetch(bust(url), { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

/* =========================
   Screener rendering
   ========================= */
function updateStats(){
  $("statTotal").textContent = fmt(data.length);
  $("statTrend").textContent = fmt(data.filter(x=>x.Trend_Signal).length);
  $("statPullback").textContent = fmt(data.filter(x=>x.Pullback_Signal).length);
  $("statBreakout").textContent = fmt(data.filter(x=>x.Breakout_Signal).length);
  $("statFav").textContent = String(selectedCodes.size);
}
function renderEmpty(msg){
  tbody.innerHTML = `<tr><td colspan="8" class="center muted" style="padding:28px;">${escapeHtml(msg)}</td></tr>`;
  $("rowCount").textContent = "0";
}
function rsiColor(v){
  const x = Number(v)||0;
  if(x <= 30) return "#60a5fa";
  if(x >= 70) return "#fb7185";
  return "#94a3b8";
}
function stochColor(v){
  const x = Number(v)||0;
  if(x <= 20) return "#60a5fa";
  if(x >= 80) return "#fb7185";
  return "#94a3b8";
}
function getFiltered(){
  if(filterType === "TREND") return data.filter(x => x.Trend_Signal);
  if(filterType === "PULLBACK") return data.filter(x => x.Pullback_Signal);
  if(filterType === "BREAKOUT") return data.filter(x => x.Breakout_Signal);
  if(filterType === "FAV") return data.filter(x => selectedCodes.has(x.Code));
  return data;
}
function renderTable(){
  const rows = getFiltered();
  $("filterLabel").textContent = filterType;
  $("rowCount").textContent = String(rows.length);

  if(filterType === "FAV" && selectedCodes.size === 0){
    renderEmpty("ì°œí•œ ì¢…ëª©ì´ ì—†ì–´. ë¦¬ìŠ¤íŠ¸ì—ì„œ ë…¸ë€ ì ìœ¼ë¡œ ì°ì–´ì¤˜ â­");
    return;
  }
  if(!rows.length){
    renderEmpty("ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ì–´.");
    return;
  }

  const isWide = window.innerWidth >= 640;
  $("thClose").style.display = isWide ? "table-cell" : "none";
  $("thRSI").style.display = isWide ? "table-cell" : "none";
  $("thStoch").style.display = isWide ? "table-cell" : "none";

  tbody.innerHTML = rows.map((s) => {
    const isDetail = detailStock && detailStock.Code === s.Code;
    const isMulti = selectedCodes.has(s.Code);

    const turnoverEok = Math.round(toNum(s.Turnover) / 100000000);
    const sigs = [
      s.Breakout_Signal ? `<span class="sig red">ëŒíŒŒ</span>` : "",
      s.Pullback_Signal ? `<span class="sig yellow">ëˆŒë¦¼</span>` : "",
      s.Trend_Signal ? `<span class="sig green">ì¶”ì„¸</span>` : "",
    ].join("");

    return `
      <tr class="${isDetail ? "detailSelected" : ""}" data-code="${s.Code}">
        <td class="mono muted">${escapeHtml(s.Code)}</td>
        <td class="nameCell">${escapeHtml(s.Name || "")}</td>

        <td class="center">
          <span class="selectHit" data-action="select" data-code="${s.Code}">
            <span class="selectDot ${isMulti ? "on" : ""}"></span>
          </span>
        </td>

        <td class="numRight mono" style="display:${isWide ? "table-cell" : "none"}; color:#fb7185;">
          ${fmt(Math.round(toNum(s.Close)))}
        </td>

        <td class="numRight mono">${fmt(turnoverEok)}ì–µ</td>

        <td class="center mono" style="display:${isWide ? "table-cell" : "none"}; color:${rsiColor(s.RSI14)};">
          ${s.RSI14 ? Number(s.RSI14).toFixed(1) : "-"}
        </td>

        <td class="center mono" style="display:${isWide ? "table-cell" : "none"}; color:${stochColor(s.Stoch_K)};">
          ${s.Stoch_K ? Number(s.Stoch_K).toFixed(1) : "-"}
        </td>

        <td class="center"><div class="sigWrap">${sigs}</div></td>
      </tr>
    `;
  }).join("");
}

function openDetail(stock){
  detailStock = stock;

  $("perfDetailBox").style.display = "none"; // screener detail
  $("detailAnalysisBox").style.display = "block";
  $("detailMeta").textContent = `${stock.Market || "-"} | ${stock.Code}`;
  $("detailName").textContent = stock.Name || "-";
  $("detailClose").textContent = fmt(Math.round(toNum(stock.Close)));
  $("detailRSI").textContent = stock.RSI14 ? Number(stock.RSI14).toFixed(2) : "-";
  $("detailStoch").textContent = stock.Stoch_K ? Number(stock.Stoch_K).toFixed(2) : "-";
  $("detailVol").textContent = fmt(Math.round(toNum(stock.Volume)));

  const ul = $("detailSignals");
  ul.innerHTML = "";
  if(stock.Breakout_Signal) ul.innerHTML += `<li><b>ë°•ìŠ¤ê¶Œ ëŒíŒŒ:</b> ê±°ë˜ëŸ‰ + ëª¨ë©˜í…€ì„ ë™ë°˜í•œ ìƒë‹¨ ëŒíŒŒ ê°€ëŠ¥ì„±</li>`;
  if(stock.Pullback_Signal) ul.innerHTML += `<li><b>ëˆŒë¦¼ëª©:</b> ìƒìŠ¹ ì¶”ì„¸ ì¤‘ ì¡°ì • ì´í›„ ì¬ì‹œë™ ê°€ëŠ¥ì„±</li>`;
  if(stock.Trend_Signal) ul.innerHTML += `<li><b>ì¶”ì„¸ ì¶”ì¢…:</b> ìƒìŠ¹ ì¶”ì„¸ ì§€ì† + ê±°ë˜ëŸ‰ í™•ëŒ€ ê°€ëŠ¥ì„±</li>`;
  if(!ul.innerHTML) ul.innerHTML = `<li class="muted">ì‹ í˜¸ ì •ë³´ ì—†ìŒ</li>`;

  const eok = Math.round(toNum(stock.Turnover) / 100000000);
  $("detailFoot").innerHTML = `ê¸°ì¤€ì¼: ${escapeHtml(stock.Date || "-")}<br/>ê±°ë˜ëŒ€ê¸ˆ: ${fmt(eok)}ì–µì›`;

  rightPane.classList.add("open");

  const frame = document.getElementById("tvFrame");
  if(frame){
    frame.src =
      "https://www.tradingview.com/widgetembed/?" +
      "symbol=KRX:" + stock.Code +
      "&interval=D" +
      "&theme=dark" +
      "&hidesidetoolbar=1" +
      "&hidetoptoolbar=1";
  }
}
function closeDetail(){
  rightPane.classList.remove("open");
  detailStock = null;
  perfSelectedCode = null;
}
function toggleDetailByCode(code){
  const stock = data.find(x => x.Code === code);
  if(!stock) return;
  if(detailStock && detailStock.Code === code) closeDetail();
  else openDetail(stock);
}
function toggleSelect(code){
  if(selectedCodes.has(code)) selectedCodes.delete(code);
  else selectedCodes.add(code);
  saveFavs();
  renderTable();
}

/* =========================
   Performance computations
   ========================= */
function lastNTradingDaysFromStorage(rows, n){
  const dates = Array.from(new Set(rows.map(r => r.DetectDate))).filter(Boolean);
  dates.sort((a,b)=> (a<b?1:-1)); // desc
  return dates.slice(0, n);
}
function filterStorageWindow(){
  if(!storageRows.length){
    storageFiltered = [];
    return;
  }
  const dates = lastNTradingDaysFromStorage(storageRows, perfWindow);
  const dateSet = new Set(dates);
  storageFiltered = storageRows.filter(r => dateSet.has(r.DetectDate));
}

function median(arr){
  const a = arr.filter(x=>Number.isFinite(x)).slice().sort((x,y)=>x-y);
  if(!a.length) return NaN;
  const mid = Math.floor(a.length/2);
  return a.length%2 ? a[mid] : (a[mid-1]+a[mid])/2;
}
function avg(arr){
  const a = arr.filter(x=>Number.isFinite(x));
  if(!a.length) return NaN;
  return a.reduce((s,v)=>s+v,0)/a.length;
}
function winRate(arr){
  const a = arr.filter(x=>Number.isFinite(x));
  if(!a.length) return NaN;
  const w = a.filter(x=>x>0).length;
  return w/a.length;
}
function scoreForGroup(rows){
  // Score = 0.40*Avg(D1) + 0.30*Avg(D3) + 0.20*Avg(D5) + 0.10*Avg(D9)
  const a1 = avg(rows.map(r=>r.D1));
  const a3 = avg(rows.map(r=>r.D3));
  const a5 = avg(rows.map(r=>r.D5));
  const a9 = avg(rows.map(r=>r.D9));
  const base = 0.40*(Number.isFinite(a1)?a1:0) + 0.30*(Number.isFinite(a3)?a3:0) + 0.20*(Number.isFinite(a5)?a5:0) + 0.10*(Number.isFinite(a9)?a9:0);
  const n = rows.length;
  const penalty = n < 5 ? 0.7 : (n < 10 ? 0.85 : 1.0);
  return base * penalty;
}

function groupBySignalType(rows){
  const groups = new Map();
  for(const r of rows){
    const key = (r.Signal_Type || "").trim() || "UNKNOWN";
    if(!groups.has(key)) groups.set(key, []);
    groups.get(key).push(r);
  }
  return groups;
}

function perfBuildScoreboard(){
  const groups = groupBySignalType(storageFiltered);
  const out = [];
  for(const [type, rows] of groups.entries()){
    const retArr = rows.map(r=>r.Return);
    const row = {
      Signal_Type: type,
      N: rows.length,
      WinRate: winRate(retArr),
      AvgReturn: avg(retArr),
      MedReturn: median(retArr),
      AvgD1: avg(rows.map(r=>r.D1)),
      AvgD3: avg(rows.map(r=>r.D3)),
      AvgD5: avg(rows.map(r=>r.D5)),
      AvgD7: avg(rows.map(r=>r.D7)),
      AvgD9: avg(rows.map(r=>r.D9)),
      Score: scoreForGroup(rows),
    };
    out.push(row);
  }

  // sort
  const sortKey = $("perfSortSel")?.value || "SCORE";
  out.sort((a,b)=>{
    const dir = -1; // desc
    const pick = (o)=>{
      if(sortKey==="SCORE") return o.Score;
      if(sortKey==="WIN") return o.WinRate;
      if(sortKey==="N") return o.N;
      if(sortKey==="D1") return o.AvgD1;
      if(sortKey==="D3") return o.AvgD3;
      if(sortKey==="D5") return o.AvgD5;
      if(sortKey==="D7") return o.AvgD7;
      if(sortKey==="D9") return o.AvgD9;
      if(sortKey==="RET") return o.AvgReturn;
      return o.Score;
    }
    const x = pick(a), y = pick(b);
    return (y - x) * dir;
  });
  return out;
}

function perfApplyTypeFilter(rows){
  const sel = $("perfTypeSel")?.value || "ALL";
  if(sel === "ALL") return rows;

  // Scoreboard rows use Signal_Type; others also.
  return rows.filter(r => (r.Signal_Type || "") === sel);
}

function perfBuildTopBottom(isTop){
  // build row list at "signal hit" level, optionally filter by Signal_Type
  let rows = storageFiltered.slice();

  const sel = $("perfTypeSel")?.value || "ALL";
  if(sel !== "ALL"){
    rows = rows.filter(r => (r.Signal_Type||"") === sel);
  }

  const sortKey = $("perfSortSel")?.value || "RET";
  const keyFn = (r)=>{
    if(sortKey==="D1") return r.D1;
    if(sortKey==="D3") return r.D3;
    if(sortKey==="D5") return r.D5;
    if(sortKey==="D7") return r.D7;
    if(sortKey==="D9") return r.D9;
    return r.Return;
  };

  rows.sort((a,b)=>{
    const x = keyFn(a), y = keyFn(b);
    const xx = Number.isFinite(x) ? x : -999;
    const yy = Number.isFinite(y) ? y : -999;
    return isTop ? (yy-xx) : (xx-yy);
  });

  return rows.slice(0, 60);
}

function perfBuildHits(){
  // group by Code: count hits and show last signal types within window
  let rows = storageFiltered.slice();
  const sel = $("perfTypeSel")?.value || "ALL";
  if(sel !== "ALL"){
    rows = rows.filter(r => (r.Signal_Type||"") === sel);
  }

  const by = new Map();
  for(const r of rows){
    if(!by.has(r.Code)) by.set(r.Code, []);
    by.get(r.Code).push(r);
  }

  const out = [];
  for(const [code, list] of by.entries()){
    list.sort((a,b)=> (a.DetectDate<b.DetectDate?1:-1));
    const name = list[0]?.Name || "";
    const market = list[0]?.Market || "";
    const types = Array.from(new Set(list.map(x=>x.Signal_Type).filter(Boolean))).slice(0,6);
    const lastDate = list[0]?.DetectDate || "";
    const best = Math.max(...list.map(x=>Number.isFinite(x.Return)?x.Return:-999));
    const worst = Math.min(...list.map(x=>Number.isFinite(x.Return)?x.Return:999));
    out.push({
      Code: code,
      Name: name,
      Market: market,
      Hits: list.length,
      LastDetectDate: lastDate,
      Types: types,
      BestReturn: (best===-999?NaN:best),
      WorstReturn: (worst===999?NaN:worst)
    });
  }

  // sort by hits desc then last date desc
  out.sort((a,b)=>{
    if(b.Hits !== a.Hits) return b.Hits - a.Hits;
    return (a.LastDetectDate < b.LastDetectDate) ? 1 : -1;
  });
  return out;
}

function perfUpdateKpis(){
  if(!storageFiltered.length){
    perfKpis.innerHTML = `<span class="chip">Storage ë°ì´í„° ì—†ìŒ</span>`;
    return;
  }
  const rets = storageFiltered.map(r=>r.Return).filter(x=>Number.isFinite(x));
  const avgR = avg(rets);
  const medR = median(rets);
  const wr = winRate(rets);
  const n = storageFiltered.length;

  // best/worst item
  let best = null, worst = null;
  for(const r of storageFiltered){
    if(!Number.isFinite(r.Return)) continue;
    if(!best || r.Return > best.Return) best = r;
    if(!worst || r.Return < worst.Return) worst = r;
  }

  perfKpis.innerHTML = `
    <span class="chip">ìµœê·¼ <b>${perfWindow}</b>ê±°ë˜ì¼</span>
    <span class="chip">í‘œë³¸ <b>${fmt(n)}</b></span>
    <span class="chip">í‰ê·  <b style="color:${avgR>=0?'#a7f3d0':'#fecaca'}">${fmtPct(avgR)}</b></span>
    <span class="chip">ì¤‘ì•™ê°’ <b style="color:${medR>=0?'#a7f3d0':'#fecaca'}">${fmtPct(medR)}</b></span>
    <span class="chip">ìŠ¹ë¥  <b>${Number.isFinite(wr)?(wr*100).toFixed(1)+'%':'-'}</b></span>
    <span class="chip">Best <b style="color:#a7f3d0">${best ? (escapeHtml(best.Name||best.Code)+' '+fmtPct(best.Return)) : '-'}</b></span>
    <span class="chip">Worst <b style="color:#fecaca">${worst ? (escapeHtml(worst.Name||worst.Code)+' '+fmtPct(worst.Return)) : '-'}</b></span>
  `;
}

function sigTypeBadge(type){
  const t = String(type||"").trim();
  if(!t) return `<span class="sig blue">-</span>`;
  const parts = t.split("+").filter(Boolean);
  const cls = parts.length >= 3 ? "red" : (parts.length === 2 ? "yellow" : "green");
  return `<span class="sig ${cls}">${escapeHtml(t)}</span>`;
}

function perfRender(){
  $("perfWindowTxt").textContent = String(perfWindow);

  if(!storageRows.length){
    $("perfRowCount").textContent = "0";
    perfThead.innerHTML = `<tr><th>ì•ˆë‚´</th></tr>`;
    perfTbody.innerHTML = `<tr><td class="center muted" style="padding:28px;">Storage CSV URLì„ í™•ì¸í•´ì¤˜. (ì„¤ì • âš™ï¸ â†’ STORAGE)</td></tr>`;
    perfUpdateKpis();
    return;
  }

  filterStorageWindow();
  perfUpdateKpis();

  if(!storageFiltered.length){
    $("perfRowCount").textContent = "0";
    perfThead.innerHTML = `<tr><th>ì•ˆë‚´</th></tr>`;
    perfTbody.innerHTML = `<tr><td class="center muted" style="padding:28px;">ìµœê·¼ ${perfWindow}ê±°ë˜ì¼ì— í•´ë‹¹í•˜ëŠ” Storage ë°ì´í„°ê°€ ì—†ì–´.</td></tr>`;
    return;
  }

  // mode switch
  if(perfMode === "INFO"){
    $("perfTitle").textContent = "ì‹ ë¢°ë„ ì ìˆ˜ ì‚°ì‹";
    $("perfRowCount").textContent = "1";
    perfThead.innerHTML = `<tr><th>í•­ëª©</th><th>ë‚´ìš©</th></tr>`;
    perfTbody.innerHTML = `
      <tr>
        <td class="mono">Score</td>
        <td>
          0.40Â·Avg(D1) + 0.30Â·Avg(D3) + 0.20Â·Avg(D5) + 0.10Â·Avg(D9)<br/>
          <span class="muted">í‘œë³¸ íŒ¨ë„í‹°: n&lt;5 â†’ Ã—0.70, n&lt;10 â†’ Ã—0.85</span>
        </td>
      </tr>
      <tr>
        <td class="mono">í•´ì„</td>
        <td>
          <b>Score</b>ê°€ ë†’ì„ìˆ˜ë¡ ìµœê·¼ ì„±ëŠ¥ì´ ì¢‹ì•˜ë˜ ì‹ í˜¸ ì¡°í•©.<br/>
          <b>ìŠ¹ë¥ </b>(Return&gt;0)ê³¼ <b>í‘œë³¸ìˆ˜</b>(N)ë¥¼ ê°™ì´ ë³´ê³  íŒë‹¨í•˜ë©´ ì•ˆì •ì ì´ì•¼.
        </td>
      </tr>
    `;
    return;
  }

  if(perfMode === "SCOREBOARD"){
    $("perfTitle").textContent = "ì‹ í˜¸ ì‹ ë¢°ë„ ë³´ë“œ";
    let rows = perfBuildScoreboard();
    rows = perfApplyTypeFilter(rows);

    $("perfRowCount").textContent = String(rows.length);

    perfThead.innerHTML = `
      <tr>
        <th>Signal_Type</th>
        <th class="numRight">N</th>
        <th class="numRight">ìŠ¹ë¥ </th>
        <th class="numRight">Score</th>
        <th class="numRight">Avg Ret</th>
        <th class="numRight">Med Ret</th>
        <th class="numRight">D1</th>
        <th class="numRight">D3</th>
        <th class="numRight">D5</th>
        <th class="numRight">D7</th>
        <th class="numRight">D9</th>
      </tr>
    `;

    perfTbody.innerHTML = rows.map(r=>{
      const cScore = (r.Score>=0) ? "#a7f3d0" : "#fecaca";
      const cRet = (r.AvgReturn>=0) ? "#a7f3d0" : "#fecaca";
      return `
        <tr>
          <td>${sigTypeBadge(r.Signal_Type)}</td>
          <td class="numRight mono">${fmt(r.N)}</td>
          <td class="numRight mono">${Number.isFinite(r.WinRate) ? (r.WinRate*100).toFixed(1)+"%" : "-"}</td>
          <td class="numRight mono" style="color:${cScore}">${fmtPct(r.Score)}</td>
          <td class="numRight mono" style="color:${cRet}">${fmtPct(r.AvgReturn)}</td>
          <td class="numRight mono">${fmtPct(r.MedReturn)}</td>
          <td class="numRight mono">${fmtPct(r.AvgD1)}</td>
          <td class="numRight mono">${fmtPct(r.AvgD3)}</td>
          <td class="numRight mono">${fmtPct(r.AvgD5)}</td>
          <td class="numRight mono">${fmtPct(r.AvgD7)}</td>
          <td class="numRight mono">${fmtPct(r.AvgD9)}</td>
        </tr>
      `;
    }).join("");
    return;
  }

  if(perfMode === "TOP" || perfMode === "BOTTOM"){
    const isTop = perfMode === "TOP";
    $("perfTitle").textContent = isTop ? "TOP ì„±ê³¼ ë¦¬ìŠ¤íŠ¸" : "Worst ì„±ê³¼ ë¦¬ìŠ¤íŠ¸";
    const rows = perfBuildTopBottom(isTop);
    $("perfRowCount").textContent = String(rows.length);

    const sortKey = $("perfSortSel")?.value || "RET";
    const label = (k)=> k==="RET" ? "Return" : k;

    perfThead.innerHTML = `
      <tr>
        <th>DetectDate</th>
        <th>Code</th>
        <th>Name</th>
        <th>Signal_Type</th>
        <th class="numRight">Entry</th>
        <th class="numRight">Close</th>
        <th class="numRight">${label(sortKey)}</th>
        <th class="numRight">D1</th>
        <th class="numRight">D3</th>
        <th class="numRight">D5</th>
        <th class="numRight">D7</th>
        <th class="numRight">D9</th>
      </tr>
    `;

    perfTbody.innerHTML = rows.map(r=>{
      const pick = (k)=>{
        if(k==="D1") return r.D1;
        if(k==="D3") return r.D3;
        if(k==="D5") return r.D5;
        if(k==="D7") return r.D7;
        if(k==="D9") return r.D9;
        return r.Return;
      };
      const v = pick(sortKey);
      const col = Number.isFinite(v) ? (v>=0 ? "#a7f3d0" : "#fecaca") : "#94a3b8";
      return `
        <tr data-perf-code="${r.Code}">
          <td class="mono muted">${escapeHtml(r.DetectDate)}</td>
          <td class="mono" style="color:#bfdbfe;">${escapeHtml(r.Code)}</td>
          <td class="nameCell">${escapeHtml(r.Name||"")}</td>
          <td>${sigTypeBadge(r.Signal_Type)}</td>
          <td class="numRight mono">${fmt(Math.round(r.EntryPrice||0))}</td>
          <td class="numRight mono">${fmt(Math.round(r.Close_Today||0))}</td>
          <td class="numRight mono" style="color:${col}; font-weight:950;">${fmtPct(v)}</td>
          <td class="numRight mono">${fmtPct(r.D1)}</td>
          <td class="numRight mono">${fmtPct(r.D3)}</td>
          <td class="numRight mono">${fmtPct(r.D5)}</td>
          <td class="numRight mono">${fmtPct(r.D7)}</td>
          <td class="numRight mono">${fmtPct(r.D9)}</td>
        </tr>
      `;
    }).join("");
    return;
  }

  if(perfMode === "HITS"){
    $("perfTitle").textContent = "ì¢…ëª© íˆìŠ¤í† ë¦¬(ì¤‘ë³µ í¬ì°©)";
    const rows = perfBuildHits();
    $("perfRowCount").textContent = String(rows.length);

    perfThead.innerHTML = `
      <tr>
        <th>Code</th>
        <th>Name</th>
        <th class="numRight">Hits</th>
        <th>Last</th>
        <th>Types</th>
        <th class="numRight">Best Ret</th>
        <th class="numRight">Worst Ret</th>
      </tr>
    `;
    perfTbody.innerHTML = rows.map(r=>{
      const bestCol = Number.isFinite(r.BestReturn) ? (r.BestReturn>=0?"#a7f3d0":"#fecaca") : "#94a3b8";
      const worstCol = Number.isFinite(r.WorstReturn) ? (r.WorstReturn>=0?"#a7f3d0":"#fecaca") : "#94a3b8";
      const types = (r.Types||[]).map(sigTypeBadge).join(" ");
      return `
        <tr data-perf-code="${r.Code}">
          <td class="mono" style="color:#bfdbfe;">${escapeHtml(r.Code)}</td>
          <td class="nameCell">${escapeHtml(r.Name||"")}</td>
          <td class="numRight mono">${fmt(r.Hits)}</td>
          <td class="mono muted">${escapeHtml(r.LastDetectDate||"-")}</td>
          <td>${types || "-"}</td>
          <td class="numRight mono" style="color:${bestCol}; font-weight:950;">${fmtPct(r.BestReturn)}</td>
          <td class="numRight mono" style="color:${worstCol}; font-weight:950;">${fmtPct(r.WorstReturn)}</td>
        </tr>
      `;
    }).join("");
    return;
  }
}

function perfShowCodeHistory(code){
  const c = String(code||"").trim();
  if(!/^\d{6}$/.test(c)) return;

  perfSelectedCode = c;

  const list = storageFiltered.filter(r => r.Code === c).slice().sort((a,b)=> (a.DetectDate<b.DetectDate?1:-1));
  if(!list.length){
    $("perfDetailBox").style.display = "none";
    return;
  }

  const name = list[0].Name || c;
  const lines = list.map(r=>{
    const retCol = Number.isFinite(r.Return) ? (r.Return>=0 ? "#a7f3d0" : "#fecaca") : "#94a3b8";
    return `
      <div style="padding:8px 0; border-bottom:1px solid rgba(34,48,83,.55);">
        <div class="muted mono">${escapeHtml(r.DetectDate)} Â· ${sigTypeBadge(r.Signal_Type)}</div>
        <div style="margin-top:6px;">
          Return <b style="color:${retCol}">${fmtPct(r.Return)}</b>
          <span class="muted"> | D1 ${fmtPct(r.D1)} Â· D3 ${fmtPct(r.D3)} Â· D5 ${fmtPct(r.D5)} Â· D7 ${fmtPct(r.D7)} Â· D9 ${fmtPct(r.D9)}</span>
        </div>
      </div>
    `;
  }).join("");

  $("perfDetailBox").style.display = "block";
  $("detailAnalysisBox").style.display = "none";
  $("detailMeta").textContent = `Storage | ${c}`;
  $("detailName").textContent = name;
  $("detailClose").textContent = fmt(Math.round(list[0].Close_Today||0));
  $("detailRSI").textContent = "-";
  $("detailStoch").textContent = "-";
  $("detailVol").textContent = "-";
  $("detailFoot").innerHTML = `ìµœê·¼ ${perfWindow}ê±°ë˜ì¼ í¬ì°© íˆìŠ¤í† ë¦¬`;

  $("perfDetailBody").innerHTML = lines;

  // chart
  const frame = document.getElementById("tvFrame");
  if(frame){
    frame.src =
      "https://www.tradingview.com/widgetembed/?" +
      "symbol=KRX:" + c +
      "&interval=D" +
      "&theme=dark" +
      "&hidesidetoolbar=1" +
      "&hidetoptoolbar=1";
  }

  rightPane.classList.add("open");
}

/* =========================
   Fetch all
   ========================= */
async function fetchData(){
  if(!sheetUrls.ALL){
    openSettings(true);
    showError("ALL ì‹œíŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•´ì¤˜.");
    return;
  }

  hideError();
  setStatus("warn","ë¡œë”©ì¤‘...");
  $("refreshBtn").disabled = true;
  $("refreshIcon").innerHTML = '<span class="spin"></span>';

  detailStock = null;
  closeDetail();

  try{
    const tasks = [
      fetchText(sheetUrls.ALL),
      sheetUrls.TREND ? fetchText(sheetUrls.TREND).catch(()=>null) : Promise.resolve(null),
      sheetUrls.PULLBACK ? fetchText(sheetUrls.PULLBACK).catch(()=>null) : Promise.resolve(null),
      sheetUrls.BREAKOUT ? fetchText(sheetUrls.BREAKOUT).catch(()=>null) : Promise.resolve(null),
      sheetUrls.STORAGE ? fetchText(sheetUrls.STORAGE).catch(()=>null) : Promise.resolve(null),
    ];

    const [allText, trendText, pullText, breakText, storageText] = await Promise.all(tasks);

    // Screener
    const allData = parseAllSheet(allText);
    if(!allData.length) throw new Error("ALL ì‹œíŠ¸ íŒŒì‹± ì‹¤íŒ¨. í—¤ë”/ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì¤˜.");

    const trendSet = trendText ? parseSignalSheetToSet(trendText) : null;
    const pullSet  = pullText  ? parseSignalSheetToSet(pullText)  : null;
    const breakSet = breakText ? parseSignalSheetToSet(breakText) : null;

    data = allData.map(s => {
      if(trendSet) s.Trend_Signal = trendSet.has(s.Code) || s.Trend_Signal;
      if(pullSet)  s.Pullback_Signal = pullSet.has(s.Code) || s.Pullback_Signal;
      if(breakSet) s.Breakout_Signal = breakSet.has(s.Code) || s.Breakout_Signal;
      return s;
    });

    data.sort((a,b) => {
      if(b.Breakout_Signal !== a.Breakout_Signal) return b.Breakout_Signal ? 1 : -1;
      if(b.Pullback_Signal !== a.Pullback_Signal) return b.Pullback_Signal ? 1 : -1;
      if(b.Trend_Signal !== a.Trend_Signal) return b.Trend_Signal ? 1 : -1;
      return toNum(b.Turnover) - toNum(a.Turnover);
    });

    updateStats();
    renderTable();

    // Storage
    if(storageText){
      storageRows = parseStorageSheet(storageText);

      // normalize + safety
      storageRows = storageRows.map(r => ({
        ...r,
        Code: pad6(r.Code),
        DetectDate: String(r.DetectDate||"").trim(),
        Signal_Type: String(r.Signal_Type||"").trim(),
      })).filter(r => /^\d{6}$/.test(r.Code) && /^\d{4}-\d{2}-\d{2}$/.test(r.DetectDate));

      // sort for stability
      storageRows.sort((a,b)=>{
        if(a.DetectDate !== b.DetectDate) return a.DetectDate < b.DetectDate ? 1 : -1;
        return a.Code < b.Code ? 1 : -1;
      });
    } else {
      storageRows = [];
    }

    perfRender();

    lastUpdatedPill.textContent = "ê°±ì‹ : " + new Date().toLocaleTimeString("ko-KR");
    setStatus("ok","ìµœì‹  ë°˜ì˜");
    openSettings(false);

  }catch(e){
    data = [];
    storageRows = [];
    updateStats();
    renderEmpty("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + (e.message || String(e)));
    perfRender();

    setStatus("err","ì‹¤íŒ¨");
    showError(e.message || String(e));
  }finally{
    $("refreshBtn").disabled = false;
    $("refreshIcon").textContent = "â†»";
    saveFavs();
  }
}

/* =========================
   Tabs / settings
   ========================= */
function openSettings(open){
  settingsPanel.classList.toggle("open", !!open);
}

function switchTab(which){
  const isPerf = which === "PERF";
  $("tabScreener").classList.toggle("active", !isPerf);
  $("tabPerformance").classList.toggle("active", isPerf);

  viewScreener.style.display = isPerf ? "none" : "block";
  viewPerformance.style.display = isPerf ? "block" : "none";
  perfKpis.style.display = isPerf ? "flex" : "none";

  closeDetail();
  if(isPerf){
    perfRender();
  }else{
    renderTable();
  }
}

/* =========================
   Bind events
   ========================= */
function bind(){
  // settings open/close
  $("settingsBtn").addEventListener("click", () => openSettings(!settingsPanel.classList.contains("open")));
  $("settingsCloseBtn").addEventListener("click", () => openSettings(false));

  // refresh
  $("refreshBtn").addEventListener("click", fetchData);

  // save & refresh
  $("saveAndRefreshBtn").addEventListener("click", () => {
    sheetUrls = {
      ALL: $("urlALL").value.trim(),
      TREND: $("urlTREND").value.trim(),
      PULLBACK: $("urlPULLBACK").value.trim(),
      BREAKOUT: $("urlBREAKOUT").value.trim(),
      STORAGE: $("urlSTORAGE").value.trim(),
    };
    const w = Number($("perfWindowSel").value);
    if([5,10,20].includes(w)) perfWindow = w;
    savePerfWindow();

    saveUrls();
    fetchData();
  });

  // perf window select (in settings)
  $("perfWindowSel").addEventListener("change", () => {
    const w = Number($("perfWindowSel").value);
    if([5,10,20].includes(w)){
      perfWindow = w;
      savePerfWindow();
      perfRender();
    }
  });

  // tabs
  $("tabScreener").addEventListener("click", ()=> switchTab("SCR"));
  $("tabPerformance").addEventListener("click", ()=> switchTab("PERF"));

  // screener filter cards
  document.querySelectorAll(".card[data-filter]").forEach(el => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".card[data-filter]").forEach(c => c.classList.remove("active"));
      el.classList.add("active");
      filterType = el.dataset.filter;
      closeDetail();
      renderTable();
    });
  });

  // perf cards
  document.querySelectorAll("#perfCards .card[data-perf]").forEach(el=>{
    el.addEventListener("click", ()=>{
      document.querySelectorAll("#perfCards .card[data-perf]").forEach(c=>c.classList.remove("active"));
      el.classList.add("active");
      perfMode = el.dataset.perf;
      closeDetail();
      perfRender();
    });
  });

  // perf selects
  $("perfSortSel").addEventListener("change", ()=> perfRender());
  $("perfTypeSel").addEventListener("change", ()=> perfRender());

  // screener table click
  tbody.addEventListener("click", (e) => {
    const t = e.target;

    const hit = t.closest("[data-action='select']");
    if(hit && hit.dataset && hit.dataset.code){
      e.stopPropagation();
      toggleSelect(hit.dataset.code);
      return;
    }

    const tr = t.closest("tr[data-code]");
    if(!tr) return;

    toggleDetailByCode(tr.dataset.code);
    renderTable();
  });

  // perf table click: show history (right panel)
  perfTbody.addEventListener("click", (e)=>{
    const tr = e.target.closest("tr[data-perf-code]");
    if(!tr) return;
    const code = tr.getAttribute("data-perf-code");
    if(!code) return;
    perfShowCodeHistory(code);
  });

  // detail close
  $("detailCloseBtn").addEventListener("click", () => {
    closeDetail();
    if(viewPerformance.style.display !== "none") perfRender();
    else renderTable();
  });

  window.addEventListener("resize", () => {
    if(viewPerformance.style.display !== "none") perfRender();
    else renderTable();
  });

  // fill settings inputs
  $("urlALL").value = sheetUrls.ALL;
  $("urlTREND").value = sheetUrls.TREND;
  $("urlPULLBACK").value = sheetUrls.PULLBACK;
  $("urlBREAKOUT").value = sheetUrls.BREAKOUT;
  $("urlSTORAGE").value = sheetUrls.STORAGE;

  $("perfWindowSel").value = String(perfWindow);

  saveFavs();
}

bind();
fetchData();
</script>
</body>
</html>
