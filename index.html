<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <script>
    if (!sessionStorage.getItem("auth")) {
      const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if (input !== "fire") {
        document.body.innerHTML = "<h2 style='padding:20px'>ì ‘ê·¼ ë¶ˆê°€</h2>";
        throw new Error("Unauthorized");
      }
      sessionStorage.setItem("auth", "true");
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>YJ ìŠ¤í¬ë¦¬ë„ˆ (Single-file)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{
      --bg:#0f172a; --panel:#111c33; --panel2:#0b1224;
      --line:#223053; --txt:#e5e7eb; --muted:#94a3b8;
      --green:#22c55e; --yellow:#eab308; --red:#ef4444;
      --radius:14px; --tap: 44px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      height: 100dvh; overflow:hidden; /* ì•±í˜• UI ìœ ì§€ */
    }

    header{ padding-top: env(safe-area-inset-top); }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 14px; background:var(--panel); border-bottom:1px solid var(--line);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:28px; height:28px; border-radius:10px;
      background:linear-gradient(135deg, #60a5fa, #22c55e);
      box-shadow:0 10px 30px rgba(59,130,246,.15);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sub{ color:var(--muted); font-size:12px; margin-left:6px; font-weight:500;}

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .iconbtn{
      width:var(--tap); height:var(--tap); border-radius:12px;
      border:1px solid var(--line); background:transparent; color:var(--muted);
      display:grid; place-items:center; cursor:pointer; font-size:16px;
    }
    .btn{
      min-height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--txt);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:800; font-size:13px;
      display:flex; align-items:center; gap:8px;
    }
    .btn.primary{ background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.45); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(34,197,94,.4); color:#a7f3d0; background:rgba(34,197,94,.10);}
    .pill.err{ border-color: rgba(239,68,68,.45); color:#fecaca; background:rgba(239,68,68,.10);}
    .pill.warn{ border-color: rgba(234,179,8,.45); color:#fde68a; background:rgba(234,179,8,.10);}

    /* âœ… íƒ­ */
    .tabbar{
      display:flex; gap:10px; padding:12px 14px;
      background: rgba(255,255,255,.02);
      border-bottom:1px solid var(--line);
    }
    .tabbtn{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      color:var(--txt); padding:10px 14px; border-radius:14px;
      font-weight:900; cursor:pointer; display:flex; align-items:center; gap:10px;
    }
    .tabbtn.active{ outline:1px solid rgba(59,130,246,.55); background: rgba(59,130,246,.12); }
    .tabbtn .muted{ font-weight:800; }

    /* âœ… ì „ì²´ ì•± ë ˆì´ì•„ì›ƒ */
    .app{
      display:flex;
      flex-direction:column;
      height: calc(100dvh - 58px - env(safe-area-inset-top));
      min-height:0;              /* âœ… iOS ìŠ¤í¬ë¡¤ í•µì‹¬ */
      overflow:hidden;
    }

    /* settings panel */
    .settings{
      display:none;
      position:absolute;
      top: calc(58px + env(safe-area-inset-top));
      left:0; right:0;
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding:14px;
      z-index:60;
    }
    .settings.open{ display:block; }
    .settings .inner{ max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:var(--panel2); color:var(--txt); outline:none;
    }
    .grid2{ display:grid; grid-template-columns: 110px 1fr; gap:10px; align-items:center; }
    @media (max-width: 520px){ .grid2{ grid-template-columns:1fr; } }
    .errorbox{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12);
      padding:12px; border-radius:12px; color:#fecaca; font-size:12px;
    }

    /* âœ… íƒ­ í˜ì´ì§€(í¬ì°©/ì„±ê³¼) */
    .pageWrap{
      flex:1;
      min-height:0;           /* âœ… iOS ìŠ¤í¬ë¡¤ í•µì‹¬ */
      overflow:hidden;
      position:relative;
    }
    .page{
      position:absolute; inset:0;
      display:none;
      min-height:0;
    }
    .page.active{ display:block; }

    /* âœ… í¬ì°© íƒ­(ê¸°ì¡´ êµ¬ì¡° ìœ ì§€) */
    .wrap{
      display:flex;
      height: 100%;
      min-height:0;
    }

    .left{
      flex:1;
      display:flex; flex-direction:column;
      padding:14px; gap:14px;
      min-width:0;
      min-height:0;          /* âœ… ì¤‘ìš” */
      overflow:hidden;
    }
    .right{
      width:380px; border-left:1px solid var(--line); background:var(--panel);
      padding:14px;
      overflow:auto; -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      display:none; min-height:0;
    }
    .right.open{ display:block; }
    @media (max-width:1024px){
      .right{
        position:absolute; inset: 0;
        width:auto; z-index:55; display:none;
        border-left:none; border-top:1px solid var(--line);
        border-radius:16px 16px 0 0;
      }
      .right.open{ display:block; }
    }

    /* stat cards */
    .stats{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:12px;
      min-height:0;
    }
    @media (max-width: 980px){
      .stats{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .stats{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .card{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      padding:12px; cursor:pointer; min-height:80px;
      transition: transform .05s ease, background .15s ease;
    }
    .card:active{ transform: translateY(1px); }
    .card.active{ outline:1px solid rgba(148,163,184,.5); background: rgba(148,163,184,.08); }
    .card .t{
      color:var(--muted); font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .badgeIcon{
      width:30px; height:30px; border-radius:12px; display:grid; place-items:center;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--muted);
    }
    .card .n{ font-size:22px; font-weight:950; margin-top:6px; }

    /* table panel */
    .panel{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      overflow:hidden; display:flex; flex-direction:column;
      min-height:0;
      flex:1;                 /* âœ… ë‚¨ì€ ê³µê°„ì„ ê½‰ ì±„ì›€ = í…Œì´ë¸” ìŠ¤í¬ë¡¤ í™œì„± */
      box-shadow:0 12px 40px rgba(0,0,0,.20);
    }
    .panelHead{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
      flex:0 0 auto;
    }
    .panelHead h2{ margin:0; font-size:14px; }
    .panelHead .count{
      font-size:12px; color:var(--muted);
      padding:3px 10px; border-radius:999px; border:1px solid var(--line); white-space:nowrap;
    }

    .tableScroll{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      touch-action: pan-y;     /* âœ… iOS í„°ì¹˜ ìŠ¤í¬ë¡¤ ì•ˆì •í™” */
      flex:1; min-height:0;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,23,42,.92);
      backdrop-filter: blur(6px);
      color: var(--muted);
      font-size:11px;
      text-transform: uppercase;
      letter-spacing: .04em;
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(34,48,83,.55);
      padding:12px 10px;
      vertical-align:middle;
      white-space: nowrap;
    }
    tbody tr:hover{ background: rgba(148,163,184,.07); }
    tbody tr.detailSelected{ background: rgba(59,130,246,.14); border-left:2px solid rgba(59,130,246,.85); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }
    .numRight{ text-align:right; }
    .center{ text-align:center; }

    td.nameCell{
      max-width: 44vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .selectDot{
      width:18px; height:18px;
      border-radius:999px; border:2px solid var(--yellow);
      display:inline-block; background:transparent; vertical-align:middle;
    }
    .selectDot.on{ background: var(--yellow); border-color: var(--yellow); }
    .selectHit{
      display:inline-flex; align-items:center; justify-content:center;
      width:var(--tap); height:var(--tap); border-radius:12px;
    }

    .sigWrap{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
    .sig{ font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid; font-weight:900; line-height:1.4; }
    .sig.red{ color:#fecaca; background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.30); }
    .sig.yellow{ color:#fde68a; background:rgba(234,179,8,.15); border-color:rgba(234,179,8,.30); }
    .sig.green{ color:#bbf7d0; background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.30); }

    /* right detail */
    .detailTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .live{
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.12);
      color:#a7f3d0; font-weight:950;
      white-space:nowrap;
    }
    .closeBtn{
      width:var(--tap); height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--muted);
      border-radius:12px; cursor:pointer; display:grid; place-items:center; font-size:16px;
    }
    .detailH{ margin:6px 0 10px; font-size:22px; font-weight:950; }
    .boxGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box{ border:1px solid rgba(34,48,83,.7); background: rgba(15,23,42,.45); padding:10px; border-radius:12px; }
    .box .l{ font-size:11px; color:var(--muted); margin-bottom:6px; }
    .box .v{ font-size:14px; font-weight:950; }
    .analysis{ margin-top:12px; border:1px solid rgba(34,48,83,.75); background: rgba(15,23,42,.45); padding:12px; border-radius:12px; }
    .analysis h3{ margin:0 0 8px; font-size:13px; display:flex; align-items:center; gap:8px; }
    .analysis ul{ margin:0; padding-left:18px; color:#cbd5e1; font-size:13px; }
    .analysis li{ margin:6px 0; }
    .foot{ margin-top:12px; border-top:1px solid rgba(34,48,83,.65); padding-top:10px; color:var(--muted); font-size:12px; }

    .spin{
      display:inline-block; width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(148,163,184,.35); border-top-color: rgba(148,163,184,1);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg);} }

    /* âœ… ì„±ê³¼ íƒ­: "í˜ì´ì§€ ì „ì²´ ìŠ¤í¬ë¡¤" + í•˜ë¶€ ë¦¬ìŠ¤íŠ¸ ë³„ë„ ìŠ¤í¬ë¡¤ */
    .perfPage{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
      overflow:auto;                 /* âœ… í˜ì´ì§€ ì „ì²´ ìŠ¤í¬ë¡¤ */
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      padding:14px;
      gap:14px;
    }
    .perfTop{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .miniPill{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      padding:10px 12px; border-radius:999px; font-size:13px; font-weight:900;
    }
    .perfGrid{
      display:grid; gap:12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (min-width: 900px){
      .perfGrid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    .perfCard{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      padding:14px; min-height:96px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .perfCard .h{ display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px; font-weight:900; }
    .perfCard .v{ font-size:26px; font-weight:950; margin-top:6px; }

    .perfPanel{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height:420px; /* âœ… ì•„ì´í°ì—ì„œë„ ì˜ì—­ í™•ë³´ */
    }
    .perfPanelHead{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
    }
    .perfPanelHead h2{ margin:0; font-size:14px; }
    .perfTableScroll{
      flex:1; min-height:0;
      overflow:auto; -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      touch-action: pan-y;
    }

    /* âœ… iOS Landscape ê°œì„  */
    @media (orientation: landscape) and (max-height: 520px){
      header{ padding: 8px 12px; }
      h1{ font-size:16px; }
      .sub{ display:none; }

      .app{
        height: calc(100dvh - 50px - env(safe-area-inset-top));
      }

      .stats{
        display:flex;
        gap:10px;
        overflow-x:auto;
        overflow-y:hidden;
        -webkit-overflow-scrolling:touch;
        overscroll-behavior-x:contain;
        padding-bottom:6px;
      }
      .card{
        flex: 0 0 240px;
        min-height: 64px;
        padding:10px;
      }
      .card .n{ font-size:18px; margin-top:4px; }
      .badgeIcon{ width:28px; height:28px; border-radius:12px; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div style="min-width:0;">
      <h1>í€€íŠ¸ ìŠ¤í¬ë¦¬ë„ˆ <span class="sub">Single-file</span></h1>
    </div>
  </div>

  <div class="toolbar">
    <button class="iconbtn" id="settingsBtn" title="URL ì„¤ì •">âš™ï¸</button>
    <span class="pill" id="lastUpdatedPill">ê°±ì‹ : -</span>
    <span class="pill warn" id="statusPill">ëŒ€ê¸°</span>
    <button class="btn primary" id="refreshBtn"><span id="refreshIcon">â†»</span> ë°ì´í„° ê°±ì‹ </button>
  </div>
</header>

<div class="settings" id="settingsPanel">
  <div class="inner">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:950;">Google Sheet CSV URL ì„¤ì •</div>
      <button class="iconbtn" id="settingsCloseBtn" title="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="grid2">
      <label><b style="color:#93c5fd;">ALL</b></label>
      <input id="urlALL" type="text">
      <label><b style="color:#bbf7d0;">TREND</b></label>
      <input id="urlTREND" type="text">
      <label><b style="color:#fde68a;">PULLBACK</b></label>
      <input id="urlPULLBACK" type="text">
      <label><b style="color:#fecaca;">BREAKOUT</b></label>
      <input id="urlBREAKOUT" type="text">
      <label><b style="color:#c7d2fe;">STORAGE</b></label>
      <input id="urlSTORAGE" type="text">
    </div>

    <div class="row" style="justify-content:space-between;">
      <div class="pill">ì„±ê³¼ íƒ­ ê¸°ê°„: <b id="perfDaysLabel">10</b> ê±°ë˜ì¼</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="daysMinusBtn">-</button>
        <button class="btn" id="daysPlusBtn">+</button>
        <button class="btn primary" id="saveAndRefreshBtn">URL ì €ì¥ ë° ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>

    <div class="errorbox" id="errorBox" style="display:none;">
      <div style="font-weight:950;">ì˜¤ë¥˜</div>
      <div>
        <div id="errorMsg" style="word-break:break-all;"></div>
        <div class="muted" style="margin-top:6px;">
          * ëª¨ë“  ì‹œíŠ¸ê°€ â€œì›¹ì— ê²Œì‹œâ€ë˜ì–´ ìˆê³  URLì´ <span class="mono">output=csv</span>ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸
        </div>
      </div>
    </div>
  </div>
</div>

<div class="app">
  <div class="tabbar">
    <button class="tabbtn active" id="tabCatch"><span>ğŸ”</span> í¬ì°© <span class="muted">Screen</span></button>
    <button class="tabbtn" id="tabPerf"><span>ğŸ“Š</span> ì„±ê³¼ <span class="muted">Perf</span></button>
  </div>

  <div class="pageWrap">
    <!-- =========================
         í¬ì°© íƒ­ (ê¸°ì¡´)
    ========================== -->
    <div class="page active" id="pageCatch">
      <div class="wrap">
        <div class="left" id="leftPane">
          <div class="stats">
            <div class="card active" data-filter="ALL">
              <div class="t"><span>ì „ì²´ í¬ì°©</span><span class="badgeIcon">ğŸ”</span></div>
              <div class="n" id="statTotal">-</div>
            </div>

            <div class="card" data-filter="TREND">
              <div class="t"><span>ì¶”ì„¸ ì¶”ì¢…</span><span class="badgeIcon" style="border-color:rgba(34,197,94,.35); color:#bbf7d0;">ğŸ“ˆ</span></div>
              <div class="n" id="statTrend">-</div>
            </div>

            <div class="card" data-filter="PULLBACK">
              <div class="t"><span>ëˆŒë¦¼ëª©</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">ğŸŸ¡</span></div>
              <div class="n" id="statPullback">-</div>
            </div>

            <div class="card" data-filter="BREAKOUT">
              <div class="t"><span>ë°•ìŠ¤ê¶Œ ëŒíŒŒ</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35); color:#fecaca;">ğŸš€</span></div>
              <div class="n" id="statBreakout">-</div>
            </div>

            <div class="card" data-filter="FAV">
              <div class="t"><span>ì°œ ëª©ë¡</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">â­</span></div>
              <div class="n" id="statFav">0</div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <h2>ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (<span id="filterLabel">ALL</span>)</h2>
              <div class="count"><span id="rowCount">0</span>ê±´</div>
            </div>

            <div class="tableScroll" id="catchTableScroll">
              <table>
                <thead>
                  <tr>
                    <th>ì¢…ëª©ì½”ë“œ</th>
                    <th>ì¢…ëª©ëª…</th>
                    <th class="center">ì„ íƒ</th>
                    <th class="numRight" style="display:none;" id="thClose">í˜„ì¬ê°€</th>
                    <th class="numRight">ê±°ë˜ëŒ€ê¸ˆ</th>
                    <th class="center" style="display:none;" id="thRSI">RSI</th>
                    <th class="center" style="display:none;" id="thStoch">STOCH K</th>
                    <th class="center">Signal</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="right" id="rightPane">
          <div class="detailTop">
            <div>
              <div class="muted" id="detailMeta">-</div>
              <div class="detailH" id="detailName">-</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <span class="live">Live Data</span>
              <button class="closeBtn" id="detailCloseBtn" title="ë‹«ê¸°">âœ•</button>
            </div>
          </div>

          <div class="boxGrid">
            <div class="box">
              <div class="l">í˜„ì¬ê°€</div>
              <div class="v"><span id="detailClose">-</span> <span class="muted" style="font-size:12px;">ì›</span></div>
            </div>
            <div class="box">
              <div class="l">RSI (14)</div>
              <div class="v" id="detailRSI">-</div>
            </div>
            <div class="box">
              <div class="l">Stoch K</div>
              <div class="v" id="detailStoch">-</div>
            </div>
            <div class="box">
              <div class="l">ê±°ë˜ëŸ‰</div>
              <div class="v" id="detailVol">-</div>
            </div>
          </div>

          <div class="analysis">
            <h3>âš ï¸ í¬ì°© ì‹ í˜¸ ë¶„ì„</h3>
            <ul id="detailSignals"></ul>
            <div class="foot" id="detailFoot">-</div>
          </div>

          <div class="analysis" style="margin-top:12px;">
            <h3>ğŸ“ˆ ì‹¤ì‹œê°„ ì°¨íŠ¸</h3>
            <iframe
              id="tvFrame"
              style="width:100%; height:240px; border:0; border-radius:10px;"
              loading="lazy"
              allowfullscreen
            ></iframe>
          </div>
        </aside>
      </div>
    </div>

    <!-- =========================
         ì„±ê³¼ íƒ­ (ìŠ¤í¬ë¡¤ 2ë‹¨)
    ========================== -->
    <div class="page" id="pagePerf">
      <div class="perfPage" id="perfScroll">
        <div class="perfTop">
          <div class="miniPill">ìµœê·¼ <b id="perfDaysPill">10</b> ê±°ë˜ì¼</div>
          <div class="miniPill">í‘œë³¸ <b id="perfSample">0</b></div>
          <div class="miniPill">í‰ê·  <b id="perfAvg">0.00%</b></div>
          <div class="miniPill">ì¤‘ì•™ê°’ <b id="perfMed">0.00%</b></div>
          <div class="miniPill">ìŠ¹ë¥  <b id="perfWin">0.0%</b></div>
        </div>

        <div class="perfGrid">
          <div class="perfCard">
            <div class="h"><span>ì‹ ë¢°ë„ ë³´ë“œ</span><span>ğŸ§ </span></div>
            <div class="v">Score</div>
            <div class="muted" style="font-size:12px;">ìµœê·¼ Nê±°ë˜ì¼ ê¸°ì¤€</div>
          </div>
          <div class="perfCard">
            <div class="h"><span>TOP ì„±ê³¼</span><span>ğŸ†</span></div>
            <div class="v" id="perfTop">-</div>
            <div class="muted" style="font-size:12px;">Return / Dn ê¸°ì¤€</div>
          </div>
          <div class="perfCard">
            <div class="h"><span>Worst ì„±ê³¼</span><span>ğŸ§¯</span></div>
            <div class="v" id="perfWorst">-</div>
            <div class="muted" style="font-size:12px;">ë¦¬ìŠ¤í¬ í™•ì¸</div>
          </div>
          <div class="perfCard" id="howCard" style="cursor:pointer;">
            <div class="h"><span>ì„¤ëª…</span><span>â„¹ï¸</span></div>
            <div class="v">How</div>
            <div class="muted" style="font-size:12px;">ì ìˆ˜ ì‚°ì‹</div>
          </div>
        </div>

        <div class="perfPanel">
          <div class="perfPanelHead">
            <h2>ì„±ê³¼ ë¦¬ìŠ¤íŠ¸ (Storage)</h2>
            <div class="count"><span id="perfRowCount">0</span>ê±´</div>
          </div>
          <div class="perfTableScroll" id="perfTableScroll">
            <table>
              <thead>
                <tr>
                  <th>DetectDate</th>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Signal_Type</th>
                  <th class="numRight">Entry</th>
                  <th class="numRight">D1</th>
                  <th class="numRight">D3</th>
                  <th class="numRight">D5</th>
                  <th class="numRight">D7</th>
                  <th class="numRight">D9</th>
                </tr>
              </thead>
              <tbody id="perfTbody">
                <tr><td colspan="10" class="center muted" style="padding:28px;">Storage ë¡œë”© ì¤‘...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="muted" style="font-size:12px; padding-bottom: env(safe-area-inset-bottom);">
          * ì„±ê³¼íƒ­ì€ ì „ì²´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥, í•˜ë‹¨ í…Œì´ë¸”ë„ ë³„ë„ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±ë¨
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const initialUrls = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv",
  STORAGE: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv"
};

const LS_KEY = "quant_screener_urls_v4";
const FAV_KEY = "quant_screener_favs_v2";
const PERF_DAYS_KEY = "quant_screener_perf_days_v1";

let sheetUrls = loadUrls();
let data = [];
let filterType = "ALL";
let detailStock = null;

// âœ… ì°œ ëª©ë¡ (ë¡œì»¬)
let selectedCodes = loadFavs();

// âœ… ì„±ê³¼ ê¸°ê°„ (ê±°ë˜ì¼)
let perfDays = loadPerfDays();

const $ = (id) => document.getElementById(id);
const settingsPanel = $("settingsPanel");
const statusPill = $("statusPill");
const lastUpdatedPill = $("lastUpdatedPill");
const tbody = $("tbody");
const rightPane = $("rightPane");

function setStatus(type, msg){
  statusPill.classList.remove("ok","warn","err");
  statusPill.classList.add(type);
  statusPill.textContent = msg;
}
function showError(msg){
  $("errorBox").style.display = "flex";
  $("errorMsg").textContent = msg;
}
function hideError(){
  $("errorBox").style.display = "none";
  $("errorMsg").textContent = "";
}
function fmt(n){ return new Intl.NumberFormat("ko-KR").format(n); }
function toNum(v){
  if(v === null || v === undefined) return 0;
  const s = String(v).replaceAll(",","").trim();
  const x = Number(s);
  return Number.isFinite(x) ? x : 0;
}
function pad6(code){
  const s = String(code ?? "").replace(/"/g,"").trim();
  if(/^\d+$/.test(s)) return s.padStart(6,"0");
  return s;
}
function bust(url){
  return url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

/** CSV robust parser */
function parseCSVRows(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0; i<text.length; i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
      continue;
    }
    if(!inQuotes && ch === ","){ row.push(cur); cur = ""; continue; }
    if(!inQuotes && ch === "\n"){
      row.push(cur); rows.push(row);
      row = []; cur = ""; continue;
    }
    if(ch === "\r") continue;
    cur += ch;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function toBool(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "true" || s === "1" || s === "y" || s === "yes" || s === "t");
}

function parseAllSheet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  const iCode = idx("Code");
  if(iCode < 0) return [];

  const iName = idx("Name"), iMarket = idx("Market"), iDate = idx("Date");
  const iTrend = idx("Trend"), iPull = idx("Pullback"), iBreak = idx("Breakout");
  const iClose = idx("Close"), iVol = idx("Volume"), iTurn = idx("Turnover");
  const iRSI = idx("RSI14"), iStoch = idx("Stoch_K");

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;
    out.push({
      Code: code,
      Name: iName >= 0 ? String(r[iName] ?? "").trim() : "",
      Market: iMarket >= 0 ? String(r[iMarket] ?? "").trim() : "",
      Date: iDate >= 0 ? String(r[iDate] ?? "").trim() : "",

      Trend_Signal: iTrend >= 0 ? toBool(r[iTrend]) : false,
      Pullback_Signal: iPull >= 0 ? toBool(r[iPull]) : false,
      Breakout_Signal: iBreak >= 0 ? toBool(r[iBreak]) : false,

      Close: iClose >= 0 ? toNum(r[iClose]) : 0,
      Volume: iVol >= 0 ? toNum(r[iVol]) : 0,
      Turnover: iTurn >= 0 ? toNum(r[iTurn]) : 0,
      RSI14: iRSI >= 0 ? toNum(r[iRSI]) : 0,
      Stoch_K: iStoch >= 0 ? toNum(r[iStoch]) : 0
    });
  }
  return out;
}

function parseSignalSheetToSet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return new Set();
  const headers = rows[0].map(h => String(h).trim());
  const codeIdx = headers.findIndex(h => h === "Code");
  const iCode = codeIdx >= 0 ? codeIdx : 0;

  const set = new Set();
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(/^\d{6}$/.test(code)) set.add(code);
  }
  return set;
}

/** âœ… Storage parser */
function parseStorageSheet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  const iDetect = idx("DetectDate");
  const iCode = idx("Code");
  if(iCode < 0) return [];

  const iName = idx("Name");
  const iSigType = idx("Signal_Type");
  const iEntry = idx("EntryPrice");
  const iD1 = idx("D1"), iD3 = idx("D3"), iD5 = idx("D5"), iD7 = idx("D7"), iD9 = idx("D9");

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;
    out.push({
      DetectDate: iDetect >= 0 ? String(r[iDetect] ?? "").trim() : "",
      Code: code,
      Name: iName >= 0 ? String(r[iName] ?? "").trim() : "",
      Signal_Type: iSigType >= 0 ? String(r[iSigType] ?? "").trim() : "",
      EntryPrice: iEntry >= 0 ? toNum(r[iEntry]) : 0,
      D1: iD1 >= 0 ? toNum(r[iD1]) : NaN,
      D3: iD3 >= 0 ? toNum(r[iD3]) : NaN,
      D5: iD5 >= 0 ? toNum(r[iD5]) : NaN,
      D7: iD7 >= 0 ? toNum(r[iD7]) : NaN,
      D9: iD9 >= 0 ? toNum(r[iD9]) : NaN,
    });
  }
  return out;
}

/** âœ… Perf days */
function loadPerfDays(){
  const raw = localStorage.getItem(PERF_DAYS_KEY);
  const n = Number(raw);
  return Number.isFinite(n) && n >= 5 && n <= 60 ? n : 10;
}
function savePerfDays(){
  localStorage.setItem(PERF_DAYS_KEY, String(perfDays));
  $("perfDaysLabel").textContent = String(perfDays);
  $("perfDaysPill").textContent = String(perfDays);
}

/** FAV persistence */
function loadFavs(){
  try{
    const raw = localStorage.getItem(FAV_KEY);
    if(!raw) return new Set();
    const arr = JSON.parse(raw);
    const set = new Set((Array.isArray(arr) ? arr : [])
      .map(pad6)
      .filter(x => /^\d{6}$/.test(x))
      .filter(x => x !== "000000")   // âœ… ìœ ë ¹ ì°œ ë°©ì§€
    );
    return set;
  }catch{
    return new Set();
  }
}
function saveFavs(){
  localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(selectedCodes)));
  $("statFav").textContent = String(selectedCodes.size);
}
function reconcileFavsWithData(){
  // âœ… í˜„ì¬ ë¡œë”©ëœ ì¢…ëª© ì½”ë“œì— ì¡´ì¬í•˜ëŠ” ì°œë§Œ ìœ ì§€ (ì•„ì´íŒ¨ë“œì—ì„œ '1' ìœ ë ¹ ì œê±°)
  const codeSet = new Set(data.map(d => d.Code));
  selectedCodes = new Set(Array.from(selectedCodes).filter(c => codeSet.has(c)));
  saveFavs();
}

async function fetchText(url){
  const res = await fetch(bust(url), { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

/** ====== UI helpers ====== */
function renderEmpty(msg){
  tbody.innerHTML = `<tr><td colspan="8" class="center muted" style="padding:28px;">${escapeHtml(msg)}</td></tr>`;
  $("rowCount").textContent = "0";
}
function fmtPct(x){
  if(!Number.isFinite(x)) return "-";
  return (x*100).toFixed(2) + "%";
}
function rsiColor(v){
  const x = Number(v)||0;
  if(x <= 30) return "#60a5fa";
  if(x >= 70) return "#fb7185";
  return "#94a3b8";
}
function stochColor(v){
  const x = Number(v)||0;
  if(x <= 20) return "#60a5fa";
  if(x >= 80) return "#fb7185";
  return "#94a3b8";
}

/** =========================
 *  í¬ì°© íƒ­ ë Œë”
 *  ========================= */
function updateStats(){
  $("statTotal").textContent = fmt(data.length);
  $("statTrend").textContent = fmt(data.filter(x=>x.Trend_Signal).length);
  $("statPullback").textContent = fmt(data.filter(x=>x.Pullback_Signal).length);
  $("statBreakout").textContent = fmt(data.filter(x=>x.Breakout_Signal).length);
  $("statFav").textContent = String(selectedCodes.size);
}
function getFiltered(){
  if(filterType === "TREND") return data.filter(x => x.Trend_Signal);
  if(filterType === "PULLBACK") return data.filter(x => x.Pullback_Signal);
  if(filterType === "BREAKOUT") return data.filter(x => x.Breakout_Signal);
  if(filterType === "FAV") return data.filter(x => selectedCodes.has(x.Code));
  return data;
}

function renderTable(){
  const rows = getFiltered();
  $("filterLabel").textContent = filterType;
  $("rowCount").textContent = String(rows.length);

  if(filterType === "FAV" && selectedCodes.size === 0){
    renderEmpty("ì°œí•œ ì¢…ëª©ì´ ì—†ì–´. ë¦¬ìŠ¤íŠ¸ì—ì„œ ë…¸ë€ ì ìœ¼ë¡œ ì°ì–´ì¤˜ â­");
    return;
  }
  if(!rows.length){
    renderEmpty("ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ì–´.");
    return;
  }

  const isWide = window.innerWidth >= 640;
  $("thClose").style.display = isWide ? "table-cell" : "none";
  $("thRSI").style.display = isWide ? "table-cell" : "none";
  $("thStoch").style.display = isWide ? "table-cell" : "none";

  tbody.innerHTML = rows.map((s) => {
    const isDetail = detailStock && detailStock.Code === s.Code;
    const isMulti = selectedCodes.has(s.Code);

    const turnoverEok = Math.round(toNum(s.Turnover) / 100000000);
    const sigs = [
      s.Breakout_Signal ? `<span class="sig red">ëŒíŒŒ</span>` : "",
      s.Pullback_Signal ? `<span class="sig yellow">ëˆŒë¦¼</span>` : "",
      s.Trend_Signal ? `<span class="sig green">ì¶”ì„¸</span>` : "",
    ].join("");

    return `
      <tr class="${isDetail ? "detailSelected" : ""}" data-code="${s.Code}">
        <td class="mono muted">${escapeHtml(s.Code)}</td>
        <td class="nameCell">${escapeHtml(s.Name || "")}</td>

        <td class="center">
          <span class="selectHit" data-action="select" data-code="${s.Code}">
            <span class="selectDot ${isMulti ? "on" : ""}"></span>
          </span>
        </td>

        <td class="numRight mono" style="display:${isWide ? "table-cell" : "none"}; color:#fb7185;">
          ${fmt(Math.round(toNum(s.Close)))}
        </td>

        <td class="numRight mono">${fmt(turnoverEok)}ì–µ</td>

        <td class="center mono" style="display:${isWide ? "table-cell" : "none"}; color:${rsiColor(s.RSI14)};">
          ${s.RSI14 ? Number(s.RSI14).toFixed(1) : "-"}
        </td>

        <td class="center mono" style="display:${isWide ? "table-cell" : "none"}; color:${stochColor(s.Stoch_K)};">
          ${s.Stoch_K ? Number(s.Stoch_K).toFixed(1) : "-"}
        </td>

        <td class="center"><div class="sigWrap">${sigs}</div></td>
      </tr>
    `;
  }).join("");
}

function openDetail(stock){
  detailStock = stock;

  $("detailMeta").textContent = `${stock.Market || "-"} | ${stock.Code}`;
  $("detailName").textContent = stock.Name || "-";
  $("detailClose").textContent = fmt(Math.round(toNum(stock.Close)));
  $("detailRSI").textContent = stock.RSI14 ? Number(stock.RSI14).toFixed(2) : "-";
  $("detailStoch").textContent = stock.Stoch_K ? Number(stock.Stoch_K).toFixed(2) : "-";
  $("detailVol").textContent = fmt(Math.round(toNum(stock.Volume)));

  const ul = $("detailSignals");
  ul.innerHTML = "";
  if(stock.Breakout_Signal) ul.innerHTML += `<li><b>ë°•ìŠ¤ê¶Œ ëŒíŒŒ:</b> ê±°ë˜ëŸ‰ + ëª¨ë©˜í…€ì„ ë™ë°˜í•œ ìƒë‹¨ ëŒíŒŒ ê°€ëŠ¥ì„±</li>`;
  if(stock.Pullback_Signal) ul.innerHTML += `<li><b>ëˆŒë¦¼ëª©:</b> ìƒìŠ¹ ì¶”ì„¸ ì¤‘ ì¡°ì • ì´í›„ ì¬ì‹œë™ ê°€ëŠ¥ì„±</li>`;
  if(stock.Trend_Signal) ul.innerHTML += `<li><b>ì¶”ì„¸ ì¶”ì¢…:</b> ìƒìŠ¹ ì¶”ì„¸ ì§€ì† + ê±°ë˜ëŸ‰ í™•ëŒ€ ê°€ëŠ¥ì„±</li>`;
  if(!ul.innerHTML) ul.innerHTML = `<li class="muted">ì‹ í˜¸ ì •ë³´ ì—†ìŒ</li>`;

  const eok = Math.round(toNum(stock.Turnover) / 100000000);
  $("detailFoot").innerHTML = `ê¸°ì¤€ì¼: ${escapeHtml(stock.Date || "-")}<br/>ê±°ë˜ëŒ€ê¸ˆ: ${fmt(eok)}ì–µì›`;

  rightPane.classList.add("open");

  const frame = document.getElementById("tvFrame");
  if(frame){
    frame.src =
      "https://www.tradingview.com/widgetembed/?" +
      "symbol=KRX:" + stock.Code +
      "&interval=D" +
      "&theme=dark" +
      "&hidesidetoolbar=1" +
      "&hidetoptoolbar=1";
  }
}
function closeDetail(){
  rightPane.classList.remove("open");
  detailStock = null;
}
function toggleDetailByCode(code){
  const stock = data.find(x => x.Code === code);
  if(!stock) return;
  if(detailStock && detailStock.Code === code) closeDetail();
  else openDetail(stock);
}

function toggleSelect(code){
  if(selectedCodes.has(code)) selectedCodes.delete(code);
  else selectedCodes.add(code);
  saveFavs();
  renderTable();
}

/** =========================
 *  ì„±ê³¼ íƒ­ ë Œë”
 *  ========================= */
function pctCell(x){
  if(!NumberNumber(x)) return `<span class="muted">-</span>`;
  const v = x;
  const color = v >= 0 ? "#a7f3d0" : "#fecaca";
  return `<span style="color:${color}; font-weight:950;">${(v*100).toFixed(2)}%</span>`;
}
function isFiniteNumber(x){ return Number.isFinite(x); }
function perfPickReturn(row){
  // ìµœê·¼ Nê±°ë˜ì¼ ê¸°ì¤€ ì§‘ê³„ë¥¼ ìœ„í•´: D9> D7> D5> D3> D1 ìˆœìœ¼ë¡œ "ê°€ì¥ ë¨¼ ê²ƒ"ì´ ìˆìœ¼ë©´ ì‚¬ìš©
  const order = ["D9","D7","D5","D3","D1"];
  for(const k of order){
    const v = Number(row[k]);
    if(Number.isFinite(v)) return v;
  }
  return NaN;
}
function renderPerf(storageRows){
  const body = $("perfTbody");
  if(!storageRows || !storageRows.length){
    body.innerHTML = `<tr><td colspan="10" class="center muted" style="padding:28px;">Storage ë°ì´í„° ì—†ìŒ (ì„¤ì • âš™ï¸ â†’ STORAGE URL í™•ì¸)</td></tr>`;
    $("perfRowCount").textContent = "0";
    $("perfSample").textContent = "0";
    $("perfAvg").textContent = "0.00%";
    $("perfMed").textContent = "0.00%";
    $("perfWin").textContent = "0.0%";
    $("perfTop").textContent = "-";
    $("perfWorst").textContent = "-";
    return;
  }

  // âœ… DetectDate ê¸°ì¤€ ìµœì‹ ìˆœ
  const rows = storageRows.slice().sort((a,b) => String(b.DetectDate).localeCompare(String(a.DetectDate)));

  // âœ… ìµœê·¼ Nê±°ë˜ì¼ë§Œ(DetectDate ê³ ìœ ê°’ ê¸°ì¤€)
  const uniqDates = [];
  const seen = new Set();
  for(const r of rows){
    const d = String(r.DetectDate||"").slice(0,10);
    if(!d) continue;
    if(!seen.has(d)){
      seen.add(d);
      uniqDates.push(d);
    }
    if(uniqDates.length >= perfDays) break;
  }
  const allowDates = new Set(uniqDates);
  const filtered = rows.filter(r => allowDates.has(String(r.DetectDate||"").slice(0,10)));

  $("perfRowCount").textContent = String(filtered.length);
  $("perfSample").textContent = String(filtered.length);

  // âœ… í‰ê· /ì¤‘ì•™/ìŠ¹ë¥ 
  const rets = filtered.map(perfPickReturn).filter(Number.isFinite);
  const avg = rets.length ? rets.reduce((a,b)=>a+b,0)/rets.length : 0;
  const med = rets.length ? (rets.slice().sort((a,b)=>a-b)[Math.floor(rets.length/2)]) : 0;
  const win = rets.length ? (rets.filter(x=>x>0).length / rets.length) : 0;

  $("perfAvg").textContent = (avg*100).toFixed(2) + "%";
  $("perfMed").textContent = (med*100).toFixed(2) + "%";
  $("perfWin").textContent = (win*100).toFixed(1) + "%";

  // âœ… Top/Worst (rets ê¸°ì¤€)
  if(rets.length){
    const topV = Math.max(...rets);
    const worstV = Math.min(...rets);
    const topRow = filtered.find(r => perfPickReturn(r) === topV);
    const worstRow = filtered.find(r => perfPickReturn(r) === worstV);
    $("perfTop").textContent = topRow ? `${topRow.Name || topRow.Code} ${(topV*100).toFixed(2)}%` : "-";
    $("perfWorst").textContent = worstRow ? `${worstRow.Name || worstRow.Code} ${(worstV*100).toFixed(2)}%` : "-";
  }else{
    $("perfTop").textContent = "-";
    $("perfWorst").textContent = "-";
  }

  // âœ… í…Œì´ë¸” ë Œë”
  body.innerHTML = filtered.map(r => `
    <tr>
      <td class="mono muted">${escapeHtml(String(r.DetectDate||"").slice(0,10))}</td>
      <td class="mono muted">${escapeHtml(r.Code)}</td>
      <td class="nameCell">${escapeHtml(r.Name||"")}</td>
      <td class="mono">${escapeHtml(r.Signal_Type||"")}</td>
      <td class="numRight mono">${fmt(Math.round(toNum(r.EntryPrice)))}</td>
      <td class="numRight mono">${pctCell(Number(r.D1))}</td>
      <td class="numRight mono">${pctCell(Number(r.D3))}</td>
      <td class="numRight mono">${pctCell(Number(r.D5))}</td>
      <td class="numRight mono">${pctCell(Number(r.D7))}</td>
      <td class="numRight mono">${pctCell(Number(r.D9))}</td>
    </tr>
  `).join("");
}
function isFiniteNumber2(x){ return Number.isFinite(Number(x)); }
function R(x){ return Number(x); }
function pctCell(x){
  if(!Number.isFinite(x)) return `<span class="muted">-</span>`;
  const color = x >= 0 ? "#a7f3d0" : "#fecaca";
  return `<span style="color:${color}; font-weight:950;">${(x*100).toFixed(2)}%</span>`;
}
function isFiniteNumber(x){ return Number.isFinite(x); }
function Rn(v){ const x = Number(v); return Number.isFinite(x) ? x : NaN; }
function perfPickReturn(row){
  const order = ["D9","D7","D5","D3","D1"];
  for(const k of order){
    const v = Rn(row[k]);
    if(Number.isFinite(v)) return v;
  }
  return NaN;
}

/** =========================
 *  ë°ì´í„° ë¡œë”© (í¬ì°© + ì„±ê³¼)
 *  ========================= */
async function fetchData(){
  if(!sheetUrls.ALL){
    openSettings(true);
    showError("ALL ì‹œíŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•´ì¤˜.");
    return;
  }

  hideError();
  setStatus("warn","ë¡œë”©ì¤‘...");
  $("refreshBtn").disabled = true;
  $("refreshIcon").innerHTML = '<span class="spin"></span>';

  detailStock = null;
  closeDetail();

  try{
    const [allText, trendText, pullText, breakText, storageText] = await Promise.all([
      fetchText(sheetUrls.ALL),
      sheetUrls.TREND ? fetchText(sheetUrls.TREND).catch(()=>null) : Promise.resolve(null),
      sheetUrls.PULLBACK ? fetchText(sheetUrls.PULLBACK).catch(()=>null) : Promise.resolve(null),
      sheetUrls.BREAKOUT ? fetchText(sheetUrls.BREAKOUT).catch(()=>null) : Promise.resolve(null),
      sheetUrls.STORAGE ? fetchText(sheetUrls.STORAGE).catch(()=>null) : Promise.resolve(null),
    ]);

    // ---- í¬ì°©(ALL ê¸°ë°˜)
    const allData = parseAllSheet(allText);
    if(!allData.length) throw new Error("ALL ì‹œíŠ¸ íŒŒì‹± ì‹¤íŒ¨. í—¤ë”/ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì¤˜.");

    const trendSet = trendText ? parseSignalSheetToSet(trendText) : null;
    const pullSet  = pullText  ? parseSignalSheetToSet(pullText)  : null;
    const breakSet = breakText ? parseSignalSheetToSet(breakText) : null;

    data = allData.map(s => {
      if(trendSet) s.Trend_Signal = trendSet.has(s.Code) || s.Trend_Signal;
      if(pullSet)  s.Pullback_Signal = pullSet.has(s.Code) || s.Pullback_Signal;
      if(breakSet) s.Breakout_Signal = breakSet.has(s.Code) || s.Breakout_Signal;
      return s;
    });

    data.sort((a,b) => {
      if(b.Breakout_Signal !== a.Breakout_Signal) return b.Breakout_Signal ? 1 : -1;
      if(b.Pullback_Signal !== a.Pullback_Signal) return b.Pullback_Signal ? 1 : -1;
      if(b.Trend_Signal !== a.Trend_Signal) return b.Trend_Signal ? 1 : -1;
      return toNum(b.Turnover) - toNum(a.Turnover);
    });

    // âœ… ì—¬ê¸°ì„œ ìœ ë ¹ ì°œ ì œê±°
    reconcileFavsWithData();

    updateStats();
    renderTable();

    // ---- ì„±ê³¼(Storage)
    if(storageText){
      const storageRows = parseStorageSheet(storageText);
      renderPerf(storageRows);
    }else{
      renderPerf([]);
    }

    lastUpdatedPill.textContent = "ê°±ì‹ : " + new Date().toLocaleTimeString("ko-KR");
    setStatus("ok","ìµœì‹  ë°˜ì˜");
    openSettings(false);

  }catch(e){
    data = [];
    updateStats();
    renderEmpty("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + (e.message || String(e)));
    renderPerf([]);
    setStatus("err","ì‹¤íŒ¨");
    showError(e.message || String(e));
  }finally{
    $("refreshBtn").disabled = false;
    $("refreshIcon").textContent = "â†»";
  }
}

/** =========================
 *  URL settings
 *  ========================= */
function loadUrls(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {...initialUrls};
    const obj = JSON.parse(raw);
    return { ...initialUrls, ...obj };
  }catch{
    return {...initialUrls};
  }
}
function saveUrls(){
  localStorage.setItem(LS_KEY, JSON.stringify(sheetUrls));
}
function openSettings(open){
  settingsPanel.classList.toggle("open", !!open);
}

/** =========================
 *  Tabs
 *  ========================= */
function openTab(name){
  const isCatch = (name === "catch");
  $("pageCatch").classList.toggle("active", isCatch);
  $("pagePerf").classList.toggle("active", !isCatch);
  $("tabCatch").classList.toggle("active", isCatch);
  $("tabPerf").classList.toggle("active", !isCatch);
}

/** =========================
 *  Events bind
 *  ========================= */
function bind(){
  $("settingsBtn").addEventListener("click", () => openSettings(!settingsPanel.classList.contains("open")));
  $("settingsCloseBtn").addEventListener("click", () => openSettings(false));

  $("refreshBtn").addEventListener("click", fetchData);
  $("saveAndRefreshBtn").addEventListener("click", () => {
    sheetUrls = {
      ALL: $("urlALL").value.trim(),
      TREND: $("urlTREND").value.trim(),
      PULLBACK: $("urlPULLBACK").value.trim(),
      BREAKOUT: $("urlBREAKOUT").value.trim(),
      STORAGE: $("urlSTORAGE").value.trim(),
    };
    saveUrls();
    savePerfDays();
    fetchData();
  });

  // âœ… ê¸°ê°„ ì¡°ì ˆ
  $("daysMinusBtn").addEventListener("click", () => {
    perfDays = Math.max(5, perfDays - 5);
    savePerfDays();
    fetchData();
  });
  $("daysPlusBtn").addEventListener("click", () => {
    perfDays = Math.min(60, perfDays + 5);
    savePerfDays();
    fetchData();
  });

  // âœ… íƒ­ ì „í™˜
  $("tabCatch").addEventListener("click", () => openTab("catch"));
  $("tabPerf").addEventListener("click", () => openTab("perf"));

  // âœ… í•„í„° ì¹´ë“œ
  document.querySelectorAll(".card[data-filter]").forEach(el => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".card[data-filter]").forEach(c => c.classList.remove("active"));
      el.classList.add("active");
      filterType = el.dataset.filter;
      closeDetail();
      renderTable();
    });
  });

  // âœ… í…Œì´ë¸” í´ë¦­
  tbody.addEventListener("click", (e) => {
    const t = e.target;

    const hit = t.closest("[data-action='select']");
    if(hit && hit.dataset && hit.dataset.code){
      e.stopPropagation();
      toggleSelect(hit.dataset.code);
      return;
    }

    const tr = t.closest("tr[data-code]");
    if(!tr) return;

    toggleDetailByCode(tr.dataset.code);
    renderTable();
  });

  $("detailCloseBtn").addEventListener("click", () => {
    closeDetail();
    renderTable();
  });

  // âœ… How ì¹´ë“œ
  $("howCard").addEventListener("click", () => {
    alert(
`[How: ì ìˆ˜/ì„±ê³¼ í•´ì„]
- ì„±ê³¼ëŠ” Storageì˜ D1/D3/D5/D7/D9 ìˆ˜ìµë¥ ì„ ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½í•´.
- ìµœê·¼ Nê±°ë˜ì¼ì€ DetectDate(YYYY-MM-DD)ì˜ 'ê³ ìœ  ë‚ ì§œ' ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„.
- Top/WorstëŠ” D9â†’D7â†’D5â†’D3â†’D1 ìˆœìœ¼ë¡œ "ê°€ì¥ ë¨¼ ìˆ˜ìµë¥ "ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ëŒ€í‘œ ìˆ˜ìµë¥ ë¡œ ì‚¬ìš©.
- ì°œ(â­)ì€ í˜„ì¬ ë¡œë”©ëœ ì¢…ëª©ì½”ë“œì— ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ ìœ íš¨(ìœ ë ¹ ì°œ ìë™ ì œê±°).`
    );
  });

  window.addEventListener("resize", () => renderTable());

  // âœ… settings ì´ˆê¸°ê°’
  $("urlALL").value = sheetUrls.ALL;
  $("urlTREND").value = sheetUrls.TREND;
  $("urlPULLBACK").value = sheetUrls.PULLBACK;
  $("urlBREAKOUT").value = sheetUrls.BREAKOUT;
  $("urlSTORAGE").value = sheetUrls.STORAGE;

  // âœ… perf days í‘œì‹œ
  savePerfDays();

  // âœ… ì°œ ìˆ«ìë§Œ ë¨¼ì € ë°˜ì˜(ë°ì´í„° ë¡œë”© í›„ reconcileë¡œ ì •ë¦¬ë¨)
  $("statFav").textContent = String(selectedCodes.size);
}

bind();
fetchData();
</script>
</body>
</html>
