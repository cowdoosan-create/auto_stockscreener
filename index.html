<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <script>
    if (!sessionStorage.getItem("auth")) {
      const input = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
      if (input !== "fire") {
        document.body.innerHTML = "<h2 style='padding:20px'>ì ‘ê·¼ ë¶ˆê°€</h2>";
        throw new Error("Unauthorized");
      }
      sessionStorage.setItem("auth", "true");
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>YJ ìŠ¤í¬ë¦¬ë„ˆ (Single-file)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0f172a">

  <style>
    :root{
      --bg:#0f172a; --panel:#111c33; --panel2:#0b1224;
      --line:#223053; --txt:#e5e7eb; --muted:#94a3b8;
      --green:#22c55e; --yellow:#eab308; --red:#ef4444;
      --radius:14px; --tap: 44px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      height: 100dvh; overflow:hidden;
    }
    header{ padding-top: env(safe-area-inset-top); }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 14px; background:var(--panel); border-bottom:1px solid var(--line);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:28px; height:28px; border-radius:10px;
      background:linear-gradient(135deg, #60a5fa, #22c55e);
      box-shadow:0 10px 30px rgba(59,130,246,.15);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size:18px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sub{ color:var(--muted); font-size:12px; margin-left:6px; font-weight:500;}

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .iconbtn{
      width:var(--tap); height:var(--tap); border-radius:12px;
      border:1px solid var(--line); background:transparent; color:var(--muted);
      display:grid; place-items:center; cursor:pointer; font-size:16px;
    }
    .btn{
      min-height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--txt);
      padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:800; font-size:13px;
      display:flex; align-items:center; gap:8px;
    }
    .btn.primary{ background:rgba(59,130,246,.18); border-color:rgba(59,130,246,.45); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{
      border:1px solid var(--line); background:rgba(255,255,255,.03);
      padding:7px 10px; border-radius:999px; font-size:12px; color:var(--muted); white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(34,197,94,.4); color:#a7f3d0; background:rgba(34,197,94,.10);}
    .pill.err{ border-color: rgba(239,68,68,.45); color:#fecaca; background:rgba(239,68,68,.10);}
    .pill.warn{ border-color: rgba(234,179,8,.45); color:#fde68a; background:rgba(234,179,8,.10);}

    .wrap{
      display:flex;
      height: calc(100dvh - 58px - env(safe-area-inset-top));
      min-height:0;
    }

    .settings{
      display:none;
      position:absolute;
      top: calc(58px + env(safe-area-inset-top));
      left:0; right:0;
      background:var(--panel);
      border-bottom:1px solid var(--line);
      padding:14px;
      z-index:60;
    }
    .settings.open{ display:block; }
    .settings .inner{ max-width:1100px; margin:0 auto; display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:var(--panel2); color:var(--txt); outline:none;
    }
    .grid2{ display:grid; grid-template-columns: 110px 1fr; gap:10px; align-items:center; }
    @media (max-width: 520px){ .grid2{ grid-template-columns:1fr; } }
    .errorbox{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(239,68,68,.35); background:rgba(239,68,68,.12);
      padding:12px; border-radius:12px; color:#fecaca; font-size:12px;
    }

    .left{ flex:1; display:flex; flex-direction:column; padding:14px; gap:14px; min-width:0; overflow:hidden; }
    .right{
      width:380px; border-left:1px solid var(--line); background:var(--panel);
      padding:14px; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      display:none; min-height:0;
    }
    .right.open{ display:block; }
    @media (max-width:1024px){
      .right{
        position:absolute; inset: calc(58px + env(safe-area-inset-top)) 0 0 0;
        width:auto; z-index:55; display:none;
        border-left:none; border-top:1px solid var(--line); border-radius:16px 16px 0 0;
      }
      .right.open{ display:block; }
    }

    .stats{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; }
    @media (max-width:880px){ .stats{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .card{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      padding:12px; cursor:pointer; min-height:80px;
      transition: transform .05s ease, background .15s ease;
    }
    .card:active{ transform: translateY(1px); }
    .card.active{ outline:1px solid rgba(148,163,184,.5); background: rgba(148,163,184,.08); }
    .card .t{ color:var(--muted); font-size:12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .badgeIcon{
      width:30px; height:30px; border-radius:12px; display:grid; place-items:center;
      border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--muted);
    }
    .card .n{ font-size:22px; font-weight:950; margin-top:6px; }

    .panel{
      border:1px solid var(--line); background:var(--panel); border-radius:var(--radius);
      overflow:hidden; display:flex; flex-direction:column; min-height:0;
      box-shadow:0 12px 40px rgba(0,0,0,.20);
    }
    .panelHead{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.02);
    }
    .panelHead h2{ margin:0; font-size:14px; }
    .panelHead .count{
      font-size:12px; color:var(--muted);
      padding:3px 10px; border-radius:999px; border:1px solid var(--line); white-space:nowrap;
    }
    .tableScroll{
      overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      flex:1; min-height:0;
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,23,42,.92);
      backdrop-filter: blur(6px);
      color: var(--muted);
      font-size:11px;
      text-transform: uppercase;
      letter-spacing: .04em;
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      white-space: nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(34,48,83,.55);
      padding:12px 10px;
      vertical-align:middle;
      white-space: nowrap;
    }
    tbody tr:hover{ background: rgba(148,163,184,.07); }
    tbody tr.detailSelected{ background: rgba(59,130,246,.14); border-left:2px solid rgba(59,130,246,.85); }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }
    .numRight{ text-align:right; }
    .center{ text-align:center; }

    td.nameCell{
      max-width: 44vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .selectDot{
      width:18px; height:18px;
      border-radius:999px; border:2px solid var(--yellow);
      display:inline-block; background:transparent; vertical-align:middle;
    }
    .selectDot.on{ background: var(--yellow); border-color: var(--yellow); }
    .selectHit{
      display:inline-flex; align-items:center; justify-content:center;
      width:var(--tap); height:var(--tap); border-radius:12px;
    }

    .sigWrap{ display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
    .sig{ font-size:10px; padding:2px 8px; border-radius:999px; border:1px solid; font-weight:900; line-height:1.4; }
    .sig.red{ color:#fecaca; background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.30); }
    .sig.yellow{ color:#fde68a; background:rgba(234,179,8,.15); border-color:rgba(234,179,8,.30); }
    .sig.green{ color:#bbf7d0; background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.30); }

    .detailTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .live{
      font-size:11px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(34,197,94,.35);
      background:rgba(34,197,94,.12);
      color:#a7f3d0; font-weight:950;
      white-space:nowrap;
    }
    .closeBtn{
      width:var(--tap); height:var(--tap);
      border:1px solid var(--line); background:transparent; color:var(--muted);
      border-radius:12px; cursor:pointer; display:grid; place-items:center; font-size:16px;
    }
    .detailH{ margin:6px 0 10px; font-size:22px; font-weight:950; }
    .boxGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .box{ border:1px solid rgba(34,48,83,.7); background: rgba(15,23,42,.45); padding:10px; border-radius:12px; }
    .box .l{ font-size:11px; color:var(--muted); margin-bottom:6px; }
    .box .v{ font-size:14px; font-weight:950; }
    .analysis{ margin-top:12px; border:1px solid rgba(34,48,83,.75); background: rgba(15,23,42,.45); padding:12px; border-radius:12px; }
    .analysis h3{ margin:0 0 8px; font-size:13px; display:flex; align-items:center; gap:8px; }
    .analysis ul{ margin:0; padding-left:18px; color:#cbd5e1; font-size:13px; }
    .analysis li{ margin:6px 0; }
    .foot{ margin-top:12px; border-top:1px solid rgba(34,48,83,.65); padding-top:10px; color:var(--muted); font-size:12px; }

    .spin{
      display:inline-block; width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(148,163,184,.35); border-top-color: rgba(148,163,184,1);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg);} }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo"></div>
    <div style="min-width:0;">
      <h1>í€€íŠ¸ ìŠ¤í¬ë¦¬ë„ˆ <span class="sub">Single-file</span></h1>
    </div>
  </div>

  <div class="toolbar">
    <button class="iconbtn" id="settingsBtn" title="URL ì„¤ì •">âš™ï¸</button>
    <span class="pill" id="lastUpdatedPill">ê°±ì‹ : -</span>
    <span class="pill warn" id="statusPill">ëŒ€ê¸°</span>
    <button class="btn primary" id="refreshBtn"><span id="refreshIcon">â†»</span> ë°ì´í„° ê°±ì‹ </button>
  </div>
</header>

<div class="settings" id="settingsPanel">
  <div class="inner">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:950;">Google Sheet CSV URL ì„¤ì •</div>
      <button class="iconbtn" id="settingsCloseBtn" title="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="grid2">
      <label><b style="color:#93c5fd;">ALL</b></label>
      <input id="urlALL" type="text">
      <label><b style="color:#bbf7d0;">TREND</b></label>
      <input id="urlTREND" type="text">
      <label><b style="color:#fde68a;">PULLBACK</b></label>
      <input id="urlPULLBACK" type="text">
      <label><b style="color:#fecaca;">BREAKOUT</b></label>
      <input id="urlBREAKOUT" type="text">
    </div>

    <div class="row" style="justify-content:flex-end;">
      <button class="btn primary" id="saveAndRefreshBtn">URL ì €ì¥ ë° ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div class="errorbox" id="errorBox" style="display:none;">
      <div style="font-weight:950;">ì˜¤ë¥˜</div>
      <div>
        <div id="errorMsg" style="word-break:break-all;"></div>
        <div class="muted" style="margin-top:6px;">
          * ëª¨ë“  ì‹œíŠ¸ê°€ â€œì›¹ì— ê²Œì‹œâ€ë˜ì–´ ìˆê³  URLì´ <span class="mono">output=csv</span>ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸
        </div>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="left" id="leftPane">
    <div class="stats">
      <div class="card active" data-filter="ALL">
        <div class="t"><span>ì „ì²´ í¬ì°©</span><span class="badgeIcon">ğŸ”</span></div>
        <div class="n" id="statTotal">-</div>
      </div>
      <div class="card" data-filter="TREND">
        <div class="t"><span>ì¶”ì„¸ ì¶”ì¢…</span><span class="badgeIcon" style="border-color:rgba(34,197,94,.35); color:#bbf7d0;">ğŸ“ˆ</span></div>
        <div class="n" id="statTrend">-</div>
      </div>
      <div class="card" data-filter="PULLBACK">
        <div class="t"><span>ëˆŒë¦¼ëª©</span><span class="badgeIcon" style="border-color:rgba(234,179,8,.35); color:#fde68a;">ğŸŸ¡</span></div>
        <div class="n" id="statPullback">-</div>
      </div>
      <div class="card" data-filter="BREAKOUT">
        <div class="t"><span>ë°•ìŠ¤ê¶Œ ëŒíŒŒ</span><span class="badgeIcon" style="border-color:rgba(239,68,68,.35); color:#fecaca;">ğŸš€</span></div>
        <div class="n" id="statBreakout">-</div>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <h2>ê²€ì¶œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ (<span id="filterLabel">ALL</span>)</h2>
        <div class="count"><span id="rowCount">0</span>ê±´</div>
      </div>

      <div class="tableScroll">
        <table>
          <thead>
            <tr>
              <th>ì¢…ëª©ì½”ë“œ</th>
              <th>ì¢…ëª©ëª…</th>
              <th class="center">ì„ íƒ</th>
              <th class="numRight" style="display:none;" id="thClose">í˜„ì¬ê°€</th>
              <th class="numRight">ê±°ë˜ëŒ€ê¸ˆ</th>
              <th class="center" style="display:none;" id="thRSI">RSI</th>
              <th class="center" style="display:none;" id="thStoch">STOCH K</th>
              <th class="center">Signal</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="8" class="center muted" style="padding:28px;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <aside class="right" id="rightPane">
    <div class="detailTop">
      <div>
        <div class="muted" id="detailMeta">-</div>
        <div class="detailH" id="detailName">-</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <span class="live">Live Data</span>
        <button class="closeBtn" id="detailCloseBtn" title="ë‹«ê¸°">âœ•</button>
      </div>
    </div>

    <div class="boxGrid">
      <div class="box">
        <div class="l">í˜„ì¬ê°€</div>
        <div class="v"><span id="detailClose">-</span> <span class="muted" style="font-size:12px;">ì›</span></div>
      </div>
      <div class="box">
        <div class="l">RSI (14)</div>
        <div class="v" id="detailRSI">-</div>
      </div>
      <div class="box">
        <div class="l">Stoch K</div>
        <div class="v" id="detailStoch">-</div>
      </div>
      <div class="box">
        <div class="l">ê±°ë˜ëŸ‰</div>
        <div class="v" id="detailVol">-</div>
      </div>
    </div>

    <div class="analysis">
      <h3>âš ï¸ í¬ì°© ì‹ í˜¸ ë¶„ì„</h3>
      <ul id="detailSignals"></ul>
      <div class="foot" id="detailFoot">-</div>
    </div>

    <div class="analysis" style="margin-top:12px;">
      <h3>ğŸ“ˆ ì‹¤ì‹œê°„ ì°¨íŠ¸</h3>
      <iframe
        id="tvFrame"
        style="width:100%; height:240px; border:0; border-radius:10px;"
        loading="lazy"
        allowfullscreen
      ></iframe>
    </div>
  </aside>
</div>

<script>
/** =========================
 *  1) CONFIG (ì‹ ê·œ URL)
 *  ========================= */
const initialUrls = {
  ALL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv",
  TREND: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=1981708246&single=true&output=csv",
  PULLBACK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=852505203&single=true&output=csv",
  BREAKOUT: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=258627301&single=true&output=csv"
};

const LS_KEY = "quant_screener_urls_v2"; // âœ… v2ë¡œ ì˜¬ë ¤ì„œ ì˜ˆì „ ì €ì¥ê°’ ê¼¬ì„ ë°©ì§€
let sheetUrls = loadUrls();

let data = [];
let filterType = "ALL";
let detailStock = null;
let selectedCodes = new Set();

const $ = (id) => document.getElementById(id);
const settingsPanel = $("settingsPanel");
const statusPill = $("statusPill");
const lastUpdatedPill = $("lastUpdatedPill");
const tbody = $("tbody");
const rightPane = $("rightPane");

function setStatus(type, msg){
  statusPill.classList.remove("ok","warn","err");
  statusPill.classList.add(type);
  statusPill.textContent = msg;
}
function showError(msg){
  $("errorBox").style.display = "flex";
  $("errorMsg").textContent = msg;
}
function hideError(){
  $("errorBox").style.display = "none";
  $("errorMsg").textContent = "";
}
function fmt(n){ return new Intl.NumberFormat("ko-KR").format(n); }
function toNum(v){
  if(v === null || v === undefined) return 0;
  const s = String(v).replaceAll(",","").trim();
  const x = Number(s);
  return Number.isFinite(x) ? x : 0;
}
function pad6(code){
  const s = String(code ?? "").replace(/"/g,"").trim();
  if(/^\d+$/.test(s)) return s.padStart(6,"0");
  return s;
}
function bust(url){
  return url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

/** =========================
 *  2) CSV íŒŒì„œ(ë”°ì˜´í‘œ/ì‰¼í‘œ ì•ˆì „)
 *  ========================= */
function parseCSVRows(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0; i<text.length; i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ // escaped quote
        cur += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
      continue;
    }

    if(!inQuotes && (ch === ",")){
      row.push(cur);
      cur = "";
      continue;
    }

    if(!inQuotes && (ch === "\n")){
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
      continue;
    }

    if(ch === "\r") continue;
    cur += ch;
  }

  // tail
  if(cur.length || row.length){
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

/** =========================
 *  3) ë°ì´í„° íŒŒì‹±/ì •ê·œí™” (ìƒˆ í—¤ë” ëŒ€ì‘)
 *  - ALLì€ Trend/Pullback/Breakout ì»¬ëŸ¼ì´ ì´ë¯¸ ìˆìŒ
 *  - ê·¸ë˜ë„ ë³„ë„ ì‹œíŠ¸ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥
 *  ========================= */
function toBool(v){
  const s = String(v ?? "").trim().toLowerCase();
  return (s === "true" || s === "1" || s === "y" || s === "yes" || s === "t");
}

function parseAllSheet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return [];

  const headers = rows[0].map(h => String(h).trim());
  const idx = (name) => headers.findIndex(h => h === name);

  const iCode = idx("Code");
  const iName = idx("Name");
  const iMarket = idx("Market");
  const iDate = idx("Date");
  const iTrend = idx("Trend");
  const iPull = idx("Pullback");
  const iBreak = idx("Breakout");
  const iClose = idx("Close");
  const iVol = idx("Volume");
  const iTurn = idx("Turnover");
  const iRSI = idx("RSI14");
  const iStoch = idx("Stoch_K");

  if(iCode < 0) return [];

  const out = [];
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(!/^\d{6}$/.test(code)) continue;

    const obj = {
      Code: code,
      Name: iName >= 0 ? String(r[iName] ?? "").trim() : "",
      Market: iMarket >= 0 ? String(r[iMarket] ?? "").trim() : "",
      Date: iDate >= 0 ? String(r[iDate] ?? "").trim() : "",

      // âœ… ALLì— ì´ë¯¸ ìˆëŠ” ì‹ í˜¸
      Trend_Signal: iTrend >= 0 ? toBool(r[iTrend]) : false,
      Pullback_Signal: iPull >= 0 ? toBool(r[iPull]) : false,
      Breakout_Signal: iBreak >= 0 ? toBool(r[iBreak]) : false,

      Close: iClose >= 0 ? toNum(r[iClose]) : 0,
      Volume: iVol >= 0 ? toNum(r[iVol]) : 0,
      Turnover: iTurn >= 0 ? toNum(r[iTurn]) : 0,     // âœ… Turnover(ì›)
      RSI14: iRSI >= 0 ? toNum(r[iRSI]) : 0,
      Stoch_K: iStoch >= 0 ? toNum(r[iStoch]) : 0
    };
    out.push(obj);
  }
  return out;
}

function parseSignalSheetToSet(text){
  const rows = parseCSVRows(text).filter(r => r.some(x => String(x).trim() !== ""));
  if(rows.length < 2) return new Set();

  // ì²« ì»¬ëŸ¼ì´ Codeë¼ê³  ê°€ì •(í˜¹ì‹œ ì•„ë‹ˆì–´ë„ 0ë²ˆì„ Codeë¡œ ì²˜ë¦¬)
  const headers = rows[0].map(h => String(h).trim());
  const codeIdx = headers.findIndex(h => h === "Code");
  const iCode = codeIdx >= 0 ? codeIdx : 0;

  const set = new Set();
  for(const r of rows.slice(1)){
    const code = pad6(r[iCode]);
    if(/^\d{6}$/.test(code)) set.add(code);
  }
  return set;
}

/** =========================
 *  4) Fetch + Merge
 *  ========================= */
async function fetchText(url){
  const res = await fetch(bust(url), { cache:"no-store" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

async function fetchData(){
  if(!sheetUrls.ALL){
    openSettings(true);
    showError("ALL ì‹œíŠ¸ URLì„ ë¨¼ì € ì…ë ¥í•´ì¤˜.");
    return;
  }

  hideError();
  setStatus("warn","ë¡œë”©ì¤‘...");
  $("refreshBtn").disabled = true;
  $("refreshIcon").innerHTML = '<span class="spin"></span>';

  detailStock = null;
  selectedCodes = new Set();
  closeDetail();

  try{
    const [allText, trendText, pullText, breakText] = await Promise.all([
      fetchText(sheetUrls.ALL),
      sheetUrls.TREND ? fetchText(sheetUrls.TREND).catch(()=>null) : Promise.resolve(null),
      sheetUrls.PULLBACK ? fetchText(sheetUrls.PULLBACK).catch(()=>null) : Promise.resolve(null),
      sheetUrls.BREAKOUT ? fetchText(sheetUrls.BREAKOUT).catch(()=>null) : Promise.resolve(null)
    ]);

    const allData = parseAllSheet(allText);
    if(!allData.length) throw new Error("ALL ì‹œíŠ¸ íŒŒì‹± ì‹¤íŒ¨. í—¤ë”/ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì¤˜.");

    // âœ… ë³„ë„ ì‹œíŠ¸ê°€ ìˆìœ¼ë©´ (ì½”ë“œ set)ë¡œ ì˜¤ë²„ë¼ì´ë“œ/ë³´ê°•
    const trendSet = trendText ? parseSignalSheetToSet(trendText) : null;
    const pullSet  = pullText  ? parseSignalSheetToSet(pullText)  : null;
    const breakSet = breakText ? parseSignalSheetToSet(breakText) : null;

    data = allData.map(s => {
      if(trendSet) s.Trend_Signal = trendSet.has(s.Code) || s.Trend_Signal;
      if(pullSet)  s.Pullback_Signal = pullSet.has(s.Code) || s.Pullback_Signal;
      if(breakSet) s.Breakout_Signal = breakSet.has(s.Code) || s.Breakout_Signal;
      return s;
    });

    // ì •ë ¬: ëŒíŒŒ > ëˆŒë¦¼ > ì¶”ì„¸ > ê±°ë˜ëŒ€ê¸ˆ
    data.sort((a,b) => {
      if(b.Breakout_Signal !== a.Breakout_Signal) return b.Breakout_Signal ? 1 : -1;
      if(b.Pullback_Signal !== a.Pullback_Signal) return b.Pullback_Signal ? 1 : -1;
      if(b.Trend_Signal !== a.Trend_Signal) return b.Trend_Signal ? 1 : -1;
      return toNum(b.Turnover) - toNum(a.Turnover);
    });

    updateStats();
    renderTable();
    lastUpdatedPill.textContent = "ê°±ì‹ : " + new Date().toLocaleTimeString("ko-KR");
    setStatus("ok","ìµœì‹  ë°˜ì˜");
    openSettings(false);

  }catch(e){
    data = [];
    updateStats();
    renderEmpty("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + (e.message || String(e)));
    setStatus("err","ì‹¤íŒ¨");
    showError(e.message || String(e));
  }finally{
    $("refreshBtn").disabled = false;
    $("refreshIcon").textContent = "â†»";
  }
}

/** =========================
 *  5) Render
 *  ========================= */
function getFiltered(){
  if(filterType === "TREND") return data.filter(x => x.Trend_Signal);
  if(filterType === "PULLBACK") return data.filter(x => x.Pullback_Signal);
  if(filterType === "BREAKOUT") return data.filter(x => x.Breakout_Signal);
  return data;
}
function updateStats(){
  $("statTotal").textContent = fmt(data.length);
  $("statTrend").textContent = fmt(data.filter(x=>x.Trend_Signal).length);
  $("statPullback").textContent = fmt(data.filter(x=>x.Pullback_Signal).length);
  $("statBreakout").textContent = fmt(data.filter(x=>x.Breakout_Signal).length);
}
function renderEmpty(msg){
  tbody.innerHTML = `<tr><td colspan="8" class="center muted" style="padding:28px;">${escapeHtml(msg)}</td></tr>`;
  $("rowCount").textContent = "0";
}
function rsiColor(v){
  const x = Number(v)||0;
  if(x <= 30) return "#60a5fa";
  if(x >= 70) return "#fb7185";
  return "#94a3b8";
}
function stochColor(v){
  const x = Number(v)||0;
  if(x <= 20) return "#60a5fa";
  if(x >= 80) return "#fb7185";
  return "#94a3b8";
}

function renderTable(){
  const rows = getFiltered();
  $("filterLabel").textContent = filterType;
  $("rowCount").textContent = String(rows.length);

  if(!rows.length){
    renderEmpty("ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ì–´.");
    return;
  }

  const isWide = window.innerWidth >= 640;
  $("thClose").style.display = isWide ? "table-cell" : "none";
  $("thRSI").style.display = isWide ? "table-cell" : "none";
  $("thStoch").style.display = isWide ? "table-cell" : "none";

  tbody.innerHTML = rows.map((s) => {
    const isDetail = detailStock && detailStock.Code === s.Code;
    const isMulti = selectedCodes.has(s.Code);

    const turnoverEok = Math.round(toNum(s.Turnover) / 100000000);

    const sigs = [
      s.Breakout_Signal ? `<span class="sig red">ëŒíŒŒ</span>` : "",
      s.Pullback_Signal ? `<span class="sig yellow">ëˆŒë¦¼</span>` : "",
      s.Trend_Signal ? `<span class="sig green">ì¶”ì„¸</span>` : "",
    ].join("");

    return `
      <tr class="${isDetail ? "detailSelected" : ""}" data-code="${s.Code}">
        <td class="mono muted">${escapeHtml(s.Code)}</td>
        <td class="nameCell ${isDetail ? "name detailHi" : "name normal"}">${escapeHtml(s.Name || "")}</td>

        <td class="center">
          <span class="selectHit" data-action="select" data-code="${s.Code}">
            <span class="selectDot ${isMulti ? "on" : ""}"></span>
          </span>
        </td>

        <td class="numRight mono" style="display:${isWide ? "table-cell" : "none"}; color:#fb7185;">
          ${fmt(Math.round(toNum(s.Close)))}
        </td>

        <td class="numRight mono">${fmt(turnoverEok)}ì–µ</td>

        <td class="center mono" style="display:${isWide ? "table-cell" : "none"}; color:${rsiColor(s.RSI14)};">
          ${s.RSI14 ? Number(s.RSI14).toFixed(1) : "-"}
        </td>

        <td class="center mono" style="display:${isWide ? "table-cell" : "none"}; color:${stochColor(s.Stoch_K)};">
          ${s.Stoch_K ? Number(s.Stoch_K).toFixed(1) : "-"}
        </td>

        <td class="center"><div class="sigWrap">${sigs}</div></td>
      </tr>
    `;
  }).join("");
}

/** =========================
 *  6) Detail
 *  ========================= */
function openDetail(stock){
  detailStock = stock;

  $("detailMeta").textContent = `${stock.Market || "-"} | ${stock.Code}`;
  $("detailName").textContent = stock.Name || "-";
  $("detailClose").textContent = fmt(Math.round(toNum(stock.Close)));
  $("detailRSI").textContent = stock.RSI14 ? Number(stock.RSI14).toFixed(2) : "-";
  $("detailStoch").textContent = stock.Stoch_K ? Number(stock.Stoch_K).toFixed(2) : "-";
  $("detailVol").textContent = fmt(Math.round(toNum(stock.Volume)));

  const ul = $("detailSignals");
  ul.innerHTML = "";
  if(stock.Breakout_Signal) ul.innerHTML += `<li><b>ë°•ìŠ¤ê¶Œ ëŒíŒŒ:</b> ê±°ë˜ëŸ‰ + ëª¨ë©˜í…€ì„ ë™ë°˜í•œ ìƒë‹¨ ëŒíŒŒ ê°€ëŠ¥ì„±</li>`;
  if(stock.Pullback_Signal) ul.innerHTML += `<li><b>ëˆŒë¦¼ëª©:</b> ìƒìŠ¹ ì¶”ì„¸ ì¤‘ ì¡°ì • ì´í›„ ì¬ì‹œë™ ê°€ëŠ¥ì„±</li>`;
  if(stock.Trend_Signal) ul.innerHTML += `<li><b>ì¶”ì„¸ ì¶”ì¢…:</b> ìƒìŠ¹ ì¶”ì„¸ ì§€ì† + ê±°ë˜ëŸ‰ í™•ëŒ€ ê°€ëŠ¥ì„±</li>`;
  if(!ul.innerHTML) ul.innerHTML = `<li class="muted">ì‹ í˜¸ ì •ë³´ ì—†ìŒ</li>`;

  const eok = Math.round(toNum(stock.Turnover) / 100000000);
  $("detailFoot").innerHTML = `ê¸°ì¤€ì¼: ${escapeHtml(stock.Date || "-")}<br/>ê±°ë˜ëŒ€ê¸ˆ: ${fmt(eok)}ì–µì›`;

  rightPane.classList.add("open");

  const frame = document.getElementById("tvFrame");
  if(frame){
    frame.src =
      "https://www.tradingview.com/widgetembed/?" +
      "symbol=KRX:" + stock.Code +
      "&interval=D" +
      "&theme=dark" +
      "&hidesidetoolbar=1" +
      "&hidetoptoolbar=1";
  }
}

function closeDetail(){
  rightPane.classList.remove("open");
  detailStock = null;
}
function toggleDetailByCode(code){
  const stock = data.find(x => x.Code === code);
  if(!stock) return;
  if(detailStock && detailStock.Code === code) closeDetail();
  else openDetail(stock);
}

/** =========================
 *  7) Select
 *  ========================= */
function toggleSelect(code){
  if(selectedCodes.has(code)) selectedCodes.delete(code);
  else selectedCodes.add(code);
  renderTable();
}

/** =========================
 *  8) URL Settings
 *  ========================= */
function loadUrls(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return {...initialUrls};
    const obj = JSON.parse(raw);
    return { ...initialUrls, ...obj };
  }catch{
    return {...initialUrls};
  }
}
function saveUrls(){
  localStorage.setItem(LS_KEY, JSON.stringify(sheetUrls));
}
function openSettings(open){
  settingsPanel.classList.toggle("open", !!open);
}

/** =========================
 *  9) Bind
 *  ========================= */
function bind(){
  $("settingsBtn").addEventListener("click", () => openSettings(!settingsPanel.classList.contains("open")));
  $("settingsCloseBtn").addEventListener("click", () => openSettings(false));

  $("refreshBtn").addEventListener("click", fetchData);
  $("saveAndRefreshBtn").addEventListener("click", () => {
    sheetUrls = {
      ALL: $("urlALL").value.trim(),
      TREND: $("urlTREND").value.trim(),
      PULLBACK: $("urlPULLBACK").value.trim(),
      BREAKOUT: $("urlBREAKOUT").value.trim(),
    };
    saveUrls();
    fetchData();
  });

  document.querySelectorAll(".card[data-filter]").forEach(el => {
    el.addEventListener("click", () => {
      document.querySelectorAll(".card[data-filter]").forEach(c => c.classList.remove("active"));
      el.classList.add("active");
      filterType = el.dataset.filter;
      closeDetail();
      renderTable();
    });
  });

  tbody.addEventListener("click", (e) => {
    const t = e.target;

    const hit = t.closest("[data-action='select']");
    if(hit && hit.dataset && hit.dataset.code){
      e.stopPropagation();
      toggleSelect(hit.dataset.code);
      return;
    }

    const tr = t.closest("tr[data-code]");
    if(!tr) return;

    toggleDetailByCode(tr.dataset.code);
    renderTable();
  });

  $("detailCloseBtn").addEventListener("click", () => {
    closeDetail();
    renderTable();
  });

  window.addEventListener("resize", () => renderTable());

  $("urlALL").value = sheetUrls.ALL;
  $("urlTREND").value = sheetUrls.TREND;
  $("urlPULLBACK").value = sheetUrls.PULLBACK;
  $("urlBREAKOUT").value = sheetUrls.BREAKOUT;
}

bind();
fetchData();
</script>
</body>
</html>
