<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <script>
    if (!sessionStorage.getItem("auth")) {
      const input = prompt("비밀번호를 입력하세요");
      if (input !== "fire") {
        document.body.innerHTML = "<h2 style='color:white; text-align:center; margin-top:50px;'>접근 불가</h2>";
        throw new Error("Unauthorized");
      }
      sessionStorage.setItem("auth", "true");
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>YJ Quant Dashboard Pro</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111c33; --panel2:#0b1224;
      --line:#223053; --txt:#e5e7eb; --muted:#94a3b8;
      --blue:#3b82f6; --green:#22c55e; --yellow:#eab308; --red:#ef4444;
      --radius:16px;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
    
    /* Header */
    header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:var(--panel); border-bottom:1px solid var(--line); flex-shrink:0; }
    .toolbar{ display:flex; gap:8px; align-items:center; }
    .pill{ padding:4px 10px; border-radius:999px; font-size:11px; border:1px solid var(--line); font-weight:600; }
    .pill.ok{ color:#a7f3d0; background:rgba(34,197,94,.1); }
    .pill.error{ color:#fca5a5; background:rgba(239,68,68,.1); border-color:var(--red); }
    .btn{ background:var(--blue); color:white; border:none; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:bold; font-size:13px; }

    /* Layout */
    .container{ flex:1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding:16px; display:flex; flex-direction:column; gap:16px; }
    
    /* Top Analysis Section (Storage 기반) */
    .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; flex-shrink:0; }
    .analysis-box { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); padding: 14px; }
    .box-title { color: var(--muted); font-size: 11px; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap:5px; }

    /* Main Table Section */
    .panel{ border:1px solid var(--line); background:var(--panel); border-radius:var(--radius); display:flex; flex-direction:column; min-height: 400px; }
    .panel-header { padding: 14px; border-bottom: 1px solid var(--line); display:flex; justify-content: space-between; align-items: center; }
    .table-wrap { overflow-x: auto; overflow-y: hidden; }
    table{ width:100%; border-collapse:collapse; font-size:13px; min-width: 500px; }
    thead th{ background:var(--panel2); padding:12px; text-align:left; border-bottom:1px solid var(--line); color:var(--muted); font-size:11px; position: sticky; top:0; }
    tbody td{ padding:12px; border-bottom:1px solid rgba(34,48,83,.5); vertical-align: middle; }

    /* Mobile Typography */
    .num { font-family: 'Monaco', 'Courier New', monospace; font-weight: 600; }
    .numRight { text-align:right; }
    .profit-up { color: var(--green); }
    .profit-down { color: var(--red); }
    .sig{ font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; margin-right:3px; border:1px solid rgba(255,255,255,0.1); }
    
    /* Bottom Insight (누적 데이터 활용) */
    .insight-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 13px; }
    .stock-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: var(--line); border-radius: 10px; }
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <div style="width:28px; height:28px; background:linear-gradient(135deg, #3b82f6, #22c55e); border-radius:8px; display:grid; place-items:center; font-weight:bold; font-size:14px;">YJ</div>
    <h1 style="margin:0; font-size:16px; font-weight:800; letter-spacing:-0.5px;">퀀트 대시보드 Pro</h1>
  </div>
  <div class="toolbar">
    <span class="pill ok" id="status">연결완료</span>
    <button class="btn" onclick="fetchData()">↻</button>
  </div>
</header>

<div class="container">
  
  <div class="analysis-grid">
    <div class="analysis-box">
      <div class="box-title"><span style="color:var(--yellow)">●</span> 주도주 (10일 누적)</div>
      <div id="topFreqList" style="min-height:80px;">
        <div style="color:var(--muted); font-size:12px; text-align:center; padding-top:20px;">분석 중...</div>
      </div>
    </div>
    <div class="analysis-box">
      <div class="box-title"><span style="color:var(--blue)">●</span> 누적 성과 요약</div>
      <div id="marketStats" style="display:flex; flex-direction:column; justify-content:center; height:80%;">
        <div id="totalCapture" style="font-size:24px; font-weight:900; color:var(--txt);">0</div>
        <div style="font-size:12px; color:var(--muted);">Total Signals</div>
        <div id="avgProfit" style="font-size:13px; margin-top:8px; font-weight:bold;">평균 수익률 대기중</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div style="font-size:14px; font-weight:bold;">실시간 시그널 포착</div>
      <div id="lastUpdated" style="font-size:11px; color:var(--muted);">갱신: -</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>종목명</th>
            <th class="numRight">Close</th>
            <th class="numRight">현재가</th>
            <th class="numRight">수익률</th>
            <th class="numRight">시그널</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  // 파이썬 코드 결과와 일치하는 CSV URL
  const URL_ALL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=0&single=true&output=csv";
  const URL_STORAGE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSsPovUyvREyTUmaoACXouBLKs4RXyZgoco6l9xV08L2hIZeoZHJTdEv4drJeOJHnNoY2o2k3XsIf_y/pub?gid=2034892211&single=true&output=csv";

  async function fetchData() {
    const statusEl = document.getElementById('status');
    statusEl.textContent = "Updating...";
    
    try {
      // 1. 실시간 데이터와 누적 데이터를 동시에 가져옴
      const [resAll, resStorage] = await Promise.all([
        fetch(URL_ALL + "&t=" + Date.now()),
        fetch(URL_STORAGE + "&t=" + Date.now())
      ]);

      const textAll = await resAll.text();
      const textStorage = await resStorage.text();

      const dataAll = parseCSV(textAll);
      const dataStorage = parseCSV(textStorage);

      renderMainTable(dataAll);
      renderAnalysis(dataStorage);

      statusEl.textContent = "연결됨";
      document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    } catch (e) {
      console.error(e);
      statusEl.textContent = "연결오류";
      statusEl.className = "pill error";
    }
  }

  function parseCSV(text) {
    const rows = text.trim().split("\n");
    if (rows.length < 2) return [];
    
    // 쉼표가 들어간 금액 데이터를 처리하기 위한 정규식 기반 파싱
    const headers = rows[0].split(",").map(h => h.trim().replace(/"/g, ''));
    return rows.slice(1).map(row => {
      const values = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(v => v.replace(/"/g, '').trim());
      return headers.reduce((obj, h, i) => {
        obj[h] = values[i] || "";
        return obj;
      }, {});
    });
  }

  function renderAnalysis(storage) {
    if(!storage.length) return;

    // 1. 최다 포착 주도주 계산 (최근 14일)
    const fourteenDaysAgo = new Date();
    fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
    
    const recentData = storage.filter(r => new Date(r.Date) >= fourteenDaysAgo);
    const counts = {};
    recentData.forEach(r => { if(r.Name) counts[r.Name] = (counts[r.Name] || 0) + 1; });
    
    const sortedFreq = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 4);
    document.getElementById('topFreqList').innerHTML = sortedFreq.map(([name, count]) => `
      <div class="insight-row">
        <span class="stock-name" style="font-weight:bold;">${name}</span>
        <span style="color:var(--blue); font-weight:800;">${count}회</span>
      </div>
    `).join('') || "최근 데이터 없음";

    // 2. 전체 통계
    document.getElementById('totalCapture').textContent = storage.length.toLocaleString();
    
    // 3. 평균 수익률 (Ratio 기준)
    const avgRatio = storage.reduce((acc, curr) => acc + (parseFloat(curr.Ratio) || 0), 0) / storage.length;
    const avgEl = document.getElementById('avgProfit');
    const avgVal = (avgRatio * 100).toFixed(2);
    avgEl.textContent = `누적 평균: ${avgVal}%`;
    avgEl.className = avgVal >= 0 ? "profit-up" : "profit-down";
  }

  function renderMainTable(data) {
    const tbody = document.getElementById('tbody');
    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--muted);">장중 시그널 대기 중...</td></tr>';
      return;
    }

    tbody.innerHTML = data.map(r => {
      const close = parseFloat(r["Close"]) || 0;
      const current = parseFloat(r["현재가"]) || 0; // 혹은 파이썬이 실시간 동기화해주는 값
      
      // 파이썬에서 Ratio를 계산해서 주지만, 프론트에서도 한번 더 검증 계산
      const profit = close > 0 ? ((current - close) / close * 100).toFixed(2) : "0.00";
      const pClass = profit > 0 ? "profit-up" : (profit < 0 ? "profit-down" : "");

      return `
        <tr>
          <td>
            <div style="font-weight:bold; letter-spacing:-0.3px;">${r.Name}</div>
            <div style="font-size:10px; color:var(--muted);">${r.Code}</div>
          </td>
          <td class="num numRight">${close.toLocaleString()}</td>
          <td class="num numRight" style="color:var(--txt)">${current.toLocaleString()}</td>
          <td class="num numRight ${pClass}" style="font-weight:bold;">
            ${profit > 0 ? '▲' : (profit < 0 ? '▼' : '')} ${Math.abs(profit)}%
          </td>
          <td class="numRight" style="white-space:nowrap;">
            ${r.Trend === 'True' ? '<span class="sig" style="color:var(--green); border-color:var(--green);">추세</span>' : ''}
            ${r.Pullback === 'True' ? '<span class="sig" style="color:var(--yellow); border-color:var(--yellow);">눌림</span>' : ''}
            ${r.Breakout === 'True' ? '<span class="sig" style="color:var(--red); border-color:var(--red);">돌파</span>' : ''}
          </td>
        </tr>
      `;
    }).join('');
  }

  fetchData();
  // 5분마다 자동 갱신
  setInterval(fetchData, 300000);
</script>
</body>
</html>
